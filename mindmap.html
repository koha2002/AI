<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Mindmap Pro</title>
  <link rel="icon" href="logo.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {font-family: 'Montserrat', Arial, sans-serif;background:#0a1931;color:#222;margin:0;}
    #header, #footer {background: #192945; color:#aee4ff;padding:9px 20px;}
    #toolbar {display:flex;gap:12px;padding:8px;background:#133360;}
    #tabs {display:flex;gap:5px;}
    .tab {background:#2761ad;color:#fff;padding:7px 14px 7px 10px;border-radius:12px 12px 0 0;margin-right:4px;cursor:pointer;position:relative;}
    .tab.selected {background:#fff;color:#2761ad;border:2px solid #185adb;border-bottom:0;}
    .tab .close {position:absolute;right:4px;top:2px;color:#e22;font-size:15px;font-weight:bold;cursor:pointer;}
    #canvasWrap {background:#f5f7fa;width:95vw;height:78vh;overflow:auto;position:relative;margin:0 auto 20px auto;border-radius:22px;box-shadow:0 5px 20px #123;}
    #nodeLayer {position:absolute;left:0;top:0;width:3000px;height:1800px;}
    .node {position:absolute;min-width:60px;min-height:32px;padding:10px 15px;background:#fff;border:2px solid #bcd;box-shadow:0 2px 12px #0002;border-radius:15px;z-index:10;cursor:pointer;user-select:text;transition:box-shadow .13s;}
    .node.selected {border:2.5px solid #185adb;box-shadow:0 5px 20px #185adb2e;}
    .node .plus {position:absolute;width:18px;height:18px;background:#277fd7;color:#fff;border-radius:50%;right:-12px;top:50%;margin-top:-9px;text-align:center;line-height:18px;font-weight:bold;font-size:15px;cursor:pointer;box-shadow:0 1px 5px #185adb44;}
    .node .plus:hover {background:#47aaff;}
    .conn {position:absolute;pointer-events:none;}
    .multi-selected {background:#1dc9b3cc!important;border:2.2px solid #26b7a7;}
    #selectBox {border:2px dashed #2196f3;background:rgba(33,150,243,0.09);position:absolute;display:none;z-index:20;}
    #menu {position:fixed;right:24px;top:70px;background:#fff;border:1.7px solid #185adb;border-radius:11px;box-shadow:0 2px 20px #0a1a34cc;padding:10px 24px;}
    #menu button {margin:6px;}
    #saveMsg {color:green;font-weight:600;}
    .node .shape-rect {border-radius:13px;}
    .node .shape-round {border-radius:30px;}
    .node .shape-diamond {transform:rotate(45deg);}
    .node .shape-diamond .txt {transform:rotate(-45deg);}
    .node .shape-note {border-radius: 6px 32px 6px 14px; border-style: dashed;background: linear-gradient(107deg,#fff7 70%,#fbeecb 100%);}
    .node .shape-cloud {border-radius: 40% 55% 44% 54% / 48% 44% 56% 52%;box-shadow: 0 4px 22px #b8e4ff24;}
    .node .shape-star {clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);}
    .node.blue {background:#c9e7ff;}
    .node.green {background:#defde0;}
    .node.yellow {background:#fff7c6;}
    .node.pink {background:#ffd4e5;}
    .node.orange {background:#ffe5c2;}
    .node.purple {background:#efe0ff;}
    .node.gray {background:#e7ebef;}
    .node.red {background:#ffdad6;}
    .node.cyan {background:#ccf8f4;}
    .node.lime {background:#e6ffd8;}
    #colorBtns span {width:20px;height:20px;display:inline-block;border-radius:50%;margin-right:5px;cursor:pointer;border:2px solid #fff;}
    #colorBtns .sel {border:2.5px solid #185adb;}
    #shapeSel {padding:5px 13px;border-radius:8px;margin:0 7px;}
    #saveMsg {margin-left:24px;}
    #tabAdd {margin-left:13px;}
    #zoomInd {position:fixed;bottom:18px;left:15px;background:#1d2e62;color:#fff;border-radius:8px;padding:6px 16px;font-size:1.1rem;z-index:100;}
    #undoBtn,#redoBtn {background:#f4f7ff;border-radius:7px;border:1.3px solid #bed5f6;padding:5px 13px;font-weight:700;margin-right:6px;cursor:pointer;}
    #importPDF {margin-left:11px;}
  </style>
</head>
<body>
<div id="header"></div>
<div id="toolbar">
  <button onclick="addTab()" id="tabAdd">+ S∆° ƒë·ªì m·ªõi</button>
  <div id="tabs"></div>
  <button onclick="addNode()">+ Node</button>
  <span id="colorBtns"></span>
  <select id="shapeSel">
    <option value="rect">Ch·ªØ nh·∫≠t</option>
    <option value="round">Bo tr√≤n</option>
    <option value="diamond">Thoi</option>
    <option value="note">Note</option>
    <option value="cloud">M√¢y</option>
    <option value="star">Sao</option>
  </select>
  <button onclick="copyNode()">Copy</button>
  <button onclick="pasteNode()">Paste</button>
  <button onclick="startSelectBox()">Khoanh v√πng x√≥a</button>
  <button id="undoBtn" onclick="undo()">‚éå Undo</button>
  <button id="redoBtn" onclick="redo()">‚ü≥ Redo</button>
  <button onclick="saveTabs()">üíæ L∆∞u</button>
  <button onclick="showExportMenu()">PDF</button>
  <input type="file" id="importPDF" accept=".pdf" style="display:none">
  <button onclick="document.getElementById('importPDF').click()">Import PDF</button>
</div>
<div id="canvasWrap">
  <svg id="connLayer" width="3000" height="1800" style="position:absolute;left:0;top:0;z-index:1;"></svg>
  <div id="nodeLayer"></div>
  <div id="selectBox"></div>
</div>
<div id="footer"></div>
<div id="menu" style="display:none;">
  <b>Xu·∫•t PDF</b><br>
  <button onclick="doExportPDF(true)">Ch·ªâ v√πng ch·ªçn</button>
  <button onclick="doExportPDF(false)">To√†n s∆° ƒë·ªì</button>
  <button onclick="closeExportMenu()">Hu·ª∑</button>
</div>
<div id="zoomInd" style="display:none;">100%</div>
<script>
// ===== HEADER/FOOTER =====
fetch('mini-header.html').then(r=>r.text()).then(html=>document.getElementById('header').innerHTML=html);
fetch('footer.html').then(r=>r.text()).then(html=>document.getElementById('footer').innerHTML=html);

let TABS_KEY = "mindmap_tabs_v4";
let tabs = loadTabs();
let currentTab = 0;
let clipboardNode = null;
let connFrom = null;
let selectBoxMode = false, selecting = false, selectStart={};
let selectedNodes = new Set();
let zoom = 1;
// Undo/Redo stack cho m·ªói tab
let undoStack = [[]], redoStack = [[]];

const COLORS = ['blue','green','yellow','pink','orange','purple','gray','red','cyan','lime'];

function renderTabs() {
  let html = '';
  tabs.forEach((tab, i) => {
    html += `<div class="tab${i===currentTab?' selected':''}" onclick="switchTab(${i})">${tab.name} <span class="close" onclick="event.stopPropagation();closeTab(${i});">&times;</span></div>`;
  });
  document.getElementById('tabs').innerHTML = html;
}
function addTab() {
  let name = prompt("T√™n s∆° ƒë·ªì?");
  if (!name) return;
  tabs.push({name, nodes:[], lines:[]});
  currentTab = tabs.length-1;
  saveTabs();
  resetHistory();
  renderTabs();
  renderMindmap();
}
function closeTab(idx) {
  if(!confirm("X√°c nh·∫≠n xo√° s∆° ƒë·ªì n√†y?")) return;
  tabs.splice(idx,1);
  currentTab = Math.max(0, currentTab-1);
  saveTabs(); resetHistory(); renderTabs(); renderMindmap();
}
function switchTab(idx) {
  currentTab = idx;
  resetHistory();
  renderTabs();
  renderMindmap();
}
function addNode(txt) {
  let tab = tabs[currentTab];
  let id = Date.now() + Math.floor(Math.random()*10000);
  let color = document.querySelector('#colorBtns .sel')?.dataset.c || 'blue';
  let shape = document.getElementById('shapeSel').value;
  tab.nodes.push({id,x:200+Math.random()*300,y:160+Math.random()*200,text:txt||"√ù m·ªõi",shape,color,w:110,h:36,});
  saveTabs(); pushHistory(); renderMindmap();
}
function copyNode() {
  let tab = tabs[currentTab];
  let n = tab.nodes.find(n=>n.selected);
  if(n) clipboardNode = {...n};
}
function pasteNode() {
  let tab = tabs[currentTab];
  if(clipboardNode){
    let nn = {...clipboardNode, id:Date.now()+Math.floor(Math.random()*10000), x:clipboardNode.x+40, y:clipboardNode.y+40};
    tab.nodes.push(nn);
    saveTabs(); pushHistory(); renderMindmap();
  }
}
function renderColorBtns(){
  let html = COLORS.map(c=>`<span style="background:${getColorVal(c)};" data-c="${c}" ${c==='blue'?'class="sel"':''}></span>`).join('');
  document.getElementById('colorBtns').innerHTML = html;
  document.querySelectorAll('#colorBtns span').forEach(btn=>{
    btn.onclick = ()=>{document.querySelectorAll('#colorBtns span').forEach(x=>x.classList.remove('sel'));btn.classList.add('sel');};
  });
}
function getColorVal(c){
  return {
    blue:'#c9e7ff',green:'#defde0',yellow:'#fff7c6',pink:'#ffd4e5',
    orange:'#ffe5c2',purple:'#efe0ff',gray:'#e7ebef',red:'#ffdad6',
    cyan:'#ccf8f4',lime:'#e6ffd8'
  }[c]||'#fff';
}
function renderMindmap() {
  let tab = tabs[currentTab];
  let nLayer = document.getElementById("nodeLayer");
  let cLayer = document.getElementById("connLayer");
  nLayer.innerHTML = '';
  cLayer.innerHTML = '';
  // Render connections
  tab.lines.forEach(line=>{
    let from = tab.nodes.find(n=>n.id===line[0]), to = tab.nodes.find(n=>n.id===line[1]);
    if(!from||!to) return;
    let fx=from.x+from.w/2, fy=from.y+from.h/2, tx=to.x+to.w/2, ty=to.y+to.h/2;
    let path = `<line x1="${fx}" y1="${fy}" x2="${tx}" y2="${ty}" stroke="#185adb" stroke-width="2.8" opacity="0.85" />`;
    cLayer.innerHTML += path;
  });
  // Render nodes
  tab.nodes.forEach(n=>{
    let nd = document.createElement("div");
    nd.className = `node ${n.color||'blue'} shape-${n.shape||'rect'}` + (n.selected?" selected":"");
    nd.style.left = n.x+"px"; nd.style.top = n.y+"px"; nd.style.width=n.w+"px"; nd.style.height=n.h+"px";
    nd.innerHTML = `<div class="txt" contenteditable="true" style="width:100%;height:100%;outline:none;text-align:center;">${n.text||''}</div>
      <div class="plus" title="K·∫øt n·ªëi node">+</div>`;
    // Drag
    let drag = false, dragOff={};
    nd.onmousedown = e=>{
      if(e.target.classList.contains("plus")||e.target.classList.contains("txt")) return;
      drag = true;
      dragOff = {x:e.offsetX, y:e.offsetY};
      n.selected = true;
      renderMindmap();
      document.body.style.userSelect="none";
    };
    document.addEventListener("mousemove",function(e){
      if(!drag) return;
      let wrapRect = document.getElementById("canvasWrap").getBoundingClientRect();
      n.x = (e.clientX - wrapRect.left - dragOff.x)/zoom;
      n.y = (e.clientY - wrapRect.top - dragOff.y)/zoom;
      nd.style.left = n.x+"px"; nd.style.top = n.y+"px";
      renderMindmap();
    });
    document.addEventListener("mouseup",()=>{if(drag){drag=false;pushHistory();document.body.style.userSelect="";}});
    // Resize node
    nd.onwheel = e=>{
      if(e.ctrlKey) return;
      if(e.deltaY<0) { n.w+=12;n.h+=4; }
      else { n.w=Math.max(60,n.w-12);n.h=Math.max(32,n.h-4);}
      renderMindmap();
    }
    // Edit text
    nd.querySelector('.txt').oninput = (e)=>{
      n.text = nd.querySelector('.txt').innerText;
      saveTabsDebounced();pushHistory();
    };
    nd.querySelector('.txt').onkeydown = function(e){
      if(e.key==="Enter"){e.preventDefault();nd.querySelector('.txt').blur();}
    }
    // Select node
    nd.onclick = function(e){
      if(!e.ctrlKey && !e.metaKey){
        tab.nodes.forEach(nn=>delete nn.selected);
        n.selected = true;
      } else {
        n.selected = !n.selected;
      }
      renderMindmap();
      e.stopPropagation();
    }
    // K·∫øt n·ªëi node (+)
    nd.querySelector('.plus').onclick = function(e){
      connFrom = n.id;
      document.body.style.cursor="crosshair";
      document.getElementById("canvasWrap").onclick = function(ev){
        let nodeEls = Array.from(document.querySelectorAll('.node'));
        let found = nodeEls.find(el=>el.contains(ev.target));
        if(found){
          let nid = tab.nodes[nodeEls.indexOf(found)].id;
          if(nid!==connFrom) {
            tab.lines.push([connFrom,nid]);
            saveTabs(); pushHistory(); renderMindmap();
          }
        }
        connFrom = null; document.body.style.cursor=""; document.getElementById("canvasWrap").onclick=null;
      }
      e.stopPropagation();
    }
    // Double click ƒë·ªÉ s·ª≠a shape/m√†u
    nd.ondblclick = function(){
      let shape = prompt("Shape: rect,round,diamond,note,cloud,star",n.shape);
      if(shape) {n.shape=shape;}
      let color = prompt("M√†u: "+COLORS.join(','),n.color);
      if(color) {n.color=color;}
      renderMindmap(); saveTabsDebounced();pushHistory();
    }
    // Copy/Paste b·∫±ng Ctrl+C/Ctrl+V
    nd.oncopy = (e)=>{clipboardNode={...n};}
    nd.onpaste = (e)=>{pasteNode();e.preventDefault();}
    nLayer.appendChild(nd);
  });
  document.getElementById("canvasWrap").onclick = function(){
    tab.nodes.forEach(nn=>delete nn.selected);
    renderMindmap();
  }
}
function getSelectedNodes(tab) { return tab.nodes.filter(n=>n.selected); }

function startSelectBox(){
  selectBoxMode = true;
  let selectBox = document.getElementById("selectBox");
  selectBox.style.display = "block";
  let nodeLayer = document.getElementById("nodeLayer");
  nodeLayer.onmousedown = function(e){
    selecting = true;
    let sx = e.offsetX, sy = e.offsetY;
    selectBox.style.left = sx+"px"; selectBox.style.top = sy+"px"; selectBox.style.width="0px"; selectBox.style.height="0px";
    nodeLayer.onmousemove = function(ev){
      let ex = ev.offsetX, ey = ev.offsetY;
      let lx=Math.min(sx,ex), ty=Math.min(sy,ey), w=Math.abs(sx-ex), h=Math.abs(sy-ey);
      selectBox.style.left=lx+"px";selectBox.style.top=ty+"px";selectBox.style.width=w+"px";selectBox.style.height=h+"px";
      let tab = tabs[currentTab];
      tab.nodes.forEach(n=>{
        let inside = n.x>lx-15&&n.x<n.x+n.w&&n.x+n.w<lx+w+35&&n.y>ty-10&&n.y+n.h<ty+h+25;
        n.selected = inside;
      });
      renderMindmap();
    }
    nodeLayer.onmouseup = function(){
      nodeLayer.onmousemove=null;
      selecting=false;
      setTimeout(()=>{ // X√°c nh·∫≠n x√≥a
        if(confirm("Xo√° t·∫•t c·∫£ c√°c node ƒëang ch·ªçn?")){
          let tab = tabs[currentTab];
          let ids = tab.nodes.filter(n=>n.selected).map(n=>n.id);
          tab.nodes = tab.nodes.filter(n=>!n.selected);
          tab.lines = tab.lines.filter(l=>!ids.includes(l[0])&&!ids.includes(l[1]));
          saveTabs(); pushHistory(); renderMindmap();
        }
        selectBox.style.display="none";selectBoxMode=false;
      },180);
    }
  }
}
function showExportMenu(){ document.getElementById('menu').style.display='block'; }
function closeExportMenu(){ document.getElementById('menu').style.display='none'; }
function doExportPDF(selectedOnly){
  closeExportMenu();
  setTimeout(()=>{
    if(!confirm("B·∫°n mu·ªën xu·∫•t PDF ngay b√¢y gi·ªù? H√£y ki·ªÉm tra l·∫°i s∆° ƒë·ªì!")) return;
    let wrap = document.getElementById("canvasWrap");
    let rect = wrap.getBoundingClientRect();
    let config = {backgroundColor:'#fff', scale:2, useCORS:true};
    if(selectedOnly){
      let tab = tabs[currentTab];
      let minX=99999,minY=99999,maxX=-1,maxY=-1;
      tab.nodes.filter(n=>n.selected).forEach(n=>{
        minX=Math.min(minX,n.x);minY=Math.min(minY,n.y);
        maxX=Math.max(maxX,n.x+n.w);maxY=Math.max(maxY,n.y+n.h);
      });
      if(maxX<0) return alert("Kh√¥ng c√≥ node n√†o ƒë∆∞·ª£c ch·ªçn!");
      config.x = minX; config.y = minY;
      config.width = maxX-minX+50; config.height = maxY-minY+40;
    }
    html2canvas(wrap, config).then(canvas=>{
      let pdf = new window.jspdf.jsPDF({
        orientation:canvas.width>canvas.height?'landscape':'portrait',
        unit:'pt',format:[canvas.width,canvas.height]
      });
      pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,canvas.width,canvas.height);
      pdf.save('mindmap.pdf');
    });
  },120);
}

function saveTabs(){
  localStorage.setItem(TABS_KEY,JSON.stringify(tabs));
}
function saveTabsDebounced(){
  clearTimeout(window.__saveDebounced);
  window.__saveDebounced = setTimeout(saveTabs,500);
}
function loadTabs(){
  let d = localStorage.getItem(TABS_KEY);
  if(d) return JSON.parse(d);
  return [{name:"S∆° ƒë·ªì 1", nodes:[], lines:[]}];
}

// Undo/Redo
function pushHistory(){
  if(!undoStack[currentTab])undoStack[currentTab]=[];
  undoStack[currentTab].push(JSON.stringify(tabs[currentTab]));
  redoStack[currentTab]=[]; // clear redo khi thay ƒë·ªïi
}
function undo(){
  if(undoStack[currentTab]&&undoStack[currentTab].length>1){
    redoStack[currentTab].push(undoStack[currentTab].pop());
    tabs[currentTab]=JSON.parse(undoStack[currentTab][undoStack[currentTab].length-1]);
    saveTabs(); renderMindmap();
  }
}
function redo(){
  if(redoStack[currentTab]&&redoStack[currentTab].length){
    let st = redoStack[currentTab].pop();
    undoStack[currentTab].push(st);
    tabs[currentTab]=JSON.parse(st);
    saveTabs(); renderMindmap();
  }
}
function resetHistory(){
  undoStack[currentTab]=[JSON.stringify(tabs[currentTab])];
  redoStack[currentTab]=[];
}

// ZOOM
function showZoom(){document.getElementById('zoomInd').style.display="block";}
function hideZoom(){document.getElementById('zoomInd').style.display="none";}
document.getElementById('canvasWrap').addEventListener('wheel',function(e){
  if (e.ctrlKey || !e.altKey) {
    e.preventDefault();
    zoom += e.deltaY > 0 ? -0.1 : 0.1;
    zoom = Math.max(0.3, Math.min(zoom, 3.2));
    document.getElementById('nodeLayer').style.transform = "scale("+zoom+")";
    document.getElementById('connLayer').style.transform = "scale("+zoom+")";
    document.getElementById('zoomInd').innerText = Math.round(zoom*100)+"%";
    showZoom();
    clearTimeout(window.zoomTimeout);
    window.zoomTimeout = setTimeout(hideZoom,1200);
  }
},{passive:false});

// PAN b·∫±ng chu·ªôt gi·ªØa
let panActive=false, panStart={x:0,y:0}, scrollStart={x:0,y:0};
document.getElementById('canvasWrap').addEventListener('mousedown',function(e){
  if(e.button===1){
    panActive=true;
    panStart={x:e.clientX,y:e.clientY};
    scrollStart={x:this.scrollLeft,y:this.scrollTop};
    this.style.cursor="grab";
    e.preventDefault();
  }
});
document.addEventListener('mousemove',function(e){
  if(panActive){
    let wrap=document.getElementById('canvasWrap');
    wrap.scrollLeft=scrollStart.x-(panStart.x-e.clientX);
    wrap.scrollTop=scrollStart.y-(panStart.y-e.clientY);
  }
});
document.addEventListener('mouseup',function(){panActive=false;document.getElementById('canvasWrap').style.cursor="";});

// Copy/paste to√†n canvas Ctrl+C/V, Delete node ch·ªçn
document.addEventListener('keydown',function(e){
  if(e.ctrlKey&&e.key==='c'){copyNode();}
  if(e.ctrlKey&&e.key==='v'){pasteNode();}
  if((e.key==="Delete"||e.key==="Backspace")) {
    let tab = tabs[currentTab];
    let sel = tab.nodes.filter(n=>n.selected);
    if(sel.length){
      if(confirm('X√≥a c√°c node ƒëang ch·ªçn?')){
        let ids = sel.map(n=>n.id);
        tab.nodes = tab.nodes.filter(n=>!ids.includes(n.id));
        tab.lines = tab.lines.filter(l=>!ids.includes(l[0])&&!ids.includes(l[1]));
        saveTabs(); pushHistory(); renderMindmap();
      }
    }
  }
});

// ===== IMPORT PDF =====
document.getElementById('importPDF').addEventListener('change', function(e){
  let file = e.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(){
    pdfjsLib.getDocument({data:new Uint8Array(reader.result)}).promise.then(pdf=>{
      let allText = "";
      let getPage = function(pn){
        if(pn>pdf.numPages) {
          if(!allText.trim()) return alert("Kh√¥ng c√≥ text trong file PDF!");
          let lines = allText.split('\n').map(s=>s.trim()).filter(s=>!!s);
          lines.forEach(txt=>addNode(txt));
          pushHistory();renderMindmap();
          return;
        }
        pdf.getPage(pn).then(page=>{
          page.getTextContent().then(tc=>{
            allText+=tc.items.map(i=>i.str).join(' ')+'\n';
            getPage(pn+1);
          });
        });
      }
      getPage(1);
    });
  };
  reader.readAsArrayBuffer(file);
});

renderTabs();
renderColorBtns();
renderMindmap();
resetHistory();

</script>
</body>
</html>
