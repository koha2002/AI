<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Mindmap Web Full Chức Năng (Chuẩn)</title>
<style>
body { margin:0; font-family:sans-serif; background:#e9ecef; }
#toolbar {
  background:#343a40; color:#fff; padding:8px;
  display:flex; align-items:center; gap:8px;
}
#toolbar button, #toolbar input[type="file"] {
  background:#495057; color:#fff; border:none; border-radius:4px; padding:6px 14px; font-size:15px; cursor:pointer;
}
#toolbar button:hover { background:#212529; }
#toolbar label { font-size:14px; }
#canvasWrap {
  width:100vw; height:90vh; overflow:hidden;
  background:#fff; border-top:1px solid #bbb;
  position:relative;
}
#mmCanvas { width:100%; height:100%; display:block; background: #f8f9fa;}
</style>
</head>
<body>
<div id="toolbar">
  <button onclick="addNode()">➕ Thêm node</button>
  <button onclick="editNode()">✏️ Sửa node</button>
  <button onclick="removeNode()">❌ Xóa node</button>
  <button onclick="addImage()">🖼️ Thêm ảnh</button>
  <button onclick="zoomIn()">🔍 +</button>
  <button onclick="zoomOut()">🔍 -</button>
  <button onclick="setPanMode()">✋ Pan</button>
  <button onclick="undo()">↩️ Undo</button>
  <button onclick="redo()">↪️ Redo</button>
  <button onclick="saveFile()">💾 Xuất file</button>
  <input type="file" id="fileInput" accept=".json" onchange="openFile(event)">
  <button onclick="exportPng()">🖨️ Xuất PNG</button>
  <span style="margin-left:18px;font-size:14px;color:#ffd700;">Tip: Chọn node, nhấn Enter để sửa, Backspace để xóa, Ctrl+Z/Y để undo/redo, Space+Kéo chuột để Pan!</span>
</div>
<div id="canvasWrap">
  <canvas id="mmCanvas"></canvas>
</div>
<script>
let nodes = [
  { id: 1, text: "Ý TƯỞNG CHÍNH", x: 500, y: 350, parent: null, img: null }
];
let selected = nodes[0];
let pan = {x:0, y:0};
let zoom = 1;
let mode = 'select';
let dragNode = null, dragOffset = {x:0, y:0};
let isPanning = false, panStart = {x:0, y:0};
let undoStack = [], redoStack = [];
let canvas = document.getElementById('mmCanvas');
let ctx = canvas.getContext('2d');

function saveState() {
  undoStack.push(JSON.stringify({nodes,selectedId:selected?selected.id:null,pan,zoom}));
  if (undoStack.length > 50) undoStack.shift();
  redoStack = [];
}
function restore(stateStr) {
  let st = JSON.parse(stateStr);
  nodes = JSON.parse(JSON.stringify(st.nodes));
  pan = {...st.pan};
  zoom = st.zoom;
  selected = st.selectedId ? nodes.find(n=>n.id===st.selectedId) : null;
  redraw();
}
function resizeCanvas() {
  canvas.width = document.getElementById('canvasWrap').clientWidth;
  canvas.height = document.getElementById('canvasWrap').clientHeight;
}
function drawLink(from, to) {
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(from.x, from.y);
  let mx = (from.x + to.x)/2;
  ctx.bezierCurveTo(mx, from.y, mx, to.y, to.x, to.y);
  ctx.strokeStyle = "#888";
  ctx.lineWidth = 3;
  ctx.stroke();
  ctx.restore();
}
function drawNode(node) {
  let {x,y,text,img} = node;
  ctx.save();
  ctx.beginPath();
  ctx.arc(x, y, 50, 0, 2 * Math.PI);
  ctx.fillStyle = (node === selected) ? "#ffe066" : "#f1f3f5";
  ctx.strokeStyle = (node === selected) ? "#e67700" : "#343a40";
  ctx.lineWidth = (node === selected) ? 5 : 2;
  ctx.fill();
  ctx.stroke();
  // Draw text
  ctx.fillStyle = "#222";
  ctx.font = "18px sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  let offsetY = img ? -18 : 0;
  ctx.fillText(text, x, y + offsetY);
  // Draw image if any
  if (img) {
    let imageObj = new window.Image();
    imageObj.onload = () => {
      ctx.save();
      ctx.beginPath();
      ctx.arc(x, y+22, 16, 0, 2*Math.PI);
      ctx.closePath();
      ctx.clip();
      ctx.drawImage(imageObj, x-16, y+6, 32, 32);
      ctx.restore();
    };
    imageObj.src = img;
    // For instant preview if cached:
    if(imageObj.complete) imageObj.onload();
  }
  ctx.restore();
}
function redraw() {
  resizeCanvas();
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.setTransform(zoom,0,0,zoom,pan.x,pan.y);
  // Draw links
  nodes.forEach(n=>{
    if(n.parent!==null){
      let p = nodes.find(nd=>nd.id===n.parent);
      if(p) drawLink(p, n);
    }
  });
  // Draw nodes
  nodes.forEach(drawNode);
}
/* --- Mouse Events --- */
canvas.onmousedown = function(e){
  let pos = getMousePos(e);
  let found = null;
  for(let i=nodes.length-1;i>=0;i--){
    let n = nodes[i];
    let dx = pos.x - n.x, dy = pos.y - n.y;
    if(dx*dx + dy*dy < 2500) { found = n; break;}
  }
  if (mode==='select' && found) {
    dragNode = found;
    dragOffset.x = pos.x - found.x;
    dragOffset.y = pos.y - found.y;
    selected = found;
    redraw();
  } else if(mode==='pan' || (e.button===1 || (e.button===0 && e.shiftKey)) || (mode==='select' && !found)) {
    isPanning = true;
    panStart = {x: e.clientX-pan.x, y: e.clientY-pan.y};
  }
};
canvas.onmousemove = function(e){
  if (dragNode) {
    let pos = getMousePos(e);
    dragNode.x = pos.x - dragOffset.x;
    dragNode.y = pos.y - dragOffset.y;
    redraw();
  }
  if (isPanning) {
    pan.x = e.clientX - panStart.x;
    pan.y = e.clientY - panStart.y;
    redraw();
  }
};
canvas.onmouseup = function(e){
  if (dragNode) { saveState(); }
  dragNode = null;
  isPanning = false;
};
canvas.onmouseleave = function(){ dragNode = null; isPanning = false; };
canvas.onclick = function(e){
  let pos = getMousePos(e);
  let found = null;
  for(let i=nodes.length-1;i>=0;i--){
    let n = nodes[i];
    let dx = pos.x - n.x, dy = pos.y - n.y;
    if(dx*dx + dy*dy < 2500) { found = n; break;}
  }
  selected = found;
  redraw();
};
/* --- Zoom by Wheel --- */
canvas.onwheel = function(e){
  if (e.ctrlKey) {
    e.preventDefault();
    let mx = (e.offsetX - pan.x)/zoom;
    let my = (e.offsetY - pan.y)/zoom;
    if(e.deltaY<0) zoom *= 1.1; else zoom /= 1.1;
    pan.x = e.offsetX - mx*zoom;
    pan.y = e.offsetY - my*zoom;
    redraw();
  }
};
/* --- Keyboard Shortcuts --- */
document.addEventListener('keydown', function(e){
  if(document.activeElement.tagName==="INPUT") return;
  if(e.key==='Enter') editNode();
  if((e.key==='Delete' || e.key==='Backspace') && selected && selected.parent!==null) removeNode();
  if(e.ctrlKey && e.key==='z') undo();
  if(e.ctrlKey && (e.key==='y'||e.key==='Z')) redo();
  if(e.key===' ') { mode='pan'; }
});
document.addEventListener('keyup', function(e){
  if(e.key===' ') { mode='select'; }
});
/* --- Core Node Functions --- */
function getMousePos(e){
  let rect = canvas.getBoundingClientRect();
  let x = (e.clientX - rect.left - pan.x)/zoom;
  let y = (e.clientY - rect.top - pan.y)/zoom;
  return {x,y};
}
function addNode() {
  if(!selected) { alert("Chọn một node cha!"); return;}
  let txt = prompt('Nhập nội dung node mới:');
  if(txt) {
    let id = Date.now()+Math.random();
    let angle = Math.random()*2*Math.PI;
    let newX = selected.x + Math.cos(angle)*180;
    let newY = selected.y + Math.sin(angle)*120;
    nodes.push({id,text:txt,x:newX,y:newY,parent:selected.id,img:null});
    saveState();
    redraw();
  }
}
function editNode() {
  if(!selected) return;
  let txt = prompt('Nội dung mới:', selected.text);
  if(txt!==null && txt!=="") {
    selected.text = txt;
    saveState();
    redraw();
  }
}
function removeNode() {
  if(!selected) return;
  if(!selected.parent) { alert('Không thể xóa node gốc!'); return;}
  let delId = selected.id;
  function removeChilds(pid) {
    let cs = nodes.filter(n=>n.parent===pid);
    cs.forEach(c=>removeChilds(c.id));
    nodes = nodes.filter(n=>n.id!==pid);
  }
  removeChilds(delId);
  selected = null;
  saveState();
  redraw();
}
function addImage() {
  if(!selected) return;
  let url = prompt('Dán URL hình ảnh:');
  if(url) {
    selected.img = url;
    saveState();
    redraw();
  }
}
function setPanMode(){ mode='pan'; }
function zoomIn(){ zoom*=1.2; redraw(); }
function zoomOut(){ zoom/=1.2; redraw(); }
function undo(){
  if(undoStack.length>1){
    redoStack.push(undoStack.pop());
    restore(undoStack[undoStack.length-1]);
  }
}
function redo(){
  if(redoStack.length>0){
    let st = redoStack.pop();
    restore(st);
    undoStack.push(st);
  }
}
function saveFile(){
  let data = JSON.stringify({nodes,pan,zoom});
  let blob = new Blob([data],{type:"application/json"});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "mindmap.json";
  a.click();
}
function openFile(e){
  let file = e.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(ev){
    let data = JSON.parse(ev.target.result);
    nodes = data.nodes; pan = data.pan; zoom = data.zoom;
    selected = nodes[0];
    saveState();
    redraw();
  };
  reader.readAsText(file);
  e.target.value = '';
}
function exportPng(){
  let tempCanvas = document.createElement('canvas');
  tempCanvas.width = canvas.width;
  tempCanvas.height = canvas.height;
  let tctx = tempCanvas.getContext('2d');
  tctx.fillStyle = "#fff"; tctx.fillRect(0,0,canvas.width,canvas.height);
  tctx.drawImage(canvas,0,0);
  let url = tempCanvas.toDataURL("image/png");
  let a = document.createElement('a');
  a.href = url;
  a.download = "mindmap.png";
  a.click();
}
/* --- Init --- */
window.addEventListener('resize', redraw);
saveState();
redraw();
</script>
</body>
</html>

