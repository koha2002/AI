<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Mindmap CAD Pro</title>
  <link rel="icon" href="logo.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {font-family: 'Montserrat', Arial, sans-serif; background: #0a1931; color: #222; margin:0;}
    #toolbar {display:flex;gap:10px;padding:8px 10px;background:#133360;flex-wrap:wrap;}
    #tabs {display:flex;gap:5px;}
    .tab {background:#2761ad;color:#fff;padding:7px 14px 7px 10px;border-radius:12px 12px 0 0;margin-right:4px;cursor:pointer;position:relative;}
    .tab.selected {background:#fff;color:#2761ad;border:2px solid #185adb;border-bottom:0;}
    .tab .close {position:absolute;right:4px;top:2px;color:#e22;font-size:15px;font-weight:bold;cursor:pointer;}
    #cad-canvas {background:#f7fafb;border-radius:18px;box-shadow:0 4px 28px #0a225040;width:97vw;height:76vh;display:block;margin:14px auto 14px auto;touch-action:none;}
    #menu {position:fixed;right:24px;top:70px;background:#fff;border:1.7px solid #185adb;border-radius:11px;box-shadow:0 2px 20px #0a1a34cc;padding:10px 24px;}
    #menu button {margin:6px;}
    #shapeSel, #colorSel, #paperSel {padding:5px 13px;border-radius:8px;margin-right:7px;}
    .toolbar-btn {padding:6px 15px;border-radius:7px;border:1px solid #bed5f6;background:#f3f9ff;cursor:pointer;font-weight:600;}
    #zoomInd {position:fixed;bottom:12px;left:20px;background:#183e88;color:#fff;border-radius:8px;padding:6px 16px;font-size:1.05rem;z-index:100;}
  </style>
</head>
<body>
<div id="toolbar">
  <button onclick="addTab()" class="toolbar-btn">+ S∆° ƒë·ªì m·ªõi</button>
  <div id="tabs"></div>
  <button onclick="mode='draw-node'" class="toolbar-btn">+ Node</button>
  <select id="shapeSel">
    <option value="rect">Ch·ªØ nh·∫≠t</option>
    <option value="ellipse">Ellipse</option>
    <option value="diamond">Thoi</option>
    <option value="note">Note</option>
    <option value="cloud">M√¢y</option>
    <option value="star">Sao</option>
  </select>
  <select id="colorSel">
    <option value="#c9e7ff">Xanh</option>
    <option value="#defde0">Xanh l√°</option>
    <option value="#ffd4e5">H·ªìng</option>
    <option value="#ffe5c2">Cam</option>
    <option value="#fff7c6">V√†ng</option>
    <option value="#efe0ff">T√≠m</option>
    <option value="#e7ebef">X√°m</option>
    <option value="#ffdad6">ƒê·ªè</option>
    <option value="#ccf8f4">Cyan</option>
    <option value="#e6ffd8">Lime</option>
  </select>
  <button onclick="mode='draw-conn'" class="toolbar-btn">+ K·∫øt n·ªëi</button>
  <button onclick="copyNodes()" class="toolbar-btn">Copy</button>
  <button onclick="pasteNodes()" class="toolbar-btn">Paste</button>
  <button onclick="startRectSel()" class="toolbar-btn">Khoanh v√πng</button>
  <button onclick="undo()" class="toolbar-btn">‚éå Undo</button>
  <button onclick="redo()" class="toolbar-btn">‚ü≥ Redo</button>
  <button onclick="saveTabs()" class="toolbar-btn">üíæ L∆∞u</button>
  <button onclick="showExportMenu()" class="toolbar-btn">PDF</button>
  <select id="paperSel">
    <option value="a4">A4 d·ªçc</option>
    <option value="a4_landscape">A4 ngang</option>
    <option value="a3">A3 d·ªçc</option>
    <option value="a3_landscape">A3 ngang</option>
    <option value="letter">Letter</option>
    <option value="free">Kh√¥ng gi·ªõi h·∫°n</option>
  </select>
  <input type="file" id="importPDF" accept=".pdf" style="display:none">
  <button onclick="document.getElementById('importPDF').click()" class="toolbar-btn">Import PDF</button>
</div>
<canvas id="cad-canvas" width="2400" height="1600" tabindex="0"></canvas>
<div id="menu" style="display:none;">
  <b>Xu·∫•t PDF</b><br>
  <button onclick="doExportPDF(true)">Ch·ªâ v√πng ch·ªçn</button>
  <button onclick="doExportPDF(false)">To√†n s∆° ƒë·ªì</button>
  <button onclick="closeExportMenu()">Hu·ª∑</button>
</div>
<div id="zoomInd" style="display:none;">100%</div>
<script>
// --- Data v√† logic canvas ---
const TABS_KEY = "mindmap_cad_tabs";
let tabs = loadTabs();
let currentTab = 0;
let mode = 'select'; // draw-node, draw-conn, select, rect-sel
let pan = {x:0, y:0}, zoom=1, mouse={};
let dragNode = null, dragOff={x:0,y:0}, dragResize=false;
let selNodes = new Set();
let connTempStart = null;
let copyClip = null;
let undoStack = [[]], redoStack = [[]];
const paperSizes = {
  a4:      {w: 210*3.78, h: 297*3.78},
  a4_landscape: {w: 297*3.78, h: 210*3.78},
  a3:      {w: 297*3.78, h: 420*3.78},
  a3_landscape: {w: 420*3.78, h: 297*3.78},
  letter:  {w: 215.9*3.78, h: 279.4*3.78},
  free:    {w: 2400, h: 1600}
};

function renderTabs() {
  let html = '';
  tabs.forEach((tab, i) => {
    html += `<div class="tab${i===currentTab?' selected':''}" onclick="switchTab(${i})">${tab.name} <span class="close" onclick="event.stopPropagation();closeTab(${i});">&times;</span></div>`;
  });
  document.getElementById('tabs').innerHTML = html;
}
function addTab() {
  let name = prompt("T√™n s∆° ƒë·ªì?");
  if (!name) return;
  tabs.push({name, nodes:[], lines:[]});
  currentTab = tabs.length-1;
  saveTabs();
  pushHistory();
  renderTabs();
  draw();
}
function closeTab(idx) {
  if(!confirm("X√°c nh·∫≠n xo√° s∆° ƒë·ªì n√†y?")) return;
  tabs.splice(idx,1);
  currentTab = Math.max(0, currentTab-1);
  saveTabs(); pushHistory(); renderTabs(); draw();
}
function switchTab(idx) {
  currentTab = idx;
  pushHistory();
  renderTabs();
  draw();
}
function saveTabs() { localStorage.setItem(TABS_KEY,JSON.stringify(tabs)); }
function loadTabs(){
  let d = localStorage.getItem(TABS_KEY);
  if(d) return JSON.parse(d);
  return [{name:"S∆° ƒë·ªì 1", nodes:[], lines:[]}];
}

// --- Main canvas logic ---
const canvas = document.getElementById('cad-canvas');
const ctx = canvas.getContext('2d');
function getPaperWH(){
  let v = document.getElementById('paperSel').value;
  return v==="free"?{w:2400,h:1600}:paperSizes[v];
}
function draw(){
  let {w,h} = getPaperWH();
  canvas.width = w; canvas.height = h;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,w,h);
  ctx.setTransform(zoom,0,0,zoom,pan.x,pan.y);
  // Draw grid
  ctx.save();
  ctx.strokeStyle="#e4eefa"; ctx.lineWidth=1;
  for(let x=0;x<w;x+=80){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
  for(let y=0;y<h;y+=80){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
  ctx.restore();

  // Draw connections
  let tab = tabs[currentTab];
  for(let l of tab.lines){
    let n1 = tab.nodes.find(n=>n.id===l.from), n2 = tab.nodes.find(n=>n.id===l.to);
    if(!n1||!n2) continue;
    ctx.save();
    ctx.strokeStyle="#185adb";ctx.lineWidth=3.1;ctx.globalAlpha=0.8;
    ctx.beginPath();
    ctx.moveTo(n1.x+n1.w/2, n1.y+n1.h/2);
    ctx.lineTo(n2.x+n2.w/2, n2.y+n2.h/2);
    ctx.stroke();
    ctx.restore();
  }
  // Temp conn
  if(mode==='draw-conn'&&connTempStart){
    ctx.save();
    ctx.strokeStyle="#ef5b1b";ctx.setLineDash([7,5]);
    ctx.lineWidth=2.5;
    ctx.beginPath();
    ctx.moveTo(connTempStart.x,connTempStart.y);
    ctx.lineTo(mouse.x,mouse.y);
    ctx.stroke();
    ctx.restore();
  }
  // Draw nodes
  for(let n of tab.nodes){
    drawNode(ctx, n, selNodes.has(n.id));
  }
  // Rect select
  if(mode==="rect-sel"&&rectSelBox){
    ctx.save();
    ctx.strokeStyle="#2196f3";ctx.setLineDash([7,7]);
    ctx.lineWidth=2.5; ctx.globalAlpha=0.55;
    ctx.strokeRect(rectSelBox.x,rectSelBox.y,rectSelBox.w,rectSelBox.h);
    ctx.restore();
  }
}
function drawNode(ctx, n, selected){
  ctx.save();
  ctx.beginPath();
  ctx.fillStyle = n.color||'#c9e7ff';
  ctx.strokeStyle = selected?"#185adb":"#bcd";
  ctx.lineWidth = selected?3:2;
  switch(n.shape){
    case "rect":
    default: ctx.roundRect(n.x, n.y, n.w, n.h, 14); break;
    case "ellipse": ctx.ellipse(n.x+n.w/2,n.y+n.h/2,n.w/2,n.h/2,0,0,Math.PI*2); break;
    case "diamond":
      ctx.moveTo(n.x+n.w/2, n.y);
      ctx.lineTo(n.x+n.w, n.y+n.h/2);
      ctx.lineTo(n.x+n.w/2, n.y+n.h);
      ctx.lineTo(n.x, n.y+n.h/2);
      ctx.closePath();
      break;
    case "star":
      let cx=n.x+n.w/2, cy=n.y+n.h/2, r=Math.min(n.w,n.h)/2;
      for(let i=0;i<5;i++){
        let a = Math.PI/2+i*2*Math.PI/5, a2 = a+Math.PI/5;
        let x1=cx+r*Math.cos(a), y1=cy-r*Math.sin(a);
        let x2=cx+r*0.45*Math.cos(a2), y2=cy-r*0.45*Math.sin(a2);
        if(i===0)ctx.moveTo(x1,y1); else ctx.lineTo(x1,y1);
        ctx.lineTo(x2,y2);
      } ctx.closePath(); break;
    case "note":
      ctx.roundRect(n.x, n.y, n.w, n.h, [9,30,13,20]); ctx.setLineDash([2,6]); break;
    case "cloud":
      for(let i=0;i<5;i++)ctx.arc(n.x+n.w*(0.2*i+0.13),n.y+n.h*0.5,Math.min(n.w,n.h)*0.18,0,Math.PI*2);
      break;
  }
  ctx.globalAlpha=0.97;
  ctx.fill(); ctx.stroke();
  // Text
  ctx.globalAlpha=1;
  ctx.font = "bold 17px Montserrat";
  ctx.fillStyle="#183655";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  let t = n.text.split('\n');
  for(let i=0;i<t.length;i++){
    ctx.fillText(t[i], n.x+n.w/2, n.y+n.h/2+(i-t.length/2)*21+13);
  }
  // Resize box (g√≥c)
  ctx.save();
  ctx.globalAlpha=selected?0.8:0.3;
  ctx.strokeStyle="#185adb"; ctx.lineWidth=2.2;
  ctx.beginPath();
  ctx.rect(n.x+n.w-9, n.y+n.h-9, 12, 12); ctx.stroke();
  ctx.restore();
  ctx.restore();
}

// -- Mouse/canvas event ---
let rectSelBox = null;
canvas.onmousedown = function(e){
  let p = toWorld(e.offsetX, e.offsetY);
  mouse = {...p};
  if(e.button===1||spacePan) { // Pan
    isPanning = true; panStart={x:e.clientX-pan.x, y:e.clientY-pan.y}; return;
  }
  if(mode==='draw-node'){
    let n = {
      id:Date.now()+Math.floor(Math.random()*1e4),
      x:p.x-60,y:p.y-30,w:120,h:54,
      shape:document.getElementById('shapeSel').value,
      color:document.getElementById('colorSel').value,
      text:'Node'
    };
    tabs[currentTab].nodes.push(n); saveTabs(); pushHistory(); mode='select'; draw(); return;
  }
  if(mode==='draw-conn'){
    let hit = hitNode(p);
    if(hit){
      if(!connTempStart){
        connTempStart={x:hit.x+hit.w/2,y:hit.y+hit.h/2,node:hit.id};
      }else{
        tabs[currentTab].lines.push({from:connTempStart.node,to:hit.id});
        connTempStart=null; saveTabs(); pushHistory(); mode='select'; draw();
      }
      return;
    }
  }
  // Select node or start drag/resize
  let hit = hitNode(p,true);
  if(hit){
    let isResize = Math.abs(p.x-(hit.x+hit.w))<16 && Math.abs(p.y-(hit.y+hit.h))<16;
    if(isResize){
      dragResize=true; dragNode=hit; return;
    }
    dragNode=hit; dragOff={x:p.x-hit.x,y:p.y-hit.y};
    if(e.ctrlKey||e.metaKey){
      if(selNodes.has(hit.id)) selNodes.delete(hit.id); else selNodes.add(hit.id);
    } else{
      selNodes.clear(); selNodes.add(hit.id);
    }
    draw(); return;
  }
  // Khung ch·ªçn
  if(mode==='rect-sel'){
    rectSelBox={x:p.x,y:p.y,w:1,h:1}; selecting=true;
    draw(); return;
  }
  // Click ngo√†i: clear ch·ªçn
  selNodes.clear(); draw();
};
canvas.onmousemove = function(e){
  let p = toWorld(e.offsetX, e.offsetY);
  mouse = {...p};
  if(isPanning){
    pan.x = e.clientX-panStart.x; pan.y = e.clientY-panStart.y; draw(); return;
  }
  if(dragResize&&dragNode){
    dragNode.w = Math.max(48,p.x-dragNode.x); dragNode.h = Math.max(28,p.y-dragNode.y);
    draw(); return;
  }
  if(dragNode){
    let dx=p.x-dragOff.x,dy=p.y-dragOff.y;
    let dxAll = dx-dragNode.x, dyAll=dy-dragNode.y;
    for(let id of selNodes){let n=tabs[currentTab].nodes.find(nn=>nn.id===id); n.x+=dxAll; n.y+=dyAll;}
    draw(); dragOff.x+=dxAll; dragOff.y+=dyAll;
    return;
  }
  if(selecting&&rectSelBox){
    rectSelBox.w=p.x-rectSelBox.x; rectSelBox.h=p.y-rectSelBox.y;
    draw(); return;
  }
};
canvas.onmouseup = function(e){
  if(isPanning){isPanning=false;return;}
  if(dragResize||dragNode){dragResize=false;dragNode=null;pushHistory();saveTabs();}
  if(selecting&&rectSelBox){
    let x0=rectSelBox.x,x1=rectSelBox.x+rectSelBox.w,y0=rectSelBox.y,y1=rectSelBox.y+rectSelBox.h;
    if(x1<x0) [x0,x1]=[x1,x0]; if(y1<y0)[y0,y1]=[y1,y0];
    selNodes.clear();
    for(let n of tabs[currentTab].nodes){
      if(n.x+n.w>x0 && n.x<x1 && n.y+n.h>y0 && n.y<ty+h) selNodes.add(n.id);
    }
    rectSelBox = null; selecting=false; mode='select'; draw();
  }
};
canvas.ondblclick = function(e){
  let p = toWorld(e.offsetX, e.offsetY);
  let n = hitNode(p,true);
  if(!n) return;
  let t = prompt("N·ªôi dung node:", n.text); if(t!==null) { n.text=t; saveTabs();pushHistory();draw();}
};
canvas.onwheel = function(e){
  let z = zoom + (e.deltaY>0?-0.08:0.08); z=Math.max(0.3,Math.min(z,3.3));
  let p = toWorld(e.offsetX,e.offsetY);
  pan.x -= (p.x* (z-zoom));
  pan.y -= (p.y* (z-zoom));
  zoom=z; draw();
  document.getElementById('zoomInd').innerText=Math.round(zoom*100)+"%";
  document.getElementById('zoomInd').style.display='block';
  clearTimeout(window.zoomTimeout); window.zoomTimeout = setTimeout(()=>{document.getElementById('zoomInd').style.display='none';},1200);
  e.preventDefault();
};

let isPanning=false, panStart={};
let spacePan=false;
window.onkeydown=function(e){
  if(e.code==='Space'){spacePan=true;}
  if((e.ctrlKey||e.metaKey)&&e.key==='c') copyNodes();
  if((e.ctrlKey||e.metaKey)&&e.key==='v') pasteNodes();
  if((e.ctrlKey||e.metaKey)&&e.key==='z') undo();
  if((e.ctrlKey||e.metaKey)&&e.key==='y') redo();
  if(e.key==="Delete"||e.key==="Backspace") deleteNodes();
};
window.onkeyup=function(e){ if(e.code==='Space'){spacePan=false;} }

function toWorld(x,y){ return {x: (x-pan.x)/zoom, y: (y-pan.y)/zoom}; }
function hitNode(p, loose=false){
  let arr = tabs[currentTab].nodes;
  for(let i=arr.length-1;i>=0;i--){
    let n=arr[i];
    let mx=n.x,my=n.y,mw=n.w,mh=n.h;
    if(loose)mw+=10,mh+=10;
    if(p.x>=mx&&p.x<=mx+mw&&p.y>=my&&p.y<=my+mh) return n;
  }
  return null;
}
function copyNodes(){
  if(selNodes.size) copyClip = tabs[currentTab].nodes.filter(n=>selNodes.has(n.id)).map(n=>({...n}));
}
function pasteNodes(){
  if(!copyClip||!copyClip.length) return;
  let arr = tabs[currentTab].nodes, ids=[];
  for(let n of copyClip){
    let nn={...n,id:Date.now()+Math.floor(Math.random()*1e4),x:n.x+35,y:n.y+30};
    arr.push(nn); ids.push(nn.id);
  }
  selNodes=new Set(ids); saveTabs(); pushHistory(); draw();
}
function deleteNodes(){
  if(!selNodes.size) return;
  if(!confirm("X√≥a c√°c node ƒë√£ ch·ªçn?")) return;
  let arr = tabs[currentTab].nodes;
  arr = arr.filter(n=>!selNodes.has(n.id));
  tabs[currentTab].nodes=arr;
  tabs[currentTab].lines=tabs[currentTab].lines.filter(l=>arr.find(n=>n.id===l.from)&&arr.find(n=>n.id===l.to));
  selNodes.clear();
  saveTabs();pushHistory();draw();
}
function startRectSel(){mode='rect-sel';}
function showExportMenu(){document.getElementById('menu').style.display='block';}
function closeExportMenu(){document.getElementById('menu').style.display='none';}
function doExportPDF(sel){
  closeExportMenu();
  setTimeout(()=>{
    if(!confirm("B·∫°n mu·ªën xu·∫•t PDF ngay b√¢y gi·ªù? H√£y ki·ªÉm tra l·∫°i s∆° ƒë·ªì!")) return;
    html2canvas(canvas).then(c=>{
      let pdf = new window.jspdf.jsPDF({
        orientation:c.width>c.height?'landscape':'portrait',
        unit:'pt',format:[c.width,c.height]
      });
      pdf.addImage(c.toDataURL('image/png'),'PNG',0,0,c.width,c.height);
      pdf.save('mindmap.pdf');
    });
  },120);
}
// Undo/Redo logic
function pushHistory(){
  if(!undoStack[currentTab])undoStack[currentTab]=[];
  undoStack[currentTab].push(JSON.stringify(tabs[currentTab]));
  redoStack[currentTab]=[]; // clear redo khi thay ƒë·ªïi
}
function undo(){
  if(undoStack[currentTab]&&undoStack[currentTab].length>1){
    redoStack[currentTab].push(undoStack[currentTab].pop());
    tabs[currentTab]=JSON.parse(undoStack[currentTab][undoStack[currentTab].length-1]);
    saveTabs(); draw();
  }
}
function redo(){
  if(redoStack[currentTab]&&redoStack[currentTab].length){
    let st = redoStack[currentTab].pop();
    undoStack[currentTab].push(st);
    tabs[currentTab]=JSON.parse(st);
    saveTabs(); draw();
  }
}

// PDF import
document.getElementById('importPDF').addEventListener('change', function(e){
  let file = e.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(){
    pdfjsLib.getDocument({data:new Uint8Array(reader.result)}).promise.then(pdf=>{
      let allText = "";
      let getPage = function(pn){
        if(pn>pdf.numPages) {
          if(!allText.trim()) return alert("Kh√¥ng c√≥ text trong file PDF!");
          let lines = allText.split('\n').map(s=>s.trim()).filter(s=>!!s);
          lines.forEach(txt=>{
            tabs[currentTab].nodes.push({
              id:Date.now()+Math.floor(Math.random()*1e4),
              x:200+Math.random()*300,
              y:120+Math.random()*400,
              w:150,h:48,
              shape:document.getElementById('shapeSel').value,
              color:document.getElementById('colorSel').value,
              text:txt
            });
          });
          pushHistory();saveTabs();draw();
          return;
        }
        pdf.getPage(pn).then(page=>{
          page.getTextContent().then(tc=>{
            allText+=tc.items.map(i=>i.str).join(' ')+'\n';
            getPage(pn+1);
          });
        });
      }
      getPage(1);
    });
  };
  reader.readAsArrayBuffer(file);
});

// L·∫ßn ƒë·∫ßu
renderTabs();
draw();
pushHistory();
document.getElementById('paperSel').onchange=draw;
window.addEventListener('resize',draw);
</script>
</body>
</html>
