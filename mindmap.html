<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Mindmap/Flowchart Pro - Đầy đủ shape, link, export, sidebar</title>
  <style>
    html,body{margin:0;padding:0;height:100%;width:100vw;overflow:hidden;}
    body{font-family:sans-serif;background:#f7f9fa;}
    #sidebar{position:absolute;top:0;left:0;width:74px;height:100%;background:#263238;z-index:12;transition:width 0.3s;}
    #sidebar.open{width:200px;}
    #sidebar .toggle{position:absolute;top:6px;right:-16px;z-index:16;width:26px;height:26px;border-radius:8px 0 0 8px;background:#37474f;color:#fff;cursor:pointer;line-height:28px;text-align:center;font-size:21px;}
    #sidebar .shapes{margin:45px 7px 0 8px;display:flex;flex-direction:column;gap:14px;}
    #sidebar .shapeicon{background:#fff;border:2px solid #bbb;width:36px;height:36px;border-radius:7px;display:flex;align-items:center;justify-content:center;cursor:grab;}
    #sidebar.open .shapeicon{width:54px;height:54px;}
    #sidebar .label{display:none;margin-left:10px;}
    #sidebar.open .label{display:inline;font-size:15px;color:#fff;}
    #canvasWrap{margin-left:74px;transition:margin-left 0.3s;}
    #sidebar.open ~ #canvasWrap{margin-left:200px;}
    #toolbar{position:absolute;top:0;left:74px;right:0;background:#222;color:#fff;z-index:10;height:44px;display:flex;align-items:center;gap:9px;padding:5px 9px;}
    #sidebar.open ~ #toolbar{left:200px;}
    #toolbar button,#toolbar select{margin-right:3px;padding:7px 13px;font-size:15px;background:#37474f;color:#fff;border:none;border-radius:4px;cursor:pointer;}
    #toolbar button:hover{background:#111;}
    #mindCanvas{display:block;background:#fff;}
    .selectedLink{stroke:#1976d2 !important;stroke-width:5 !important;}
    #sideRight {position:absolute;top:50px;right:12px;background:#fff;box-shadow:0 2px 10px #0001;border-radius:12px;padding:13px 13px 7px 15px;z-index:100;min-width:172px;display:none;}
    #sideRight label{font-size:14px;}
    #sideRight input[type="color"], #sideRight select, #sideRight input[type="number"]{margin-left:6px;margin-right:10px;}
    #sideRight input[type="text"]{margin-left:6px;margin-right:10px;width:80px;}
  </style>
</head>
<body>
  <div id="sidebar" class="open">
    <div class="toggle" onclick="toggleSidebar()">&#9776;</div>
    <div class="shapes">
      <div class="shapeicon" draggable="true" data-shape="rect" title="Vuông"><svg width="26" height="26"><rect x="4" y="4" width="18" height="18" fill="none" stroke="#222" stroke-width="2"/></svg><span class="label">Vuông</span></div>
      <div class="shapeicon" draggable="true" data-shape="ellipse" title="Tròn"><svg width="26" height="26"><ellipse cx="13" cy="13" rx="9" ry="9" fill="none" stroke="#222" stroke-width="2"/></svg><span class="label">Tròn</span></div>
      <div class="shapeicon" draggable="true" data-shape="diamond" title="Thoi"><svg width="26" height="26"><polygon points="13,4 22,13 13,22 4,13" fill="none" stroke="#222" stroke-width="2"/></svg><span class="label">Thoi</span></div>
      <div class="shapeicon" draggable="true" data-shape="parallelogram" title="Bình hành"><svg width="26" height="26"><polygon points="8,22 4,13 18,4 22,13" fill="none" stroke="#222" stroke-width="2"/></svg><span class="label">Bình hành</span></div>
      <div class="shapeicon" draggable="true" data-shape="hexagon" title="Lục giác"><svg width="26" height="26"><polygon points="8,4 18,4 24,13 18,22 8,22 2,13" fill="none" stroke="#222" stroke-width="2"/></svg><span class="label">Lục giác</span></div>
      <div class="shapeicon" draggable="true" data-shape="star" title="Ngôi sao"><svg width="26" height="26"><polygon points="13,2 16,9 24,9 17,14 19,22 13,17 7,22 9,14 2,9 10,9" fill="none" stroke="#222" stroke-width="2"/></svg><span class="label">Sao</span></div>
    </div>
  </div>
  <div id="canvasWrap" style="width:calc(100vw - 200px);height:100vh;position:relative;">
    <canvas id="mindCanvas"></canvas>
  </div>
  <div id="toolbar">
    <button onclick="addParentNode()">Tạo node cha mới</button>
    <button onclick="editNode()">Sửa nội dung</button>
    <button onclick="linkNodes()">Link 2 node</button>
    <button onclick="unlinkNodes()">Xóa Link</button>
    <button onclick="zoomIn()">Zoom+</button>
    <button onclick="zoomOut()">Zoom-</button>
    <button onclick="fitView()">Fit</button>
    <button onclick="toggleSidebar()">Hiện/Ẩn Sidebar</button>
    <button onclick="exportPNG()">PNG</button>
    <button onclick="exportSVG()">SVG</button>
    <button onclick="exportPDF()">PDF</button>
    <button onclick="saveFile()">Xuất file</button>
    <input type="file" id="fileInput" accept=".json" onchange="openFile(event)">
    <button onclick="showSideRight()">Tùy chỉnh node</button>
    <span style="margin-left:14px;color:#ffd700;font-size:14px;">Kéo-thả shape, chọn node/link, chủ động liên kết, sửa hình, màu, ảnh, icon... như Visio!</span>
  </div>
  <div id="sideRight">
    <label>Text: <input type="text" id="propText" onchange="updateProp('text',this.value)"></label>
    <label>Shape:
      <select id="propShape" onchange="updateProp('shape',this.value)">
        <option value="rect">Vuông</option>
        <option value="ellipse">Tròn</option>
        <option value="diamond">Thoi</option>
        <option value="parallelogram">Bình hành</option>
        <option value="hexagon">Lục giác</option>
        <option value="star">Sao</option>
      </select>
    </label><br>
    <label>Nền: <input type="color" id="propColor" onchange="updateProp('color',this.value)"></label>
    <label>Viền: <input type="color" id="propBorder" onchange="updateProp('border',this.value)"></label>
    <label>
      <select id="propBorderType" onchange="updateProp('borderType',this.value)">
        <option value="solid">Solid</option><option value="dashed">Dashed</option><option value="dotted">Dotted</option>
      </select>
    </label>
    <label>Icon: <input type="text" id="propIcon" maxlength="2" onchange="updateProp('icon',this.value)" style="width:28px"></label>
    <label>Ảnh: <input type="file" id="propImg" accept="image/*" onchange="uploadNodeImg(event)"></label><br>
    <label>Rộng: <input type="number" id="propW" min="32" max="420" onchange="updateProp('w',this.value)"></label>
    <label>Cao: <input type="number" id="propH" min="24" max="250" onchange="updateProp('h',this.value)"></label>
    <button onclick="hideSideRight()" style="float:right;margin:7px 5px 0 0;">Đóng</button>
  </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let nodes = [
  {id:1,text:"Bắt đầu",shape:"ellipse",x:450,y:300,w:130,h:62,color:"#ffe066",border:"#37474f",borderType:"solid",icon:"",img:null,parent:null}
];
let links = [];
let selectedNode = nodes[0], selectedNodes = [], selectedLink = null;
let draggingNode = null, dragOffset = {x:0, y:0}, pan = {x:0,y:0}, zoom = 1;
/* --- SHAPE DRAG & DROP --- */
document.querySelectorAll('.shapeicon').forEach(el=>{
  el.ondragstart = function(e){
    e.dataTransfer.setData("shape", el.dataset.shape);
  };
});
document.getElementById('canvasWrap').ondragover = function(e){e.preventDefault();};
document.getElementById('canvasWrap').ondrop = function(e){
  e.preventDefault();
  let rect = canvas.getBoundingClientRect();
  let shape = e.dataTransfer.getData("shape");
  let x = (e.clientX - rect.left - pan.x)/zoom;
  let y = (e.clientY - rect.top - pan.y)/zoom;
  addNodeShape(shape, x, y);
};
function addNodeShape(shape, x, y){
  let id = Date.now()+Math.random();
  nodes.push({id, text:"", shape, x, y, w:120, h:60, color:"#ffe066", border:"#37474f", borderType:"solid", icon:"", img:null, parent:null});
  redraw();
  fitView();
}
function toggleSidebar(){
  let sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('open');
  setTimeout(redraw, 310);
}
/* --- DRAW --- */
function redraw(){
  let canvas = document.getElementById('mindCanvas');
  canvas.width = document.getElementById('canvasWrap').clientWidth;
  canvas.height = document.getElementById('canvasWrap').clientHeight;
  let ctx = canvas.getContext('2d');
  ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.setTransform(zoom,0,0,zoom,pan.x,pan.y);
  // Draw links
  links.forEach(link=>{
    let a=nodes.find(n=>n.id===link.from),b=nodes.find(n=>n.id===link.to);
    if(a&&b){
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(a.x, a.y);
      ctx.lineTo(b.x, b.y);
      ctx.strokeStyle = (selectedLink===link) ? "#1976d2" : "#888";
      ctx.lineWidth = (selectedLink===link) ? 5 : 3;
      ctx.setLineDash(link.type==="dashed"?[8,6]:link.type==="dotted"?[2,6]:[]);
      ctx.stroke();ctx.setLineDash([]);
      ctx.restore();
    }
  });
  // Draw nodes
  nodes.forEach(n=>{
    ctx.save();
    ctx.strokeStyle = (selectedNode===n||selectedNodes.includes(n)) ? "#e67700" : n.border;
    ctx.lineWidth = (selectedNode===n||selectedNodes.includes(n)) ? 4 : 2;
    ctx.setLineDash(n.borderType==="dashed"?[10,7]:n.borderType==="dotted"?[2,6]:[]);
    ctx.fillStyle = n.color;
    if(n.shape==="ellipse")
      ctx.beginPath(),ctx.ellipse(n.x,n.y,n.w/2,n.h/2,0,0,2*Math.PI),ctx.fill(),ctx.stroke();
    else if(n.shape==="rect")
      ctx.beginPath(),ctx.rect(n.x-n.w/2,n.y-n.h/2,n.w,n.h),ctx.fill(),ctx.stroke();
    else if(n.shape==="diamond")
      ctx.beginPath(),ctx.moveTo(n.x,n.y-n.h/2),ctx.lineTo(n.x+n.w/2,n.y),ctx.lineTo(n.x,n.y+n.h/2),ctx.lineTo(n.x-n.w/2,n.y),ctx.closePath(),ctx.fill(),ctx.stroke();
    else if(n.shape==="parallelogram")
      ctx.beginPath(),ctx.moveTo(n.x-n.w/3,n.y-n.h/2),ctx.lineTo(n.x+n.w/2,n.y-n.h/2),ctx.lineTo(n.x+n.w/3,n.y+n.h/2),ctx.lineTo(n.x-n.w/2,n.y+n.h/2),ctx.closePath(),ctx.fill(),ctx.stroke();
    else if(n.shape==="hexagon")
      {ctx.beginPath();for(let i=0;i<6;i++){let a = Math.PI/3*i-Math.PI/6;ctx.lineTo(n.x+Math.cos(a)*n.w/2,n.y+Math.sin(a)*n.h/2);}ctx.closePath();ctx.fill();ctx.stroke();}
    else if(n.shape==="star")
      {let r1=n.w/2,r2=n.w/6,nStar=5;ctx.beginPath();for(let i=0;i<2*nStar;i++){let r=i%2?r2:r1,a=Math.PI/nStar*i-Math.PI/2;ctx.lineTo(n.x+r*Math.cos(a),n.y+r*Math.sin(a));}ctx.closePath();ctx.fill();ctx.stroke();}
    ctx.setLineDash([]);
    ctx.fillStyle="#212121";
    ctx.font="bold 15px Arial";
    ctx.textAlign="center";ctx.textBaseline="middle";
    ctx.fillText((n.icon?n.icon+" ":"")+(n.text||n.shape),n.x,n.y);
    // Draw image
    if(n.img){
      let img=new window.Image();
      img.onload=()=>{ctx.drawImage(img,n.x-n.w/2+5,n.y-n.h/2+5,n.w-10,n.h-10);};
      img.src=n.img;if(img.complete)img.onload();
    }
    ctx.restore();
  });
}
canvas.onclick = function(e){
  let rect = canvas.getBoundingClientRect();
  let x = (e.clientX - rect.left - pan.x)/zoom, y = (e.clientY - rect.top - pan.y)/zoom;
  let found = nodes.find(n=>Math.abs(x-n.x)<n.w/2 && Math.abs(y-n.y)<n.h/2);
  if(found){
    if(event.ctrlKey||event.metaKey){if(!selectedNodes.includes(found))selectedNodes.push(found);}else{selectedNode=found;selectedNodes=[found];}
    redraw();
    showNodeProps(found);
  }else{
    // Chọn link?
    let selLink = null;
    links.forEach(link=>{
      let a=nodes.find(n=>n.id===link.from),b=nodes.find(n=>n.id===link.to);
      if(a&&b){
        let d = Math.abs((b.y-a.y)*x-(b.x-a.x)*y+b.x*a.y-b.y*a.x)/Math.hypot(b.y-a.y,b.x-a.x);
        if(d<8/zoom)selLink=link;
      }
    });
    selectedLink=selLink;selectedNode=null;selectedNodes=[];redraw();
    hideSideRight();
  }
};
function addParentNode(){
  if(selectedNode){selectedNode.parent=null;redraw();}
}
function linkNodes(){
  if(selectedNodes.length===2){
    let exists=links.find(l=>l.from===selectedNodes[0].id&&l.to===selectedNodes[1].id);
    if(!exists)links.push({from:selectedNodes[0].id,to:selectedNodes[1].id,type:"solid"});
    redraw();
  }
}
function unlinkNodes(){
  if(selectedLink){
    links=links.filter(l=>l!==selectedLink);selectedLink=null;redraw();
  }else if(selectedNodes.length===2){
    links=links.filter(l=>!(l.from===selectedNodes[0].id&&l.to===selectedNodes[1].id));
    redraw();
  }
}
function zoomIn(){zoom*=1.15;redraw();}
function zoomOut(){zoom/=1.15;redraw();}
function fitView(){
  if(nodes.length==0)return;
  let minX=Math.min(...nodes.map(n=>n.x-n.w/2)),maxX=Math.max(...nodes.map(n=>n.x+n.w/2));
  let minY=Math.min(...nodes.map(n=>n.y-n.h/2)),maxY=Math.max(...nodes.map(n=>n.y+n.h/2));
  let cw=canvas.width,ch=canvas.height;
  let scale=Math.min(cw/(maxX-minX+200),ch/(maxY-minY+160));
  zoom=Math.max(Math.min(scale,2.2),0.16);
  pan.x=(cw/2-(minX+maxX)/2*zoom);pan.y=(ch/2-(minY+maxY)/2*zoom);redraw();
}
function exportPNG(){
  let temp=document.createElement('canvas');
  temp.width=canvas.width;temp.height=canvas.height;
  let tctx=temp.getContext('2d');
  tctx.fillStyle="#fff";tctx.fillRect(0,0,canvas.width,canvas.height);
  tctx.drawImage(canvas,0,0);
  let url=temp.toDataURL("image/png");
  let a=document.createElement('a');a.href=url;a.download="mindmap.png";a.click();
}
function exportSVG(){
  // SVG vector (không hỗ trợ ảnh inline)
  let minX=Math.min(...nodes.map(n=>n.x-n.w/2)),maxX=Math.max(...nodes.map(n=>n.x+n.w/2));
  let minY=Math.min(...nodes.map(n=>n.y-n.h/2)),maxY=Math.max(...nodes.map(n=>n.y+n.h/2));
  let width=maxX-minX+180,height=maxY-minY+180;
  let svg='<svg xmlns="http://www.w3.org/2000/svg" width="'+width+'" height="'+height+'">';
  links.forEach(link=>{
    let a=nodes.find(n=>n.id===link.from),b=nodes.find(n=>n.id===link.to);
    if(a&&b){
      svg+=`<line x1="${a.x-minX+90}" y1="${a.y-minY+90}" x2="${b.x-minX+90}" y2="${b.y-minY+90}" stroke="#888" stroke-width="3" ${link.type==="dashed"?'stroke-dasharray="8,6"':link.type==="dotted"?'stroke-dasharray="2,6"':''}/>`;
    }
  });
  nodes.forEach(n=>{
    if(n.shape==="ellipse")
      svg+=`<ellipse cx="${n.x-minX+90}" cy="${n.y-minY+90}" rx="${n.w/2}" ry="${n.h/2}" fill="${n.color}" stroke="${n.border}" stroke-width="2"/>`;
    else if(n.shape==="rect")
      svg+=`<rect x="${n.x-n.w/2-minX+90}" y="${n.y-n.h/2-minY+90}" width="${n.w}" height="${n.h}" fill="${n.color}" stroke="${n.border}" stroke-width="2"/>`;
    // ... (diamond, hexagon, star tương tự)
    svg+=`<text x="${n.x-minX+90}" y="${n.y-minY+90}" fill="#222" font-size="14" font-family="Arial" text-anchor="middle" alignment-baseline="middle">${(n.icon?n.icon+" ":"")+n.text}</text>`;
  });
  svg+="</svg>";
  let blob=new Blob([svg],{type:"image/svg+xml"});
  let a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="mindmap.svg";a.click();
}
function exportPDF(){
  import('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/+esm').then(({default:html2canvas})=>{
    html2canvas(canvas).then(c=>{
      let img=c.toDataURL("image/png");
      let pdf=new window.jspdf.jsPDF({orientation:"l",unit:"px",format:[canvas.width,canvas.height]});
      pdf.addImage(img,"PNG",0,0,canvas.width,canvas.height);
      pdf.save("mindmap.pdf");
    });
  });
}
function saveFile(){
  let data=JSON.stringify({nodes,links,pan,zoom});
  let blob=new Blob([data],{type:"application/json"});
  let a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="mindmap.json";a.click();
}
function openFile(e){
  let file=e.target.files[0];if(!file)return;
  let reader=new FileReader();
  reader.onload=function(ev){
    let data=JSON.parse(ev.target.result);
    nodes=data.nodes;links=data.links;pan=data.pan;zoom=data.zoom;
    selectedNode=nodes[0];selectedNodes=[selectedNode];selectedLink=null;
    redraw();
  };reader.readAsText(file);e.target.value="";
}
/* --- PROPERTIES PANEL --- */
function showSideRight(){
  let s = selectedNode;
  if(!s) return;
  let d = document.getElementById('sideRight');
  d.style.display="block";
  document.getElementById('propText').value = s.text||"";
  document.getElementById('propShape').value = s.shape;
  document.getElementById('propColor').value = s.color||"#ffe066";
  document.getElementById('propBorder').value = s.border||"#37474f";
  document.getElementById('propBorderType').value = s.borderType||"solid";
  document.getElementById('propIcon').value = s.icon||"";
  document.getElementById('propW').value = s.w||120;
  document.getElementById('propH').value = s.h||60;
}
function hideSideRight(){document.getElementById('sideRight').style.display="none";}
function updateProp(prop, val){
  if(!selectedNode) return;
  if(prop==="w"||prop==="h") val=parseInt(val)||40;
  selectedNode[prop]=val;
  redraw();
}
function uploadNodeImg(e){
  if(!selectedNode)return;
  let file=e.target.files[0];if(!file)return;
  let reader=new FileReader();
  reader.onload=function(ev){
    selectedNode.img=ev.target.result;redraw();
  };
  reader.readAsDataURL(file);e.target.value="";
}
function editNode(){
  if(!selectedNode) return;
  let txt=prompt("Nhập nội dung node:",selectedNode.text||"");
  if(txt!==null) { selectedNode.text=txt; redraw(); }
}
/* --- KHỞI TẠO --- */
window.addEventListener('resize',redraw);
redraw();
</script>
</body>
</html>
