<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>S∆° ƒê·ªì T∆∞ Duy Online</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; background: radial-gradient(ellipse at 60% 40%, #233d61 0%, #0a1931 100%); margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column;}
    main { flex: 1 0 auto; width: 100vw; min-height: 70vh; display: flex; flex-direction: column; align-items: center; z-index: 2;}
    #mindmap-toolbar { margin: 24px 0 10px 0; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center; background: rgba(25,41,69,0.92); border-radius: 16px; padding: 13px 20px 11px 20px; box-shadow: 0 3px 18px #0003;}
    #mindmap-toolbar > * {margin-right: 5px;}
    .color-pick { width: 26px; height: 26px; border: 2.5px solid #eee; border-radius: 50%; margin: 0 1.5px; display: inline-block; cursor: pointer; transition: transform 0.1s, border 0.15s; box-shadow: 0 2px 7px #0001; vertical-align: middle;}
    .color-pick.selected { border: 3.5px solid #185adb; transform: scale(1.14); box-shadow: 0 4px 13px #6dcfff38;}
    #shape-select-wrap { position: relative; display: inline-block; vertical-align: middle;}
    #shape-selector { padding: 6px 26px 6px 6px; border-radius: 9px; font-size: 1.09rem; border: 1.7px solid #bed5f6; background: #f3f8ff url('data:image/svg+xml;utf8,<svg fill="gray" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 10"><path d="M1 3l6 6 6-6" stroke="%23699ae6" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>') no-repeat right 7px center/15px 11px; font-family: 'Montserrat', Arial, sans-serif; appearance: none; cursor: pointer; outline: none; min-width: 66px; margin: 0 2px; box-shadow: 0 1px 8px #6b97c10a; color: #18418b; font-weight: 600; transition: border 0.16s;}
    #shape-selector:focus { border-color: #185adb; }
    #paper-size-selector { padding:6px 12px; border-radius:8px; font-size:1rem; margin:0 4px; border: 1.2px solid #bed5f6;}
    #mindmapArea { background: linear-gradient(125deg, #f8fafc 70%, #e2edff 100%); border: 1.5px solid #185adb3a; border-radius: 22px; margin: 0 auto 34px auto; box-shadow: 0 8px 44px #173c7146; position: relative; overflow: auto; transition: box-shadow 0.15s;}
    #mindmapLines { position: absolute; top:0; left:0; z-index: 0; pointer-events: none;}
    #nodesContainer { position: relative; z-index: 1; min-width: 100%; min-height: 100%;}
    .mindmap-node { position: absolute; min-width: 66px; min-height: 30px; max-width: 440px; max-height: 160px; padding: 11px 15px; font-size: 1.02rem; font-weight: 500; box-shadow: 0 2px 10px #0a1e3130; cursor: move; outline: none; border: 2.3px solid #fff6; user-select: text; transition: box-shadow 0.2s, border 0.2s; display: flex; align-items: center; justify-content: center; word-break: break-word; z-index: 2; background: #fff; resize: both; overflow: auto;}
    .mindmap-node.selected { border: 2.7px solid #185adb; box-shadow: 0 4px 18px #3199e555;}
    .mindmap-node .node-text { width: 100%; text-align: center; outline: none; resize: none; background: none; border: none; font-family: inherit; font-size: inherit; color: inherit; display: block; padding: 0; margin: 0; line-height: 1.2; word-break: break-word;}
    /* Shapes */
    .node-rect { border-radius: 13px; }
    .node-round { border-radius: 30px; }
    .node-circle { border-radius: 50%; width:66px; height:66px; min-width:66px; min-height:66px; max-width:110px; max-height:110px;}
    .node-ellipse { border-radius: 50%/35%; width:110px; min-width:80px; height:46px; min-height:35px; max-width:220px; max-height:100px;}
    .node-diamond { width: 66px; min-width: 55px; height: 66px; min-height: 55px; max-width:120px; max-height:120px; background: inherit; border-radius: 8px; transform: rotate(45deg); display: flex; align-items: center; justify-content: center; padding: 0;}
    .node-diamond .node-text { transform: rotate(-45deg); width: 85%; background: none;}
    .node-cloud { border-radius: 40% 55% 44% 54% / 48% 44% 56% 52%; box-shadow: 0 4px 22px #b8e4ff24; border-style: dashed; background: repeating-linear-gradient(135deg, #fff7, #fff7 9px, #f3f7fa 10px, #f3f7fa 19px);}
    .node-arrow-right { clip-path: polygon(0% 0%, 80% 0%, 80% 25%, 100% 50%, 80% 75%, 80% 100%, 0% 100%); min-width: 80px; min-height: 36px; padding-right:28px; display: flex; align-items: center; justify-content: center;}
    .node-note { border-radius: 6px 32px 6px 14px; border-style: dashed; background: linear-gradient(107deg,#fff7 70%,#fbeecb 100%);}
    .node-explode { background: #fffbe4; clip-path: polygon(54% 0%, 65% 18%, 85% 12%, 78% 33%, 100% 40%, 81% 56%, 89% 76%, 68% 72%, 59% 100%, 46% 77%, 19% 98%, 31% 76%, 4% 80%, 23% 59%, 0% 38%, 23% 33%, 9% 13%, 35% 17%);}
    .node-file { clip-path: polygon(0 0, 77% 0, 100% 23%, 100% 100%, 0 100%); background: linear-gradient(112deg,#fff7 80%,#c6e0fa 100%);}
    .node-star { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); background: #fffbe4; color: #bf9020;}
    .node-color-blue { background: #c9e7ff; color: #1450a3;}
    .node-color-green { background: #defde0; color: #257934;}
    .node-color-yellow { background: #fff7c6; color: #926e13;}
    .node-color-pink { background: #ffd4e5; color: #b42e7d;}
    .node-color-orange { background: #ffe5c2; color: #b55e00;}
    .node-color-purple { background: #efe0ff; color: #63298f;}
    .node-color-gray { background: #e7ebef; color: #333d4b;}
    .node-color-red { background: #ffdad6; color: #a42c13;}
    .node-color-cyan { background: #ccf8f4; color: #137c8b;}
    .node-color-lime { background: #e6ffd8; color: #3a7034;}
    .tip { font-size: .98rem; color: #1b2949c0; margin: 0 0 13px 6px;}
    #deleteNodeBtn { position: fixed; z-index: 1111; background: #d61c1c; color: #fff; font-weight: 700; font-size: 1.04rem; border: none; border-radius: 13px; padding: 7px 17px 8px 12px; box-shadow: 0 2px 12px #9004; cursor: pointer; left: -1000px; top: -1000px; transition: left .15s, top .15s, opacity .2s; display: none; outline: none;}
    #deleteNodeBtn.show {display: block;}
    #select-region-btn { margin-left:10px; background:#fff8; border:1px solid #bed5f6; border-radius:7px; font-size:1rem; cursor:pointer; padding:6px 13px;}
    #select-region-btn.active {background:#d1ecfa;}
    #selected-region { position:absolute; border:2px dashed #2196f3; background:rgba(33,150,243,0.08); pointer-events:none; display:none;}
    #zoom-indicator { position:fixed; bottom:25px; left:25px; background:rgba(40,80,170,0.87); color:#fff; border-radius:7px; padding:6px 18px; font-size:1rem; font-weight:700; z-index:111; user-select:none; opacity:0.93;}
    @media (max-width: 600px) {
      #mindmapArea { min-height: 400px; height: 420px;}
      #mindmap-toolbar {flex-direction: column; gap:8px; margin: 14px 0 7px 0;}
      #deleteNodeBtn {font-size:.95rem; padding: 7px 11px;}
      #zoom-indicator {font-size:.9rem;}
    }
  </style>
</head>
<body>
  <div id="header"></div>
  <main>
    <div id="mindmap-toolbar">
      <button id="addNodeBtn" title="Th√™m node m·ªõi">‚ûï Node</button>
      <button id="exportPDFBtn" title="Xu·∫•t PDF">üìÑ PDF</button>
      <span class="tip">M√†u:</span>
      <span id="color-list"></span>
      <span class="tip" style="margin-left:7px;">D·∫°ng:</span>
      <span id="shape-select-wrap">
        <select id="shape-selector" title="Ch·ªçn h√¨nh d·∫°ng node"></select>
      </span>
      <span class="tip" style="margin-left:7px;">Kh·ªï gi·∫•y:</span>
      <select id="paper-size-selector">
        <option value="a4">A4 d·ªçc (210x297mm)</option>
        <option value="a4_landscape">A4 ngang (297x210mm)</option>
        <option value="a3">A3 d·ªçc (297x420mm)</option>
        <option value="a3_landscape">A3 ngang (420x297mm)</option>
        <option value="letter">Letter</option>
        <option value="free">Kh√¥ng gi·ªõi h·∫°n (Free size)</option>
      </select>
      <button id="select-region-btn">Khoanh v√πng xu·∫•t PDF</button>
    </div>
    <div id="mindmapArea" style="width:800px; height:1131px;">
      <svg id="mindmapLines" width="100%" height="100%"></svg>
      <div id="nodesContainer"></div>
      <div id="selected-region"></div>
    </div>
    <div class="tip">K√©o th·∫£, ch·ªçn node ƒë·ªÉ s·ª≠a, ch·ªçn m√†u/h√¨nh d·∫°ng tr√™n thanh c√¥ng c·ª•, click 2 node ƒë·ªÉ n·ªëi √Ω. Zoom b·∫±ng lƒÉn chu·ªôt. Nh·∫•n X√≥a ho·∫∑c ph√≠m Delete ƒë·ªÉ x√≥a node.</div>
    <button id="deleteNodeBtn">üóë X√≥a node</button>
    <div id="zoom-indicator" style="display:none;">100%</div>
  </main>
  <div id="footer"></div>
<script>
fetch('mini-header.html').then(res=>res.text()).then(t=>document.getElementById('header').innerHTML=t);
fetch('footer.html').then(res=>res.text()).then(t=>document.getElementById('footer').innerHTML=t);

/* ==== M√ÄU & H√åNH D·∫†NG ==== */
const COLORS = [
  {code:'blue', val:'#c9e7ff'}, {code:'green', val:'#defde0'},
  {code:'yellow', val:'#fff7c6'}, {code:'pink', val:'#ffd4e5'},
  {code:'orange', val:'#ffe5c2'}, {code:'purple', val:'#efe0ff'},
  {code:'cyan', val:'#ccf8f4'}, {code:'lime', val:'#e6ffd8'},
  {code:'red', val:'#ffdad6'}, {code:'gray', val:'#e7ebef'}
];
const SHAPES = [
  {cls:'node-rect', name:'Ch·ªØ nh·∫≠t', icon:'‚ñ≠'},
  {cls:'node-round', name:'Bo tr√≤n', icon:'‚¨≠'},
  {cls:'node-circle', name:'Tr√≤n', icon:'‚¨§'},
  {cls:'node-ellipse', name:'Elip', icon:'‚¨≠'},
  {cls:'node-cloud', name:'M√¢y', icon:'‚òÅÔ∏è'},
  {cls:'node-diamond', name:'Thoi', icon:'‚óÜ'},
  {cls:'node-arrow-right', name:'M≈©i t√™n', icon:'‚ûî'},
  {cls:'node-note', name:'Ghi ch√∫', icon:'üìù'},
  {cls:'node-explode', name:'N·ªï', icon:'üí•'},
  {cls:'node-file', name:'File', icon:'üìÑ'},
  {cls:'node-star', name:'Ng√¥i sao', icon:'‚òÖ'},
];
let curColor = 'blue', curShape = 'node-rect';
const colorList = document.getElementById('color-list');
COLORS.forEach(c=>{
  let d = document.createElement('span');
  d.className = 'color-pick node-color-' + c.code + (c.code===curColor?' selected':'');
  d.style.background = c.val;
  d.title = c.code.charAt(0).toUpperCase()+c.code.slice(1);
  d.onclick = ()=>{
    curColor = c.code;
    document.querySelectorAll('.color-pick').forEach(x=>x.classList.remove('selected'));
    d.classList.add('selected');
    if(selectedNodeId !== null) setNodeColor(selectedNodeId, c.code);
  };
  colorList.appendChild(d);
});
const shapeSel = document.getElementById('shape-selector');
SHAPES.forEach((s, idx)=>{
  let op = document.createElement('option');
  op.value = s.cls;
  op.innerHTML = `${s.icon} ${s.name}`;
  op.textContent = `${s.icon} ${s.name}`;
  if(idx===0) op.selected = true;
  shapeSel.appendChild(op);
});
shapeSel.onchange = function() {
  curShape = this.value;
  if(selectedNodeId !== null) setNodeShape(selectedNodeId, curShape);
};

/* ==== KH·ªî GI·∫§Y ==== */
const paperSizes = {
  a4:      {w: 210*3.78, h: 297*3.78}, // px: 1mm ~ 3.78px
  a4_landscape: {w: 297*3.78, h: 210*3.78},
  a3:      {w: 297*3.78, h: 420*3.78},
  a3_landscape: {w: 420*3.78, h: 297*3.78},
  letter:  {w: 215.9*3.78, h: 279.4*3.78},
  free:    {w: "100vw", h: "100vh"}
};
const paperSel = document.getElementById("paper-size-selector");
const mindmapArea = document.getElementById('mindmapArea');
function updatePaperSize() {
  let val = paperSel.value;
  if(val==="free") {
    mindmapArea.style.width = "98vw";
    mindmapArea.style.height = "75vh";
    mindmapArea.style.maxWidth = "none";
    mindmapArea.style.maxHeight = "none";
  } else {
    mindmapArea.style.width = paperSizes[val].w+"px";
    mindmapArea.style.height = paperSizes[val].h+"px";
    mindmapArea.style.maxWidth = paperSizes[val].w+"px";
    mindmapArea.style.maxHeight = paperSizes[val].h+"px";
  }
  updateSvgSize();
}
paperSel.onchange = updatePaperSize;

/* ==== MINDMAP LOGIC ==== */
let nodes = [], lines = [], nodeId = 0, selectedNodeId = null, linkStartNode = null;
const nodesContainer = document.getElementById('nodesContainer');
const mindmapLines = document.getElementById('mindmapLines');
const deleteBtn = document.getElementById('deleteNodeBtn');

/* T·∫°o node m·ªõi */
function createNode(x, y, text = '√ù ch√≠nh', color = curColor, shape = curShape) {
  let id = nodeId++;
  let nodeDiv = document.createElement('div');
  nodeDiv.className = `mindmap-node node-color-${color} ${shape}`;
  nodeDiv.innerHTML = `<div class="node-text" contenteditable="true">${text}</div>`;
  nodeDiv.style.left = x + 'px';
  nodeDiv.style.top = y + 'px';
  nodeDiv.dataset.id = id;
  nodeDiv.spellcheck = false;
  nodeDiv.style.minWidth = "66px"; nodeDiv.style.minHeight = "30px";
  nodeDiv.style.maxWidth = "440px"; nodeDiv.style.maxHeight = "160px";

  nodeDiv.onclick = (e) => {
    e.stopPropagation();
    selectNode(id, nodeDiv);
    if(linkStartNode!==null && linkStartNode!==id){
      lines.push([linkStartNode, id]);
      linkStartNode = null;
      renderLines();
    } else {
      linkStartNode = id;
    }
  };
  nodeDiv.onmousedown = (e) => {
    if(e.target.className === 'node-text') return;
    dragState.dragId = id;
    dragState.offsetX = e.offsetX;
    dragState.offsetY = e.offsetY;
    selectNode(id, nodeDiv);
    e.stopPropagation();
  };
  nodeDiv.querySelector('.node-text').oninput = () => {
    let node = nodes.find(n=>n.id===id);
    if(node) node.text = nodeDiv.querySelector('.node-text').innerText;
  };
  nodeDiv.onresize = () => { updateSvgSize(); renderLines(); };
  nodeDiv.addEventListener("mouseup", ()=>{ updateSvgSize(); renderLines(); });
  nodesContainer.appendChild(nodeDiv);
  nodes.push({id, x, y, text, el: nodeDiv, color, shape});
  renderNodeClass(id);
  updateSvgSize();
}
function renderNodeClass(id){
  let node = nodes.find(n=>n.id===id);
  if(!node) return;
  node.el.className = `mindmap-node node-color-${node.color} ${node.shape}` +
    (selectedNodeId===id ? ' selected':'');
}
function setNodeColor(id, color){
  let node = nodes.find(n=>n.id===id); if(!node) return;
  node.color = color;
  renderNodeClass(id);
}
function setNodeShape(id, shape){
  let node = nodes.find(n=>n.id===id); if(!node) return;
  let text = node.text;
  let {x,y} = node;
  let w = node.el.offsetWidth, h = node.el.offsetHeight;
  node.shape = shape;
  let newDiv = document.createElement('div');
  newDiv.className = `mindmap-node node-color-${node.color} ${shape}`+(selectedNodeId===id?' selected':'');
  newDiv.innerHTML = `<div class="node-text" contenteditable="true">${text}</div>`;
  newDiv.style.left = x + 'px'; newDiv.style.top = y + 'px';
  newDiv.dataset.id = node.id;
  newDiv.spellcheck = false;
  newDiv.style.minWidth = "66px"; newDiv.style.minHeight = "30px";
  newDiv.style.maxWidth = "440px"; newDiv.style.maxHeight = "160px";
  newDiv.style.width = w+"px"; newDiv.style.height = h+"px";
  newDiv.onclick = node.el.onclick;
  newDiv.onmousedown = node.el.onmousedown;
  newDiv.querySelector('.node-text').oninput = node.el.querySelector('.node-text').oninput;
  newDiv.onresize = ()=>{updateSvgSize();renderLines();};
  newDiv.addEventListener("mouseup", ()=>{ updateSvgSize(); renderLines(); });
  nodesContainer.replaceChild(newDiv, node.el);
  node.el = newDiv;
  renderNodeClass(node.id);
  renderLines();
  updateSvgSize();
  if(selectedNodeId === node.id) showDeleteBtn(newDiv);
}
function selectNode(id, el) {
  selectedNodeId = id;
  nodes.forEach(n=>n.el.classList.toggle('selected', n.id===id));
  showDeleteBtn(el || nodes.find(n=>n.id===id).el);
}
function showDeleteBtn(el){
  if(!el) {deleteBtn.classList.remove("show"); deleteBtn.style.left="-1000px"; return;}
  let rect = el.getBoundingClientRect();
  deleteBtn.style.left = (rect.right + window.scrollX + 8)+"px";
  deleteBtn.style.top = (rect.top + window.scrollY - 6)+"px";
  deleteBtn.classList.add("show");
}
function hideDeleteBtn() { deleteBtn.classList.remove("show"); deleteBtn.style.left = "-1000px"; }
deleteBtn.onclick = () => { if(selectedNodeId!=null) removeNode(selectedNodeId); hideDeleteBtn(); };
function removeNode(id){
  let idx = nodes.findIndex(n=>n.id===id);
  if(idx!==-1) {
    nodesContainer.removeChild(nodes[idx].el);
    nodes.splice(idx,1);
    lines = lines.filter(pair=>pair[0]!==id&&pair[1]!==id);
    renderLines();
    selectedNodeId = null;
    hideDeleteBtn();
  }
}

/* K√©o th·∫£ node (drag & drop) */
let dragState = {dragId:null, offsetX:0, offsetY:0};
mindmapArea.onmousedown = () => { dragState.dragId = null; linkStartNode = null; selectedNodeId=null; nodes.forEach(n=>n.el.classList.remove('selected')); hideDeleteBtn();};
mindmapArea.onmousemove = (e) => {
  if(dragState.dragId!==null){
    let rect = mindmapArea.getBoundingClientRect();
    let nx = e.clientX - rect.left - dragState.offsetX + mindmapArea.scrollLeft;
    let ny = e.clientY - rect.top - dragState.offsetY + mindmapArea.scrollTop;
    let node = nodes.find(n=>n.id === dragState.dragId);
    node.x = nx; node.y = ny;
    node.el.style.left = nx + 'px';
    node.el.style.top = ny + 'px';
    renderLines();
    updateSvgSize();
    showDeleteBtn(node.el);
  }
};
document.onmouseup = () => { dragState.dragId = null; };

/* V·∫Ω line SVG */
function renderLines(){
  mindmapLines.innerHTML = '';
  for(let [from, to] of lines){
    let nf = nodes.find(n=>n.id===from), nt = nodes.find(n=>n.id===to);
    if(nf && nt){
      let x1 = nf.x + nf.el.offsetWidth/2;
      let y1 = nf.y + nf.el.offsetHeight/2;
      let x2 = nt.x + nt.el.offsetWidth/2;
      let y2 = nt.y + nt.el.offsetHeight/2;
      let line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1", x1);
      line.setAttribute("y1", y1);
      line.setAttribute("x2", x2);
      line.setAttribute("y2", y2);
      line.setAttribute("stroke", "#185adb");
      line.setAttribute("stroke-width", 3.2);
      line.setAttribute("stroke-linecap","round");
      line.setAttribute("opacity","0.82");
      mindmapLines.appendChild(line);
    }
  }
}
function updateSvgSize(){
  let minX = 0, minY = 0, maxX = 800, maxY = 600;
  for(let n of nodes){
    minX = Math.min(minX, n.x);
    minY = Math.min(minY, n.y);
    maxX = Math.max(maxX, n.x + n.el.offsetWidth);
    maxY = Math.max(maxY, n.y + n.el.offsetHeight);
  }
  mindmapLines.setAttribute('width', maxX - minX + 100);
  mindmapLines.setAttribute('height', maxY - minY + 100);
  mindmapLines.style.width = (maxX - minX + 100) + 'px';
  mindmapLines.style.height = (maxY - minY + 100) + 'px';
}

document.getElementById('addNodeBtn').onclick = function() {
  let px = 90 + Math.random()*300;
  let py = 60 + Math.random()*150;
  createNode(px, py, "√ù m·ªõi", curColor, curShape);
  renderLines();
};

/* ===================== Ch·ªçn v√πng xu·∫•t PDF ================== */
const selectRegionBtn = document.getElementById("select-region-btn");
const selectedRegionDiv = document.getElementById("selected-region");
let selectingRegion = false, regionStart=null, regionEnd=null;
selectRegionBtn.onclick = function() {
  selectingRegion = !selectingRegion;
  this.classList.toggle("active", selectingRegion);
  selectedRegionDiv.style.display = selectingRegion?"block":"none";
  if(!selectingRegion) selectedRegionDiv.style.display="none";
};
mindmapArea.addEventListener("mousedown", function(e){
  if(!selectingRegion) return;
  regionStart = {x:e.offsetX, y:e.offsetY};
  selectedRegionDiv.style.left = regionStart.x+"px";
  selectedRegionDiv.style.top = regionStart.y+"px";
  selectedRegionDiv.style.width = "0px";
  selectedRegionDiv.style.height = "0px";
  selectedRegionDiv.style.display = "block";
  mindmapArea.onmousemove = function(e2){
    let x2 = e2.offsetX, y2 = e2.offsetY;
    let lx = Math.min(regionStart.x,x2), ty = Math.min(regionStart.y,y2);
    let w = Math.abs(regionStart.x-x2), h = Math.abs(regionStart.y-y2);
    selectedRegionDiv.style.left = lx+"px"; selectedRegionDiv.style.top=ty+"px";
    selectedRegionDiv.style.width=w+"px"; selectedRegionDiv.style.height=h+"px";
    regionEnd = {x:x2, y:y2};
  }
});
document.addEventListener("mouseup",function(){
  mindmapArea.onmousemove = null;
});
/* ============ Xu·∫•t PDF =============== */
document.getElementById('exportPDFBtn').onclick = function() {
  let area = mindmapArea;
  let scale = 2;
  let val = paperSel.value;
  let useRegion = selectedRegionDiv.style.display==="block" && (parseInt(selectedRegionDiv.style.width)>20 && parseInt(selectedRegionDiv.style.height)>20);
  let config = {
    backgroundColor:'#fff', scale:scale, useCORS: true
  };
  if(useRegion) {
    // xu·∫•t ƒë√∫ng v√πng ch·ªçn
    let rect = selectedRegionDiv.getBoundingClientRect();
    let areaRect = area.getBoundingClientRect();
    config.x = rect.left - areaRect.left + area.scrollLeft;
    config.y = rect.top - areaRect.top + area.scrollTop;
    config.width = parseInt(selectedRegionDiv.style.width);
    config.height = parseInt(selectedRegionDiv.style.height);
  }
  html2canvas(area, config).then(canvas => {
    let imgData = canvas.toDataURL('image/png');
    let w = canvas.width, h = canvas.height;
    let pdf;
    if(val==="free"||useRegion) {
      pdf = new window.jspdf.jsPDF({orientation:w>h?'landscape':'portrait', unit:'pt', format:[w,h]});
      pdf.addImage(imgData, 'PNG', 0, 0, w, h);
    } else {
      let {w:pw, h:ph} = paperSizes[val];
      pdf = new window.jspdf.jsPDF({orientation:pw>ph?'landscape':'portrait', unit:'pt', format:[pw*scale,ph*scale]});
      pdf.addImage(imgData, 'PNG', 0, 0, pw*scale, ph*scale);
    }
    pdf.save('so-do-tu-duy.pdf');
  });
};

/* ======================= ZOOM b·∫±ng con lƒÉn ===================== */
let zoom = 1;
const zoomIndicator = document.getElementById('zoom-indicator');
mindmapArea.addEventListener('wheel', function(e){
  if (e.ctrlKey || !e.altKey) {
    e.preventDefault();
    zoom += e.deltaY > 0 ? -0.1 : 0.1;
    zoom = Math.max(0.3, Math.min(zoom, 3.5));
    nodesContainer.style.transform = "scale("+zoom+")";
    mindmapLines.style.transform = "scale("+zoom+")";
    zoomIndicator.innerText = Math.round(zoom*100)+"%";
    zoomIndicator.style.display = "block";
    clearTimeout(window.zoomTimeout);
    window.zoomTimeout = setTimeout(()=>zoomIndicator.style.display="none", 1200);
  }
},{passive:false});

/* ============= Delete node b·∫±ng ph√≠m Delete =============== */
document.addEventListener('keydown', function(e) {
  if((e.key==="Delete"||e.key==="Backspace") && selectedNodeId!==null && document.activeElement.contentEditable!=="true") {
    removeNode(selectedNodeId);
    hideDeleteBtn();
  }
});

/* ============= T·ª± ƒë·ªông update paper khi load ============= */
window.onload = () => {
  updatePaperSize();
  createNode(250, 120, "Ch·ªß ƒë·ªÅ ch√≠nh", curColor, curShape);
  renderLines();
};
window.addEventListener('resize', () => { updateSvgSize(); renderLines(); });
</script>
</body>
</html>
