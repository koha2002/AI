<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chat AI - Tra C·ª©u H·ªçc Thu·∫≠t & AI</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
  <!-- C·∫¨P NH·∫¨T: S·ª≠ d·ª•ng file style.css chung -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  
  <!-- Header s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y -->
  <div id="header"></div>

  <main>
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0 0 0;gap:12px;">
      <div class="chat-page-title">
        <img src="icon-ai.png" alt="AI"> Tr·ª£ l√Ω AI h·ªçc t·∫≠p
      </div>
      <div class="api-btns-group" id="api-btns-group" style="margin-right:24px;"></div>
    </div>

    <div class="mode-switcher">
      <button class="mode-btn active" onclick="switchMode('chatbase')">Chatbase</button>
      <button class="mode-btn" onclick="switchMode('gpt')">Chat GPT</button>
      <button class="mode-btn" onclick="switchMode('gemini')">Chat Gemini</button>
      <button class="mode-btn" onclick="switchMode('koha')">Virtual Assistant KoHa</button>
    </div>

    <div class="chat-body">
      <div id="chatbase-chat" class="chat-messages" style="display:block;padding:0;">
        <iframe src="https://www.chatbase.co/chatbot-iframe/1pwNIgOXuse1aQvajtTiE" width="100%" allow="clipboard-write"></iframe>
      </div>
      <div id="gpt-chat" class="chat-messages" style="display:none; padding: 16px 0;"></div>
      <div id="gemini-chat" class="chat-messages" style="display:none; padding: 16px 0;"></div>
      <div id="koha-chat" class="chat-messages" style="display:none;padding:0;">
        <iframe src="nebulaAI.html" width="100%" style="border:none; min-height:72vh; display:block;" allow="clipboard-write"></iframe>
      </div>
    </div>
    
    <div class="chat-input-bar" id="chatbase-input" style="display:none;"></div>
    <div class="chat-input-bar" id="gpt-input" style="display:none;">
      <input id="userMsg-gpt" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi..." autocomplete="off" onkeydown="if(event.key==='Enter'){sendMsgGPT();}">
      <button onclick="sendMsgGPT()"><span>&#10148;</span></button>
    </div>
    <div class="chat-input-bar" id="gemini-input" style="display:none;">
      <input id="userMsg-gemini" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi..." autocomplete="off" onkeydown="if(event.key==='Enter'){sendMsgGemini();}">
      <button onclick="sendMsgGemini()"><span>&#10148;</span></button>
    </div>
  </main>
  
  <!-- Footer s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y -->
  <footer id="footer"></footer>
  
  <!-- Popup nh·∫≠p API Key -->
  <div class="popup-api-bg" id="popup-api" style="display:none;">
    <div class="popup-api-box">
      <label id="popup-label"></label>
      <div class="popup-desc" id="popup-desc"></div>
      <input id="popup-api-key" type="password" placeholder="">
      <div class="popup-btns">
        <button onclick="saveAPIKey()">L∆∞u Key</button>
        <button class="cancel" onclick="closeAPIKeyPopup()">H·ªßy</button>
        <button class="cancel" onclick="removeAPIKey()" style="background:#ffebe7;color:#c44;">X√≥a key</button>
      </div>
    </div>
  </div>
  
  <script>
    // Nh√∫ng header/footer t·ª´ file ri√™ng
    function loadHtml(id, file) {
      fetch(file).then(res => res.text()).then(data => {
        document.getElementById(id).innerHTML = data;
      });
    }
    // C·∫¨P NH·∫¨T: T·∫£i header nh·ªè thay v√¨ header l·ªõn
    loadHtml('header', 'mini-header.html'); 
    loadHtml('footer', 'footer.html');

    let chatMode = 'chatbase';
    function renderApiBtns(mode) {
      const group = document.getElementById('api-btns-group');
      if(!group) return;
      group.innerHTML = '';
      if(mode==='gpt') {
        group.innerHTML = `
          <a class="getkey-btn" href="https://platform.openai.com/settings/organization/api-keys" target="_blank">üîó L·∫•y GPT Key</a>
          <button class="api-btn" onclick="openAPIKeyPopup('gpt')">üîë Nh·∫≠p GPT Key</button>
        `;
      } else if(mode==='gemini') {
        group.innerHTML = `
          <a class="getkey-btn" href="https://aistudio.google.com/apikey" target="_blank">üîó L·∫•y Gemini Key</a>
          <button class="api-btn" onclick="openAPIKeyPopup('gemini')">üîë Nh·∫≠p Gemini Key</button>
        `;
      }
    }
    function switchMode(mode) {
      chatMode = mode;
      document.querySelectorAll('.mode-btn').forEach((el,i)=>{
        el.classList.toggle('active', (['chatbase','gpt','gemini','koha'][i]===mode));
      });
      document.getElementById('chatbase-chat').style.display = mode==='chatbase'?'block':'none';
      document.getElementById('chatbase-input').style.display = 'none';
      document.getElementById('gpt-chat').style.display = mode==='gpt'?'flex':'none';
      document.getElementById('gpt-input').style.display = mode==='gpt'?'flex':'none';
      document.getElementById('gemini-chat').style.display = mode==='gemini'?'flex':'none';
      document.getElementById('gemini-input').style.display = mode==='gemini'?'flex':'none';
      document.getElementById('koha-chat').style.display = mode==='koha'?'block':'none';
      renderApiBtns(mode);
      scrollToBottom();
    }

    // C√°c h√†m API Key v√† Chat gi·ªØ nguy√™n...
    function getAPIKey(type) {
      if (type==='gpt') return localStorage.getItem('openai_api_key')||'';
      if (type==='gemini') return localStorage.getItem('gemini_api_key')||'';
      return '';
    }
    function setAPIKey(type, key) {
      if (type==='gpt') localStorage.setItem('openai_api_key', key.trim());
      if (type==='gemini') localStorage.setItem('gemini_api_key', key.trim());
    }
    function removeAPIKey() {
      if (window.apiKeyType === 'gpt') localStorage.removeItem('openai_api_key');
      if (window.apiKeyType === 'gemini') localStorage.removeItem('gemini_api_key');
      document.getElementById('popup-api-key').value = '';
      alert('ƒê√£ x√≥a API key kh·ªèi tr√¨nh duy·ªát.');
      closeAPIKeyPopup();
    }
    function openAPIKeyPopup(type) {
      window.apiKeyType = type;
      const box = document.getElementById('popup-api');
      box.style.display = 'flex';
      let label = "API Key";
      let desc = "";
      let ph = "";
      if(type==='gpt') {
        label = "Nh·∫≠p OpenAI API Key (GPT)";
        desc = "T·∫°o key ·ªü <a href='https://platform.openai.com/settings/organization/api-keys' target='_blank'>https://platform.openai.com/...</a><br>(V√≠ d·ª•: sk-...)";
        ph = "sk-...";
      }
      if(type==='gemini') {
        label = "Nh·∫≠p Google Gemini API Key";
        desc = "T·∫°o key ·ªü <a href='https://aistudio.google.com/apikey' target='_blank'>https://aistudio.google.com/apikey</a><br>(V√≠ d·ª•: AIza...)";
        ph = "AIza...";
      }
      document.getElementById('popup-label').innerHTML = label;
      document.getElementById('popup-desc').innerHTML = desc + "<br>(Ch·ªâ l∆∞u tr√™n tr√¨nh duy·ªát, kh√¥ng g·ª≠i ƒëi ƒë√¢u)";
      document.getElementById('popup-api-key').placeholder = ph;
      document.getElementById('popup-api-key').value = getAPIKey(type);
      setTimeout(()=>{document.getElementById('popup-api-key').focus()}, 120);
    }
    function closeAPIKeyPopup() {document.getElementById('popup-api').style.display = 'none';}
    function saveAPIKey() {
      let val = document.getElementById('popup-api-key').value;
      if(val.length < 10) return alert('API key kh√¥ng h·ª£p l·ªá!');
      setAPIKey(window.apiKeyType, val);
      alert('ƒê√£ l∆∞u API key v√†o tr√¨nh duy·ªát!');
      closeAPIKeyPopup();
    }
    
    let gptMsgs = [], geminiMsgs = [];
    async function sendMsgGPT() {
      let key = getAPIKey('gpt');
      let msg = document.getElementById('userMsg-gpt').value.trim();
      if (!key) { openAPIKeyPopup('gpt'); return; }
      if (!msg) return;
      gptMsgs.push({role:'user',content:msg});
      renderChat('gpt-chat', gptMsgs);
      document.getElementById('userMsg-gpt').value = '';
      gptMsgs.push({role:'assistant',content:'<i>ƒêang tr·∫£ l·ªùi...</i>'});
      renderChat('gpt-chat', gptMsgs); scrollToBottom();
      try {
        let res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {'Content-Type': 'application/json','Authorization': `Bearer ${key}`},
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [{role:"system",content:"B·∫°n l√† tr·ª£ l√Ω AI h·ªçc t·∫≠p, tr·∫£ l·ªùi ng·∫Øn g·ªçn, th√¢n thi·ªán."},
              ...gptMsgs.filter(m=>m.role==='user')]
          })
        });
        let data = await res.json();
        gptMsgs.pop();
        let reply = data.choices?.[0]?.message?.content || "C√≥ l·ªói x·∫£y ra!";
        gptMsgs.push({role:'assistant',content:reply});
        renderChat('gpt-chat', gptMsgs); scrollToBottom();
      } catch (e) {gptMsgs.pop();gptMsgs.push({role:'assistant',content:'L·ªói g·ªçi API!'});renderChat('gpt-chat', gptMsgs);}
    }
    async function sendMsgGemini() {
      let key = getAPIKey('gemini');
      let msg = document.getElementById('userMsg-gemini').value.trim();
      if (!key) { openAPIKeyPopup('gemini'); return; }
      if (!msg) return;
      geminiMsgs.push({role:'user',content:msg});
      renderChat('gemini-chat', geminiMsgs);
      document.getElementById('userMsg-gemini').value = '';
      geminiMsgs.push({role:'assistant',content:'<i>ƒêang tr·∫£ l·ªùi...</i>'});
      renderChat('gemini-chat', geminiMsgs); scrollToBottom();
      try {
        let URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;
        let res = await fetch(URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({contents: [{parts: [{text: msg}]}]})
          }
        );
        let data = await res.json();
        geminiMsgs.pop();
        let reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "C√≥ l·ªói x·∫£y ra!";
        geminiMsgs.push({role:'assistant',content:reply});
        renderChat('gemini-chat', geminiMsgs); scrollToBottom();
      } catch (e) {geminiMsgs.pop();geminiMsgs.push({role:'assistant',content:'L·ªói g·ªçi API!'});renderChat('gemini-chat', geminiMsgs);}
    }
    function renderChat(boxId, msgs) {
      let html = '';
      for(let m of msgs){
        let user = (m.role==='user');
        html += `<div class="msg-row ${user?'msg-user':'msg-ai'}"><div class="msg-bubble">${m.content}</div></div>`;
      }
      document.getElementById(boxId).innerHTML = html;
    }
    function scrollToBottom() {
      setTimeout(()=>{
        document.querySelectorAll('.chat-messages').forEach(box=>{box.scrollTop = box.scrollHeight+77;});
      }, 80);
    }
    window.onload = ()=>{renderApiBtns('chatbase');}
  </script>
</body>
</html>
