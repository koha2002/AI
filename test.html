<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ xử lý PDF & Ảnh - iLovePDF API</title>
    <link rel="icon" type="image/png" href="logo.png">
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .transition-all { transition: all 0.3s ease-in-out; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .file-item { cursor: grab; }
        .file-item:active { cursor: grabbing; }
        .dragging { opacity: 0.5; }
        /* Styles for Image Preview */
        .preview-container { position: relative; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
        .preview-image { max-width: 100%; max-height: 100%; display: block; object-fit: contain; }
        #watermarkOverlay, #cropOverlay { position: absolute; pointer-events: none; }
        #cropOverlay { border: 2px dashed rgba(255, 255, 255, 0.9); box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); }
        /* FIX: Black borders for form elements */
        .form-input, .form-select, .form-color {
            border-width: 2px;
            border-color: #000000 !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    
        <header id="mini-header.html"></header>

    <main class="min-h-screen w-full flex items-center justify-center p-4">
        <div class="w-full max-w-7xl bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6 flex flex-col" style="height: calc(100vh - 4rem);">
                        <div class="text-center flex-shrink-0">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Công cụ xử lý PDF & Ảnh</h1>
                <p class="text-gray-500 mt-2">Tích hợp iLovePDF API</p>
            </div>

            <div class="flex-grow flex flex-col md:flex-row gap-8 overflow-hidden">
                                <div class="w-full md:w-1/5 lg:w-1/3 space-y-6 flex-shrink-0 overflow-y-auto pr-4">
                                        <div id="uploadBox" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center space-y-4">
                         <div class="flex justify-center"><svg class="w-12 h-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.33-2.125 5.25 5.25 0 011.065 10.91A4.5 4.5 0 0112 19.5z" /></svg></div>
                        <input type="file" id="fileInput" class="hidden" multiple>
                        <label for="fileInput" class="cursor-pointer font-semibold text-indigo-600 hover:text-indigo-500">Chọn tệp</label>
                        <p id="fileName" class="text-sm text-gray-500">Chưa có tệp nào được chọn</p>
                    </div>

                                        <div class="space-y-4">
                         <div>
                            <label for="apiTool" class="block text-sm font-medium text-gray-700">Chọn công cụ</label>
                            <select id="apiTool" class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select">
                                <optgroup label="Công cụ PDF">
                                    <option value="compress">Nén PDF</option>
                                    <option value="merge">Gộp PDF</option>
                                    <option value="split">Tách PDF</option>
                                    <option value="unlock">Mở khóa PDF</option>
                                    <option value="protect">Bảo vệ PDF</option>
                                    <option value="rotate">Xoay PDF</option>
                                    <option value="watermark">Đóng dấu PDF</option>
                                    <option value="pdfa">PDF sang PDF/A</option>
                                    <option value="wordpdf">Word sang PDF</option>
                                    <option value="powerpointpdf">PowerPoint sang PDF</option>
                                    <option value="excelpdf">Excel sang PDF</option>
                                    <option value="pdfjpg">PDF sang JPG</option>
                                    <option value="imagepdf">Ảnh sang PDF</option>
                                    <option value="pagenumber">Đánh số trang</option>
                                    <option value="extract">Trích xuất dữ liệu</option>
                                    <option value="repair">Sửa chữa PDF</option>
                                </optgroup>
                                <optgroup label="Công cụ Hình ảnh">
                                  <option value="compressimage">Nén ảnh</option>
                                    <option value="resizeimage">Thay đổi kích thước ảnh</option>
                                    <option value="cropimage">Cắt ảnh</option>
                                    <option value="rotateimage">Xoay ảnh</option>
                                    <option value="convertimage">Chuyển đổi định dạng ảnh</option>
                                    <option value="watermarkimage">Đóng dấu ảnh</option>
                                    <option value="removebackgroundimage">Xóa nền ảnh</option>
                                </optgroup>
                            </select>
                         </div>
                         
                         <div id="toolOptions" class="p-4 bg-gray-50 rounded-lg border-2 border-black hidden">
                                                     </div>
                    </div>
                </div>

                                <div class="w-full md:w-3/5 lg:w-2/3 flex flex-col overflow-hidden">
                                        <div id="fileListContainer" class="hidden mb-4 space-y-2 flex-shrink-0">
                        <h3 class="text-lg font-semibold text-gray-800">Các tệp đã chọn (kéo để sắp xếp):</h3>
                        <div id="fileList" class="bg-gray-50 rounded-lg p-3 border-2 border-black max-h-48 overflow-auto"></div>
                    </div>
                                        <div id="previewArea" class="hidden flex-grow flex items-center justify-center bg-gray-200 rounded-lg p-4 min-h-0">
                         <div class="preview-container">
                            <img id="previewImage" class="preview-image rounded" />
                            <div id="watermarkOverlay" class="flex items-center justify-center" style="white-space: normal; text-align: center; line-height: 1;"></div>
                            <div id="cropOverlay"></div>
                        </div>
                        <p id="previewInfo" class="text-sm text-gray-500 mt-2"></p>
                    </div>
                </div>
            </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t border-gray-200 pt-6 flex-shrink-0">
                <button id="clearButton" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-all">Xóa tất cả</button>
                <button id="processButton" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 col-span-2">
                    <span id="processButtonText">Xử lý</span><div id="loader" class="loader hidden"></div>
                </button>
            </div>

                        <div id="statusMessage" class="text-center font-medium h-12 flex items-center justify-center p-2 rounded-lg flex-shrink-0"></div>
            <div id="resultContainer" class="hidden mt-4 text-center flex-shrink-0">
                <h3 class="text-lg font-semibold">Xử lý thành công!</h3>
                <a id="downloadLink" href="#" class="mt-2 inline-block bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 cursor-pointer">Tải tệp kết quả</a>
            </div>
        </div>
    </main>

        <footer id="footer.html"></footer>

    <script>
        // --- DOM Elements ---
        var fileInput = document.getElementById('fileInput');
        var fileNameDisplay = document.getElementById('fileName');
        var processButton = document.getElementById('processButton');
        var clearButton = document.getElementById('clearButton');
        var apiToolSelect = document.getElementById('apiTool');
        var toolOptions = document.getElementById('toolOptions');
        var fileListContainer = document.getElementById('fileListContainer');
        var fileList = document.getElementById('fileList');
        var statusMessage = document.getElementById('statusMessage');
        var loader = document.getElementById('loader');
        var processButtonText = document.getElementById('processButtonText');
        var resultContainer = document.getElementById('resultContainer');
        var downloadLink = document.getElementById('downloadLink');
        var previewArea = document.getElementById('previewArea');
        var previewImage = document.getElementById('previewImage');
        var previewInfo = document.getElementById('previewInfo');
        var watermarkOverlay = document.getElementById('watermarkOverlay');
        var cropOverlay = document.getElementById('cropOverlay');

        // --- State Variables ---
        var selectedFiles = [];
        var watermarkFile = null;
        var downloadAuthHeader = null;
        var finalDownloadUrl = null;
        var finalDownloadFilename = null;

        // --- Config ---
        var fileAcceptMap = {
            'default': '*/*', 'pdf': 'application/pdf', 'image': 'image/*',
            'wordpdf': '.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'powerpointpdf': '.ppt,.pptx,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation',
            'excelpdf': '.xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        };
        var multiFileTools = ['merge', 'imagepdf', 'watermark', 'watermarkimage'];
        var pdfTools = ['compress', 'merge', 'split', 'unlock', 'protect', 'rotate', 'watermark', 'pdfa', 'pdfjpg', 'pagenumber', 'extract', 'repair', 'wordpdf', 'powerpointpdf', 'excelpdf'];
        var imageTools = ['compressimage', 'resizeimage', 'cropimage', 'rotateimage', 'convertimage', 'watermarkimage', 'removebackgroundimage'];
        var previewTools = ['resizeimage', 'cropimage', 'rotateimage', 'watermarkimage'];
        
        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFileSelect);
        apiToolSelect.addEventListener('change', updateUiForTool);
        processButton.addEventListener('click', processFiles);
        downloadLink.addEventListener('click', downloadResult);
        clearButton.addEventListener('click', resetAll);
        
        // --- UI Functions ---
        function setStatus(message, type) {
            if (type === undefined) { type = 'info'; }
            statusMessage.textContent = message;
            var colors = {
                info: 'text-blue-600', success: 'text-green-600', error: 'text-red-600',
            };
            statusMessage.className = 'text-center font-medium h-6 ' + (colors[type] || colors.info);
        }

        function showLoader(show) {
            loader.style.display = show ? 'block' : 'none';
            processButtonText.style.display = show ? 'none' : 'block';
            processButton.disabled = show;
        }

        function generateOptionsHTML(tool) {
            var commonClasses = "block w-full rounded-md sm:text-sm border-2 border-black";
            switch(tool) {
                case 'compress': case 'compressimage':
                    return `<label class="block text-sm font-medium">Mức độ nén</label><select id="compressionLevel" class="${commonClasses}"><option value="low">Nén thấp (chất lượng cao)</option><option value="recommended" selected>Khuyến nghị</option><option value="extreme">Nén cao (kích thước nhỏ)</option></select>`;
                case 'split':
                     return `<label class="block text-sm font-medium">Tách theo trang</label><input type="text" id="splitRange" placeholder="VD: 1-3,5,8-10" class="${commonClasses}" /><p class="text-xs text-gray-500">Nhập trang hoặc khoảng trang cần tách.</p>`;
                case 'rotate': case 'rotateimage':
                     return `<label class="block text-sm font-medium">Góc xoay</label><select id="rotateAngle" class="${commonClasses}"><option value="90">90 độ (phải)</option><option value="180">180 độ</option><option value="270">270 độ (trái)</option></select>`;
                case 'watermark': case 'watermarkimage':
                    return `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium">Loại dấu</label><select id="watermarkMode" class="${commonClasses}"><option value="text">Văn bản</option><option value="image">Hình ảnh</option></select></div>
                            <div id="watermarkTextInputContainer"><label class="block text-sm font-medium">Nội dung</label><input type="text" id="watermarkText" value="iLovePDF" class="${commonClasses}" /></div>
                            <div id="watermarkImageInputContainer" class="hidden"><label class="block text-sm font-medium">Tệp ảnh dấu</label><input type="file" id="watermarkImageInput" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept="image/*" /></div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 items-end">
                            <div><label class="block text-sm font-medium">Vị trí</label><select id="watermarkPosition" class="${commonClasses}"><option value="middle-center">Giữa</option><option value="top-left">Trên-Trái</option><option value="top-right">Trên-Phải</option><option value="bottom-left">Dưới-Trái</option><option value="bottom-right">Dưới-Phải</option></select></div>
                            <div><label class="block text-sm font-medium">Độ trong suốt</label><select id="watermarkTransparency" class="${commonClasses}"><option value="100">100%</option><option value="75">75%</option><option value="50" selected>50%</option><option value="25">25%</option></select></div>
                            <div><label class="block text-sm font-medium">Góc xoay</label><input type="number" id="watermarkRotation" value="0" class="${commonClasses}" /></div>
                        </div>
                        <div id="watermarkTextOptions" class="grid grid-cols-2 md:grid-cols-2 gap-4 items-end mt-4">
                            <div><label class="block text-sm font-medium">Cỡ chữ</label><input type="number" id="watermarkFontSize" value="48" class="${commonClasses}" /></div>
                            <div><label class="block text-sm font-medium">Màu chữ</label><input type="color" id="watermarkFontColor" value="#000000" class="block w-full rounded-md" /></div>
                        </div>
                        <div id="watermarkImageOptions" class="hidden grid-cols-2 md:grid-cols-2 gap-4 items-end mt-4">
                             <div><label class="block text-sm font-medium">Kích thước ảnh dấu (%)</label><input type="number" id="watermarkImageScale" value="50" min="1" max="500" class="${commonClasses}" /></div>
                        </div>
                    `;
                case 'protect': case 'unlock':
                    return `<label for="passwordInput" class="block text-sm font-medium">Mật khẩu</label><input type="password" id="passwordInput" class="${commonClasses}" placeholder="Nhập mật khẩu..."/>`;
                case 'cropimage':
                     return `<label class="block text-sm font-medium">Tọa độ cắt (px)</label><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><input type="number" id="cropX" placeholder="x" value="0" class="${commonClasses}" /><input type="number" id="cropY" placeholder="y" value="0" class="${commonClasses}" /><input type="number" id="cropWidth" placeholder="rộng" class="${commonClasses}" /><input type="number" id="cropHeight" placeholder="cao" class="${commonClasses}" /></div>`;
                case 'convertimage':
                     return `<label class="block text-sm font-medium">Chuyển sang định dạng</label><select id="convertTo" class="${commonClasses}"><option value="jpg">JPG</option><option value="png">PNG</option><option value="gif">GIF</option></select>`;
                case 'resizeimage':
                     return `<div class="grid grid-cols-2 gap-4"><input type="number" id="resizeWidth" placeholder="Chiều rộng (px)" class="${commonClasses}" /><input type="number" id="resizeHeight" placeholder="Chiều cao (px)" class="${commonClasses}" /></div><div class="flex items-center mt-2"><input id="maintainAspectRatio" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="maintainAspectRatio" class="ml-2 block text-sm">Giữ nguyên tỷ lệ</label></div>`;
                default:
                    var toolDescriptions = {
                        extract: 'Trích xuất toàn bộ văn bản và hình ảnh từ tệp PDF của bạn vào một tệp ZIP.',
                        repair: 'Cố gắng sửa chữa và khôi phục dữ liệu từ các tệp PDF bị hỏng.',
                        removebackgroundimage: 'Tự động xóa nền khỏi hình ảnh. Hoạt động tốt nhất với các đối tượng rõ ràng.',
                        pdfa: 'Chuyển đổi PDF sang định dạng PDF/A để lưu trữ lâu dài.',
                        pagenumber: 'Tự động thêm số trang vào tệp PDF của bạn.'
                    };
                    var desc = toolDescriptions[tool] || '';
                    return `<p class="text-sm text-gray-600">${desc}</p>`;
            }
        }

        function setupOptionEventListeners(tool) {
            if (tool === 'watermark' || tool === 'watermarkimage') {
                document.getElementById('watermarkMode').addEventListener('change', updateImagePreview);
                document.getElementById('watermarkText').addEventListener('input', updateImagePreview);
                document.getElementById('watermarkImageInput').addEventListener('change', handleWatermarkFileSelect);
                document.getElementById('watermarkPosition').addEventListener('change', updateImagePreview);
                document.getElementById('watermarkTransparency').addEventListener('change', updateImagePreview);
                document.getElementById('watermarkRotation').addEventListener('change', updateImagePreview);
                document.getElementById('watermarkFontSize').addEventListener('change', updateImagePreview);
                document.getElementById('watermarkFontColor').addEventListener('input', updateImagePreview);
                document.getElementById('watermarkImageScale').addEventListener('input', updateImagePreview);
            }
            if (tool === 'rotateimage') { document.getElementById('rotateAngle').addEventListener('change', updateImagePreview); }
            if (tool === 'cropimage') { ['cropX', 'cropY', 'cropWidth', 'cropHeight'].forEach(id => document.getElementById(id).addEventListener('input', updateImagePreview)); }
            if (tool === 'resizeimage') { ['resizeWidth', 'resizeHeight'].forEach(id => document.getElementById(id).addEventListener('input', updateImagePreview)); }
        }

        function updateUiForTool() {
            var tool = apiToolSelect.value;
            var optionsHTML = generateOptionsHTML(tool);
            toolOptions.innerHTML = optionsHTML;
            toolOptions.classList.remove('hidden');
            setupOptionEventListeners(tool);

            var acceptType = 'default';
            if (pdfTools.includes(tool)) acceptType = 'pdf';
            if (imageTools.includes(tool) || tool === 'imagepdf') acceptType = 'image';
            if (fileAcceptMap[tool]) acceptType = tool;
            fileInput.accept = fileAcceptMap[acceptType] || fileAcceptMap['default'];

            fileInput.multiple = multiFileTools.includes(tool);
            fileListContainer.style.display = fileInput.multiple && selectedFiles.length > 0 ? 'block' : 'none';
            previewArea.style.display = previewTools.includes(tool) && selectedFiles.length > 0 && selectedFiles[0].type.startsWith('image/') ? 'block' : 'none';
            updateImagePreview();
        }

        function handleFileSelect(event) {
            var newFiles = Array.from(event.target.files);
            if(fileInput.multiple) { selectedFiles = selectedFiles.concat(newFiles); } 
            else { selectedFiles = newFiles.length > 0 ? [newFiles[0]] : []; }
            
            if (selectedFiles.length === 0) {
                fileNameDisplay.textContent = 'Chưa có tệp nào được chọn';
                fileListContainer.classList.add('hidden');
            } else if (fileInput.multiple) {
                fileNameDisplay.textContent = selectedFiles.length + ' tệp đã được chọn';
                renderFileList();
                fileListContainer.classList.remove('hidden');
            } else {
                fileNameDisplay.textContent = selectedFiles[0].name;
                fileListContainer.classList.add('hidden');
            }
            
            var tool = apiToolSelect.value;
            if (previewTools.includes(tool) && selectedFiles.length > 0 && selectedFiles[0].type.startsWith('image/')) {
                previewArea.style.display = 'flex';
                updateImagePreview();
            } else {
                previewArea.style.display = 'none';
            }
            setStatus('Đã chọn tệp. Sẵn sàng để xử lý.', 'info');
        }

        function updateImagePreview() {
            var tool = apiToolSelect.value;
            if (!previewTools.includes(tool) || selectedFiles.length === 0 || !selectedFiles[0].type.startsWith('image/')) {
                previewArea.style.display = 'none';
                return;
            }
            previewArea.style.display = 'flex'; 

            var reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.style.opacity = '1';
                watermarkOverlay.style.cssText = 'position: absolute; display: flex; align-items: center; justify-content: center;';
                cropOverlay.style.cssText = 'position: absolute;';
                previewImage.style.transform = '';
                previewInfo.textContent = '';

                switch(tool) {
                    case 'watermarkimage':
                        var mode = document.getElementById('watermarkMode').value;
                        document.getElementById('watermarkTextInputContainer').style.display = mode === 'text' ? 'block' : 'none';
                        document.getElementById('watermarkImageInputContainer').style.display = mode === 'image' ? 'block' : 'none';
                        document.getElementById('watermarkTextOptions').style.display = mode === 'text' ? 'grid' : 'none';
                        document.getElementById('watermarkImageOptions').style.display = mode === 'image' ? 'grid' : 'none';

                        watermarkOverlay.style.backgroundImage = '';
                        watermarkOverlay.textContent = '';

                        if (mode === 'text') {
                            watermarkOverlay.textContent = document.getElementById('watermarkText').value;
                            watermarkOverlay.style.fontSize = document.getElementById('watermarkFontSize').value + 'px';
                            watermarkOverlay.style.color = document.getElementById('watermarkFontColor').value;
                        } else if (watermarkFile) {
                            var wmReader = new FileReader();
                            wmReader.onload = function(ev) {
                                watermarkOverlay.style.backgroundImage = 'url(' + ev.target.result + ')';
                                watermarkOverlay.style.backgroundSize = 'contain';
                                watermarkOverlay.style.backgroundPosition = 'center';
                                watermarkOverlay.style.backgroundRepeat = 'no-repeat';
                                var scale = document.getElementById('watermarkImageScale').value || 50;
                                watermarkOverlay.style.width = scale + '%';
                                watermarkOverlay.style.height = scale + '%';
                            };
                            wmReader.readAsDataURL(watermarkFile);
                        }
                        
                        var position = document.getElementById('watermarkPosition').value.split('-');
                        watermarkOverlay.style.top = position[0] === 'top' ? '5%' : position[0] === 'bottom' ? 'auto' : '50%';
                        watermarkOverlay.style.bottom = position[0] === 'bottom' ? '5%' : 'auto';
                        watermarkOverlay.style.left = position[1] === 'left' ? '5%' : position[1] === 'right' ? 'auto' : '50%';
                        watermarkOverlay.style.right = position[1] === 'right' ? '5%' : 'auto';
                        watermarkOverlay.style.transform = `translate(${position[1] === 'center' ? '-50%' : '0'}, ${position[0] === 'middle' ? '-50%' : '0'}) rotate(${document.getElementById('watermarkRotation').value}deg)`;
                        watermarkOverlay.style.opacity = document.getElementById('watermarkTransparency').value / 100;
                        break;
                    case 'rotateimage':
                        previewImage.style.transform = `rotate(${document.getElementById('rotateAngle').value}deg)`;
                        break;
                    case 'cropimage':
                        var x = parseInt(document.getElementById('cropX').value) || 0;
                        var y = parseInt(document.getElementById('cropY').value) || 0;
                        var w = parseInt(document.getElementById('cropWidth').value) || 0;
                        var h = parseInt(document.getElementById('cropHeight').value) || 0;
                        cropOverlay.style.left = x + 'px'; cropOverlay.style.top = y + 'px';
                        cropOverlay.style.width = w + 'px'; cropOverlay.style.height = h + 'px';
                        cropOverlay.style.display = (w > 0 && h > 0) ? 'block' : 'none';
                        break;
                    case 'resizeimage':
                        var width = document.getElementById('resizeWidth').value;
                        var height = document.getElementById('resizeHeight').value;
                        if (width || height) { previewInfo.textContent = `Kích thước mới: ${width || 'auto'} x ${height || 'auto'}px`; }
                        break;
                }
            };
            reader.readAsDataURL(selectedFiles[0]);
        }
        
        function handleWatermarkFileSelect(event) { watermarkFile = event.target.files[0]; updateImagePreview(); }
        
        function renderFileList() {
            let draggedItem = null;
            fileList.innerHTML = '';
            selectedFiles.forEach(function(file, index) {
                var item = document.createElement('div');
                item.className = 'file-item bg-white p-2 rounded border flex justify-between items-center';
                item.textContent = file.name;
                item.draggable = true;
                item.dataset.index = index;
                
                item.addEventListener('dragstart', function(e) { draggedItem = item; setTimeout(function() { item.classList.add('dragging'); }, 0); });
                item.addEventListener('dragend', function() { setTimeout(function() { if (draggedItem) { draggedItem.classList.remove('dragging'); } draggedItem = null; }, 0); });
                fileList.addEventListener('dragover', function(e) { e.preventDefault(); var afterElement = getDragAfterElement(fileList, e.clientY); if (afterElement == null) { fileList.appendChild(draggedItem); } else { fileList.insertBefore(draggedItem, afterElement); } });
                fileList.addEventListener('drop', function() { var newOrder = Array.from(fileList.children).map(function(child) { return selectedFiles[parseInt(child.dataset.index)]; }); selectedFiles = newOrder; renderFileList(); });

                var removeBtn = document.createElement('button');
                removeBtn.textContent = 'Xóa';
                removeBtn.className = 'text-red-500 text-xs ml-4 flex-shrink-0';
                removeBtn.onclick = function() { selectedFiles.splice(index, 1); renderFileList(); fileNameDisplay.textContent = selectedFiles.length + ' tệp đã được chọn'; };
                item.appendChild(removeBtn);
                fileList.appendChild(item);
            });
        }
        
        function getDragAfterElement(container, y) {
            var draggableElements = [...container.querySelectorAll('.file-item:not(.dragging)')];
            return draggableElements.reduce(function(closest, child) {
                var box = child.getBoundingClientRect();
                var offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } 
                else { return closest; }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function resetAll() {
            selectedFiles = []; watermarkFile = null; fileInput.value = '';
            var wmInput = document.getElementById('watermarkImageInput'); if(wmInput) wmInput.value = '';
            fileNameDisplay.textContent = 'Chưa có tệp nào được chọn';
            fileListContainer.style.display = 'none';
            resultContainer.classList.add('hidden');
            previewArea.style.display = 'none';
            setStatus('');
        }

        async function getApiToken(publicKey) {
            var response = await fetch('https://api.ilovepdf.com/v1/auth', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ public_key: publicKey }) });
            if (!response.ok) throw new Error('Lỗi lấy token xác thực.');
            var data = await response.json();
            return data.token;
        }
        
        async function processFiles() {
            if (selectedFiles.length === 0) { setStatus('Vui lòng chọn ít nhất một tệp.', 'error'); return; }
            showLoader(true);
            resultContainer.classList.add('hidden');
            var publicKey = 'project_public_b518756fab3a8e6942a9330c23a7859a_YUAga5611529e21b17310f7e19ec3547395e1';
            var tool = apiToolSelect.value;
            var apiTool = (tool === 'wordpdf' || tool === 'powerpointpdf' || tool === 'excelpdf') ? 'officepdf' : tool;

            try {
                setStatus('Đang lấy token...', 'info');
                var token = await getApiToken(publicKey);
                var authHeader = 'Bearer ' + token;

                setStatus('Đang khởi tạo tác vụ...', 'info');
                var startResponse = await fetch('https://api.ilovepdf.com/v1/start/' + apiTool, { headers: { 'Authorization': authHeader } });
                if (!startResponse.ok) throw new Error('Lỗi khởi tạo: ' + await startResponse.text());
                var taskData = await startResponse.json();

                var watermarkServerFilename = null;
                if ((apiTool === 'watermark' || apiTool === 'watermarkimage') && document.getElementById('watermarkMode').value === 'image' && watermarkFile) {
                    setStatus('Đang tải lên ảnh dấu...', 'info');
                    var wmFormData = new FormData();
                    wmFormData.append('task', taskData.task);
                    wmFormData.append('file', watermarkFile);
                    var wmUploadResponse = await fetch('https://' + taskData.server + '/v1/upload', { method: 'POST', headers: { 'Authorization': authHeader }, body: wmFormData });
                    if (!wmUploadResponse.ok) throw new Error('Lỗi tải ảnh dấu: ' + await wmUploadResponse.text());
                    var wmUploadData = await wmUploadResponse.json();
                    watermarkServerFilename = wmUploadData.server_filename;
                }

                var serverFilenames = [];
                for (var i = 0; i < selectedFiles.length; i++) {
                    setStatus('Đang tải lên tệp ' + (i + 1) + '/' + selectedFiles.length, 'info');
                    var formData = new FormData();
                    formData.append('task', taskData.task);
                    formData.append('file', selectedFiles[i]);
                    var uploadResponse = await fetch('https://' + taskData.server + '/v1/upload', { method: 'POST', headers: { 'Authorization': authHeader }, body: formData });
                    if (!uploadResponse.ok) throw new Error('Lỗi tải tệp lên: ' + await uploadResponse.text());
                    var uploadData = await uploadResponse.json();
                    serverFilenames.push({ server_filename: uploadData.server_filename, filename: selectedFiles[i].name });
                }

                setStatus('Đang xử lý tệp...', 'info');
                var processBody = { task: taskData.task, tool: apiTool, files: serverFilenames };

                switch(tool) {
                    case 'protect': case 'unlock': processBody.password = document.getElementById('passwordInput').value; break;
                    case 'split': processBody.ranges = document.getElementById('splitRange').value; break;
                    case 'rotate': case 'rotateimage': processBody.rotate = document.getElementById('rotateAngle').value; break;
                    case 'compress': case 'compressimage': processBody.compression_level = document.getElementById('compressionLevel').value; break;
                    case 'convertimage': processBody.output_format = document.getElementById('convertTo').value; break;
                    case 'resizeimage':
                        processBody.resize_mode = "pixels";
                        processBody.pixels_width = document.getElementById('resizeWidth').value;
                        processBody.pixels_height = document.getElementById('resizeHeight').value;
                        processBody.maintain_aspect_ratio = document.getElementById('maintainAspectRatio').checked;
                        break;
                    case 'cropimage':
                        processBody.coordinates = `${document.getElementById('cropX').value},${document.getElementById('cropY').value},${document.getElementById('cropWidth').value},${document.getElementById('cropHeight').value}`;
                        break;
                    case 'watermark': case 'watermarkimage':
                        processBody.mode = document.getElementById('watermarkMode').value;
                        if (processBody.mode === 'text') {
                            processBody.text = document.getElementById('watermarkText').value;
                            processBody.font_size = document.getElementById('watermarkFontSize').value;
                            processBody.font_color = document.getElementById('watermarkFontColor').value;
                        } else if (watermarkServerFilename) {
                            processBody.image = watermarkServerFilename;
                            processBody.scale = document.getElementById('watermarkImageScale').value;
                        }
                        processBody.vertical_position = document.getElementById('watermarkPosition').value.split('-')[0];
                        processBody.horizontal_position = document.getElementById('watermarkPosition').value.split('-')[1];
                        processBody.transparency = document.getElementById('watermarkTransparency').value;
                        processBody.rotation = document.getElementById('watermarkRotation').value;
                        break;
                }
                
                var processResponse = await fetch('https://' + taskData.server + '/v1/process', { method: 'POST', headers: { 'Authorization': authHeader, 'Content-Type': 'application/json' }, body: JSON.stringify(processBody) });
        _Bắt đầu đoạn code được thêm/sửa đổi_
              if (!processResponse.ok) throw new Error('Lỗi xử lý tệp: ' + await processResponse.text());
                var processData = await processResponse.json();

                if (processData.status === 'TaskSuccess') {
                    setStatus('Xử lý thành công!', 'success');
                    finalDownloadUrl = 'https://' + taskData.server + '/v1/download/' + taskData.task;
                    finalDownloadFilename = processData.download_filename;
                    downloadAuthHeader = authHeader;
                    downloadLink.textContent = 'Tải: ' + finalDownloadFilename;
                    resultContainer.classList.remove('hidden');
                } else {
                    throw new Error('Tác vụ thất bại: ' + (processData.status_text || 'Lỗi không xác định'));
                }
            } catch (error) {
                console.error('API Error:', error);
                setStatus('Lỗi: ' + error.message, 'error');
            } finally {
                showLoader(false);
            }
        }

        async function downloadResult(event) {
            event.preventDefault();
            if (!finalDownloadUrl) return;
            setStatus('Đang tải tệp về...', 'info');
            try {
                var response = await fetch(finalDownloadUrl, { headers: { 'Authorization': downloadAuthHeader } });
                if (!response.ok) throw new Error('Lỗi khi tải tệp.');
                var blob = await response.blob();
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = finalDownloadFilename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                setStatus('Tải tệp thành công!', 'success');
            } catch (error) {
                setStatus('Lỗi khi tải về: ' + error.message, 'error');
            }
        }
        
        /**
         * Bắt đầu đoạn code được thêm/sửa đổi
         */
        // --- Hàm để tải các thành phần bên ngoài (header/footer) ---
        function loadComponent(componentPath, elementId) {
            fetch(componentPath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Không thể tải ${componentPath}. Trạng thái: ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    document.getElementById(elementId).innerHTML = html;
                })
                .catch(error => {
                    console.error(`Lỗi khi tải thành phần:`, error);
                    document.getElementById(elementId).innerHTML = `<div class="text-center text-red-500 bg-red-100 p-2">Lỗi: Không tải được ${elementId}.</div>`;
                });
        }

        // --- Init & External Content Loading ---
        window.addEventListener('load', function() {
            updateUiForTool();
            
            // Tải header và footer
            loadComponent('mini-header.html', 'mini-header.html');
            loadComponent('footer.html', 'footer.html');
        });
        /**
         * Kết thúc đoạn code được thêm/sửa đổi
         */
    </script>
</body>
</html>
