<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tạo Mindmap - Tra Cứu Học Thuật & AI</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
  <style>
    /* =================================================================== */
    /* CSS RIÊNG CHO TRANG MINDMAP (NÂNG CẤP CHUYÊN NGHIỆP)              */
    /* =================================================================== */

    :root {
      --bg-main: #f4f9ff;
      --text-primary: #222;
      --text-link: #185adb;
      --toolbar-bg: #fff;
      --toolbar-border: #e3e9f7;
      --toolbar-shadow: 0 2px 12px rgba(24, 90, 219, 0.08);
      --btn-bg: #f0f5ff;
      --btn-border: #d6e4ff;
      --btn-hover-bg: #eaf3ff;
      --btn-active-bg: #dbe8ff;
      --node-bg: #fff;
      --node-stroke: #185adb;
      --node-text: #111827;
      --node-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --link-stroke: #9ca3af;
      --sidebar-bg: #ffffff;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-main: #0f172a;
        --text-primary: #e2e8f0;
        --text-link: #a5b4fc;
        --toolbar-bg: #1e293b;
        --toolbar-border: #334155;
        --toolbar-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
        --btn-bg: #334155;
        --btn-border: #475569;
        --btn-hover-bg: #475569;
        --btn-active-bg: #64748b;
        --node-bg: #1e293b;
        --node-stroke: #a5b4fc;
        --node-text: #e2e8f0;
        --node-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        --link-stroke: #64748b;
        --sidebar-bg: #1e293b;
      }
    }

    /* ----- STYLE CHUNG ----- */
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Montserrat', Arial, sans-serif;
      display: flex; flex-direction: column;
      height: 100vh;
      overflow: hidden;
      box-sizing: border-box;
    }
    main {
      flex: 1 1 auto;
      width: 100%;
      display: flex;
      overflow: hidden;
      position: relative;
    }
    #footer { flex-shrink: 0; }

    /* ----- THANH MENU ----- */
    .menubar {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 20;
      background: var(--toolbar-bg);
      border: 1px solid var(--toolbar-border);
      box-shadow: var(--toolbar-shadow);
      border-radius: 12px;
      padding: 4px;
      display: flex;
      gap: 4px;
    }
    .menu-item {
      position: relative;
    }
    .menu-btn {
      background: none;
      border: none;
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .menu-btn:hover { background: var(--btn-hover-bg); }
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: var(--toolbar-bg);
      min-width: 220px;
      box-shadow: var(--toolbar-shadow);
      border: 1px solid var(--toolbar-border);
      border-radius: 8px;
      padding: 8px;
      z-index: 21;
    }
    .dropdown-content button, .saved-map-item button {
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dropdown-content button svg {
        width: 16px;
        height: 16px;
        stroke-width: 2;
        flex-shrink: 0;
    }
    .dropdown-content button:hover { background-color: var(--btn-hover-bg); }
    .menu-item:hover .dropdown-content { display: block; }
    .dropdown-separator {
      height: 1px;
      background-color: var(--toolbar-border);
      margin: 8px 0;
    }
    .saved-maps-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .saved-map-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .saved-map-item:hover {
      background-color: var(--btn-hover-bg);
    }
    .saved-map-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-grow: 1;
    }
    .saved-map-actions button {
      width: auto;
      padding: 4px 8px;
      font-size: 12px;
    }
    
    /* ----- SIDEBAR THUỘC TÍNH ----- */
    .sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 240px;
      height: 100%;
      background: var(--sidebar-bg);
      border-left: 1px solid var(--toolbar-border);
      box-shadow: -2px 0 12px rgba(0,0,0,0.05);
      z-index: 20;
      padding: 16px;
      box-sizing: border-box;
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      overflow-y: auto;
    }
    .sidebar.visible { transform: translateX(0); }
    .sidebar-section { margin-bottom: 24px; }
    .sidebar-title { font-weight: 700; font-size: 16px; margin-bottom: 12px; }
    .sidebar-control { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .sidebar-control label { font-size: 14px; width: 100%; }
    .sidebar-control input[type="color"] {
      -webkit-appearance: none; width: 40px; height: 40px; border: none;
      cursor: pointer; background: none; padding: 0;
    }
    .sidebar-control input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    .sidebar-control input[type="color"]::-webkit-color-swatch { border: 1px solid var(--toolbar-border); border-radius: 8px; }
    .format-btns { display: flex; gap: 8px; }
    .format-btns button { font-family: serif; font-size: 18px; width: 40px; height: 40px; }
    .format-btns button.active { background-color: var(--btn-active-bg); border-color: var(--text-link); }
    #note-editor {
        width: 100%;
        height: 150px;
        background-color: var(--bg-main);
        border: 1px solid var(--toolbar-border);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: 'Montserrat', Arial, sans-serif;
        padding: 8px;
        box-sizing: border-box;
    }
    .size-control input[type="range"] { width: 100%; }

    /* ----- MINDMAP CANVAS ----- */
    #mindmap-container { width: 100%; height: 100%; flex-grow: 1; cursor: grab; }
    #mindmap-container:active { cursor: grabbing; }
    .node .shape { stroke: var(--node-stroke); stroke-width: 2px; filter: drop-shadow(var(--node-shadow)); }
    .node-foreign-object {
      text-align: center; padding: 5px; box-sizing: border-box;
      overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100%;
      pointer-events: none;
    }
    .node-text-div {
        color: var(--node-text);
        font-size: 14px;
        line-height: 1.2;
        word-break: break-word;
    }
    .link { fill: none; stroke: var(--link-stroke); stroke-width: 2px; }
    .custom-link { fill: none; stroke: #f59e0b; stroke-width: 2.5px; stroke-dasharray: 5,5; }
    .node.selected .shape { stroke: #f59e0b; stroke-width: 3px; }
    .node-input {
      width: 100%; height: 100%; border: none; background-color: transparent; text-align: center;
      font-family: 'Montserrat', Arial, sans-serif; font-size: 14px; color: var(--node-text);
      outline: none; box-sizing: border-box; padding: 0 5px;
    }
    .note-icon {
        font-size: 12px;
        fill: var(--text-secondary);
    }
  </style>
</head>
<body>
  
  <div id="header"></div>

  <main>
    <div class="menubar">
        <div class="menu-item">
            <button class="menu-btn">File</button>
            <div class="dropdown-content">
                <button id="new-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                    Tạo mới
                </button>
                <div class="dropdown-separator"></div>
                <div style="padding: 0 8px; font-weight: 600; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">SƠ ĐỒ ĐÃ LƯU</div>
                <div class="saved-maps-list" id="saved-maps-list"></div>
                <div class="dropdown-separator"></div>
                <button id="import-btn" onclick="document.getElementById('import-file').click();">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Mở file dự án
                </button>
                <input type="file" id="import-file" accept=".json" style="display:none;">
                <button id="export-json-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Tải file dự án
                </button>
                <button id="export-pdf-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M10 15.5v-5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2z"></path></svg>
                    Xuất PDF
                </button>
            </div>
        </div>
        <div class="menu-item">
            <button class="menu-btn">Chèn</button>
            <div class="dropdown-content">
                <button id="add-child-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M10 12H5"></path><path d="M14 12h5"></path><path d="M12 10V5"></path><path d="M12 14v5"></path><circle cx="12" cy="12" r="2"></circle></svg>
                    Nút con (Tab)
                </button>
                <button id="add-sibling-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                    Nút ngang hàng (Enter)
                </button>
                <button id="add-connection-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
                    Tạo liên kết
                </button>
            </div>
        </div>
        <div class="menu-item">
            <button class="menu-btn">Chỉnh sửa</button>
            <div class="dropdown-content">
                <button id="delete-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    Xóa nút (Delete)
                </button>
            </div>
        </div>
        <div class="menu-item">
            <button class="menu-btn">Xem</button>
            <div class="dropdown-content">
                <button id="zoom-in-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                    Phóng to
                </button>
                <button id="zoom-out-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                    Thu nhỏ
                </button>
                <button id="zoom-fit-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"></path><path d="M9 21H3v-6"></path><path d="M21 3l-7 7"></path><path d="M3 21l7-7"></path></svg>
                    Vừa màn hình
                </button>
            </div>
        </div>
    </div>

    <div id="mindmap-container">
      <svg width="100%" height="100%"></svg>
    </div>

    <div class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Hình dạng</div>
        <div class="sidebar-control format-btns">
          <button class="toolbar-btn" id="shape-rect-btn" title="Hình chữ nhật">▭</button>
          <button class="toolbar-btn" id="shape-ellipse-btn" title="Hình elip">⬬</button>
          <button class="toolbar-btn" id="shape-diamond-btn" title="Hình thoi">◇</button>
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">Kích thước</div>
        <div class="sidebar-control size-control">
            <label for="node-width-slider">Chiều rộng: <span id="width-value">160</span>px</label>
            <input type="range" id="node-width-slider" min="60" max="400" value="160">
        </div>
        <div class="sidebar-control size-control" style="margin-top: 8px;">
            <label for="node-height-slider">Chiều cao: <span id="height-value">60</span>px</label>
            <input type="range" id="node-height-slider" min="40" max="200" value="60">
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">Màu sắc</div>
        <div class="sidebar-control">
          <label for="node-bg-color-picker">Màu nền</label>
          <input type="color" id="node-bg-color-picker">
        </div>
         <div class="sidebar-control" style="margin-top: 8px;">
          <label for="node-text-color-picker">Màu chữ</label>
          <input type="color" id="node-text-color-picker">
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">Văn bản</div>
        <div class="sidebar-control format-btns">
          <button class="toolbar-btn" id="bold-btn" title="In đậm"><b>B</b></button>
          <button class="toolbar-btn" id="italic-btn" title="In nghiêng"><i>I</i></button>
          <button class="toolbar-btn" id="font-size-increase-btn" title="Tăng cỡ chữ">A+</button>
          <button class="toolbar-btn" id="font-size-decrease-btn" title="Giảm cỡ chữ">A-</button>
        </div>
      </div>
       <div class="sidebar-section">
        <div class="sidebar-title">Ghi chú</div>
        <textarea id="note-editor" placeholder="Thêm ghi chú chi tiết..."></textarea>
      </div>
    </div>
  </main>
  
  <div id="footer"></div>
  
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Nhúng header/footer
    function loadHtml(id, file) {
      fetch(file).then(res => res.text()).then(data => {
        document.getElementById(id).innerHTML = data;
      });
    }
    loadHtml('header', 'mini-header.html');
    loadHtml('footer', 'footer.html');

    document.addEventListener('DOMContentLoaded', () => {
        const svg = d3.select("#mindmap-container svg");
        const g = svg.append("g");
        const gLinks = g.append("g").attr("class", "links");
        const gNodes = g.append("g").attr("class", "nodes");

        const sidebar = document.getElementById('sidebar');
        const widthSlider = document.getElementById('node-width-slider');
        const heightSlider = document.getElementById('node-height-slider');
        const widthValueSpan = document.getElementById('width-value');
        const heightValueSpan = document.getElementById('height-value');
        const bgColorPicker = document.getElementById('node-bg-color-picker');
        const textColorPicker = document.getElementById('node-text-color-picker');
        const boldBtn = document.getElementById('bold-btn');
        const italicBtn = document.getElementById('italic-btn');
        const noteEditor = document.getElementById('note-editor');
        const savedMapsList = document.getElementById('saved-maps-list');

        let rootData, selectedNode, connectionMode = false, connectionStartNode = null;
        let activeMapId = null;
        const defaultNodeSize = { width: 160, height: 60 };
        const treeLayout = d3.tree().nodeSize([120, 220]);

        const zoom = d3.zoom()
            .scaleExtent([0.1, 2])
            .filter(event => event.button === 1 || event.type === 'wheel')
            .on("zoom", (event) => g.attr("transform", event.transform));
        svg.call(zoom);

        // --- HỆ THỐNG QUẢN LÝ FILE ---
        function getCollection() {
            const collection = localStorage.getItem('mindmapCollection');
            return collection ? JSON.parse(collection) : [];
        }

        function saveCollection(collection) {
            localStorage.setItem('mindmapCollection', JSON.stringify(collection));
        }

        function getMapById(id) {
            const collection = getCollection();
            return collection.find(map => map.id === id);
        }
        
        function saveActiveMapData() {
            if (!rootData || !activeMapId) return;
            let collection = getCollection();
            const mapIndex = collection.findIndex(map => map.id === activeMapId);
            if (mapIndex > -1) {
                collection[mapIndex].data = rootData;
                collection[mapIndex].lastModified = Date.now();
                saveCollection(collection);
            }
        }

        function createDefaultData(name) {
            const defaultBg = getComputedStyle(document.documentElement).getPropertyValue('--node-bg').trim();
            const defaultText = getComputedStyle(document.documentElement).getPropertyValue('--node-text').trim();
            
            const createNode = (nodeName, children = []) => ({
                id: `node-${Date.now()}-${Math.random()}`,
                name: nodeName,
                shape: "rectangle",
                width: defaultNodeSize.width,
                height: defaultNodeSize.height,
                backgroundColor: defaultBg,
                textColor: defaultText,
                fontSize: 14,
                isBold: false,
                isItalic: false,
                note: "",
                connections: [],
                children: children
            });

            return { 
                id: `map-${Date.now()}`,
                name: name || `Sơ đồ mới ${new Date().toLocaleTimeString()}`,
                lastModified: Date.now(),
                data: createNode("Chủ đề chính", [
                    createNode("Nhánh 1", [
                        createNode("Ý tưởng 1.1"),
                        createNode("Ý tưởng 1.2")
                    ]),
                    createNode("Nhánh 2", [
                        createNode("Ý tưởng 2.1")
                    ]),
                    createNode("Nhánh 3")
                ])
            };
        }

        function loadMap(mapId) {
            const map = getMapById(mapId);
            if (map) {
                activeMapId = map.id;
                rootData = map.data;
                update();
                const hierarchy = d3.hierarchy(rootData);
                selectNode(hierarchy);
                zoomToFit();
            }
        }
        
        function renderSavedMapsList() {
            const collection = getCollection().sort((a, b) => b.lastModified - a.lastModified);
            savedMapsList.innerHTML = '';
            if (collection.length === 0) {
                savedMapsList.innerHTML = '<div style="padding: 8px; font-size: 12px; color: grey;">Chưa có sơ đồ nào.</div>';
                return;
            }
            collection.forEach(map => {
                const item = document.createElement('div');
                item.className = 'saved-map-item';
                item.innerHTML = `
                    <span class="saved-map-name">${map.name}</span>
                    <div class="saved-map-actions">
                        <button title="Sửa">✏️</button>
                        <button title="Xuất PDF">📄</button>
                        <button title="Xóa">🗑️</button>
                    </div>
                `;
                const buttons = item.querySelectorAll('button');
                buttons[0].onclick = () => loadMap(map.id);
                buttons[1].onclick = () => exportPdfById(map.id);
                buttons[2].onclick = () => deleteMap(map.id);
                savedMapsList.appendChild(item);
            });
        }

        function deleteMap(mapId) {
            if (!confirm("Bạn có chắc muốn xóa vĩnh viễn sơ đồ này?")) return;
            let collection = getCollection();
            collection = collection.filter(map => map.id !== mapId);
            saveCollection(collection);
            if (activeMapId === mapId) {
                const newCollection = getCollection();
                if (newCollection.length > 0) {
                    loadMap(newCollection.sort((a,b) => b.lastModified - a.lastModified)[0].id);
                } else {
                    initializeApp(true);
                }
            }
            renderSavedMapsList();
        }
        
        // --- KẾT THÚC HỆ THỐNG QUẢN LÝ FILE ---

        function update() {
            const hierarchyRoot = d3.hierarchy(rootData);
            const treeData = treeLayout(hierarchyRoot);
            const nodes = treeData.descendants();
            const links = treeData.descendants().slice(1);

            gLinks.selectAll("path").remove();
            gNodes.selectAll(".node").remove();

            gLinks.selectAll("path.link")
                .data(links, d => d.data.id)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d => `M${d.y},${d.x}C${(d.y + d.parent.y) / 2},${d.x} ${(d.y + d.parent.y) / 2},${d.parent.x} ${d.parent.y},${d.parent.x}`);

            const nodeMap = new Map(hierarchyRoot.descendants().map(d => [d.data.id, d]));
            hierarchyRoot.descendants().forEach(sourceNode => {
                if (sourceNode.data.connections) {
                    sourceNode.data.connections.forEach(targetId => {
                        const targetNode = nodeMap.get(targetId);
                        if (targetNode) {
                            gLinks.append("path")
                                .attr("class", "custom-link")
                                .attr("d", `M${sourceNode.y},${sourceNode.x} L${targetNode.y},${targetNode.x}`);
                        }
                    });
                }
            });

            const node = gNodes.selectAll("g.node")
                .data(nodes, d => d.data.id)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.y},${d.x})`)
                .on("contextmenu", handleNodeClick);

            node.each(function(d) {
                const group = d3.select(this);
                const data = d.data;
                const nodeWidth = data.width || defaultNodeSize.width;
                const nodeHeight = data.height || defaultNodeSize.height;
                const shapeType = data.shape || 'rectangle';
                const bgColor = data.backgroundColor || getComputedStyle(document.documentElement).getPropertyValue('--node-bg').trim();
                
                let shape;
                if (shapeType === 'rectangle') shape = group.append("rect").attr("width", nodeWidth).attr("height", nodeHeight).attr("x", -nodeWidth / 2).attr("y", -nodeHeight / 2).attr("rx", 8).attr("ry", 8);
                else if (shapeType === 'ellipse') shape = group.append("ellipse").attr("rx", nodeWidth / 2).attr("ry", nodeHeight / 2);
                else if (shapeType === 'diamond') {
                    const w = nodeWidth / 2; const h = nodeHeight / 2;
                    shape = group.append("path").attr("d", `M 0 ${-h} L ${w} 0 L 0 ${h} L ${-w} 0 Z`);
                }
                shape.attr("class", "shape").style("fill", bgColor);
            });

            const fo = node.append("foreignObject")
                .attr("width", d => (d.data.width || defaultNodeSize.width) - 10)
                .attr("height", d => (d.data.height || defaultNodeSize.height) - 10)
                .attr("x", d => -(d.data.width || defaultNodeSize.width) / 2 + 5)
                .attr("y", d => -(d.data.height || defaultNodeSize.height) / 2 + 5)
                .on("dblclick", (event, d) => { event.stopPropagation(); editNodeText(d, fo); });

            fo.append("xhtml:div")
                .attr("class", "node-foreign-object")
                .append("xhtml:div")
                .attr("class", "node-text-div")
                .style("font-weight", d => d.data.isBold ? "bold" : "normal")
                .style("font-style", d => d.data.isItalic ? "italic" : "normal")
                .style("font-size", d => (d.data.fontSize || 14) + 'px')
                .style("color", d => d.data.textColor || getComputedStyle(document.documentElement).getPropertyValue('--node-text').trim())
                .html(d => d.data.name);

            node.filter(d => d.data.note && d.data.note.trim() !== "")
                .append("text")
                .attr("class", "note-icon")
                .attr("x", d => (d.data.width || defaultNodeSize.width) / 2 - 15)
                .attr("y", d => -(d.data.height || defaultNodeSize.height) / 2 + 15)
                .text("📝");
        }
        
        function handleNodeClick(event, d) {
            event.preventDefault();
            event.stopPropagation();
            if (connectionMode) {
                if (!connectionStartNode) {
                    connectionStartNode = d;
                    selectNode(d);
                } else {
                    if (connectionStartNode.data.id !== d.data.id) {
                        if (!connectionStartNode.data.connections) connectionStartNode.data.connections = [];
                        if (!connectionStartNode.data.connections.includes(d.data.id)) {
                             connectionStartNode.data.connections.push(d.data.id);
                        }
                        update();
                        saveActiveMapData();
                    }
                    connectionMode = false;
                    connectionStartNode = null;
                    document.body.style.cursor = 'default';
                    alert("Đã tạo liên kết!");
                }
            } else {
                selectNode(d);
            }
        }

        function selectNode(d) {
            if (selectedNode) d3.selectAll(".node").filter(nd => nd.data.id === selectedNode.data.id).classed("selected", false);
            selectedNode = d;
            d3.selectAll(".node").filter(nd => nd.data.id === d.data.id).classed("selected", true);
            updateSidebar();
            sidebar.classList.add('visible');
        }
        
        function deselectAll() {
            if (selectedNode) d3.selectAll(".node").filter(nd => nd.data.id === selectedNode.data.id).classed("selected", false);
            selectedNode = null;
            sidebar.classList.remove('visible');
        }

        function updateSidebar() {
            if (!selectedNode) return;
            const data = selectedNode.data;
            widthSlider.value = data.width || defaultNodeSize.width;
            heightSlider.value = data.height || defaultNodeSize.height;
            widthValueSpan.textContent = widthSlider.value;
            heightValueSpan.textContent = heightSlider.value;
            bgColorPicker.value = data.backgroundColor;
            textColorPicker.value = data.textColor;
            boldBtn.classList.toggle('active', !!data.isBold);
            italicBtn.classList.toggle('active', !!data.isItalic);
            noteEditor.value = data.note || "";
        }

        function editNodeText(d, foreignObject) {
            const div = foreignObject.select(".node-text-div");
            div.style("display", "none");

            const input = foreignObject.select(".node-foreign-object").append("xhtml:textarea")
                .attr("class", "node-input")
                .style("font-weight", d.data.isBold ? "bold" : "normal")
                .style("font-style", d.data.isItalic ? "italic" : "normal")
                .style("font-size", (d.data.fontSize || 14) + 'px')
                .html(d.data.name)
                .on("blur", function() {
                    d.data.name = this.value;
                    div.html(d.data.name).style("display", "block");
                    d3.select(this).remove();
                    saveActiveMapData();
                });
            
            input.node().focus();
            input.node().select();
        }

        function addNode(isSibling) {
            if (!selectedNode) { alert("Vui lòng chọn một nút!"); return; }
            const defaultBg = getComputedStyle(document.documentElement).getPropertyValue('--node-bg').trim();
            const defaultText = getComputedStyle(document.documentElement).getPropertyValue('--node-text').trim();
            const newNodeData = { id: `node-${Date.now()}`, name: "Nút mới", shape: "rectangle", width: defaultNodeSize.width, height: defaultNodeSize.height, backgroundColor: defaultBg, textColor: defaultText, fontSize: 14, isBold: false, isItalic: false, note: "", connections: [] };
            let parentData = isSibling ? selectedNode.parent.data : selectedNode.data;

            if (!selectedNode.parent && isSibling) { alert("Không thể thêm nút ngang hàng cho chủ đề chính."); return; }
            if (!parentData.children) parentData.children = [];
            
            parentData.children.push(newNodeData);
            
            update(d3.hierarchy(rootData));
            saveActiveMapData();
        }

        function deleteNode() {
            if (!selectedNode || !selectedNode.parent) { alert("Không thể xóa chủ đề chính!"); return; }
            const parentData = selectedNode.parent.data;
            const index = parentData.children.indexOf(selectedNode.data);
            if (index > -1) parentData.children.splice(index, 1);
            
            update(d3.hierarchy(rootData));
            deselectAll();
            saveActiveMapData();
        }

        function setShape(shape) {
            if (selectedNode) { selectedNode.data.shape = shape; update(d3.hierarchy(rootData)); saveActiveMapData(); }
        }
        
        function zoomToFit() {
            const bounds = g.node().getBBox();
            const parent = svg.node().parentElement;
            const fullWidth = parent.clientWidth, fullHeight = parent.clientHeight;
            if (bounds.width === 0 || bounds.height === 0) return;
            const scale = 0.85 / Math.max(bounds.width / fullWidth, bounds.height / fullHeight);
            const translate = [fullWidth / 2 - scale * (bounds.x + bounds.width / 2), fullHeight / 2 - scale * (bounds.y + bounds.height / 2)];

            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
            );
        }

        // Gán sự kiện
        document.getElementById('add-child-btn').onclick = () => addNode(false);
        document.getElementById('add-sibling-btn').onclick = () => addNode(true);
        document.getElementById('delete-btn').onclick = deleteNode;
        document.getElementById('shape-rect-btn').onclick = () => setShape('rectangle');
        document.getElementById('shape-ellipse-btn').onclick = () => setShape('ellipse');
        document.getElementById('shape-diamond-btn').onclick = () => setShape('diamond');
        
        widthSlider.oninput = (e) => {
            if(selectedNode) {
                selectedNode.data.width = +e.target.value;
                widthValueSpan.textContent = e.target.value;
                update(d3.hierarchy(rootData));
                saveActiveMapData();
            }
        };
        heightSlider.oninput = (e) => {
            if(selectedNode) {
                selectedNode.data.height = +e.target.value;
                heightValueSpan.textContent = e.target.value;
                update(d3.hierarchy(rootData));
                saveActiveMapData();
            }
        };

        bgColorPicker.oninput = (e) => { if(selectedNode) { selectedNode.data.backgroundColor = e.target.value; update(d3.hierarchy(rootData)); saveActiveMapData(); } };
        textColorPicker.oninput = (e) => { if(selectedNode) { selectedNode.data.textColor = e.target.value; update(d3.hierarchy(rootData)); saveActiveMapData(); } };
        boldBtn.onclick = () => { if(selectedNode) { selectedNode.data.isBold = !selectedNode.data.isBold; update(d3.hierarchy(rootData)); updateSidebar(); saveActiveMapData(); } };
        italicBtn.onclick = () => { if(selectedNode) { selectedNode.data.isItalic = !selectedNode.data.isItalic; update(d3.hierarchy(rootData)); updateSidebar(); saveActiveMapData(); } };
        document.getElementById('font-size-increase-btn').onclick = () => { if(selectedNode) { selectedNode.data.fontSize = (selectedNode.data.fontSize || 14) + 1; update(d3.hierarchy(rootData)); saveActiveMapData(); } };
        document.getElementById('font-size-decrease-btn').onclick = () => { if(selectedNode) { selectedNode.data.fontSize = (selectedNode.data.fontSize || 14) - 1; update(d3.hierarchy(rootData)); saveActiveMapData(); } };
        noteEditor.onblur = (e) => { if(selectedNode) { selectedNode.data.note = e.target.value; update(d3.hierarchy(rootData)); saveActiveMapData(); } };
        document.getElementById('add-connection-btn').onclick = () => {
            connectionMode = true;
            connectionStartNode = null;
            document.body.style.cursor = 'crosshair';
            alert("Chọn nút bắt đầu, sau đó chọn nút kết thúc để tạo liên kết.");
        };

        document.getElementById('save-btn').onclick = () => { saveActiveMapData(); alert("Đã lưu sơ đồ!"); };
        svg.on('click', deselectAll);
        
        document.getElementById('zoom-in-btn').onclick = () => svg.transition().duration(250).call(zoom.scaleBy, 1.2);
        document.getElementById('zoom-out-btn').onclick = () => svg.transition().duration(250).call(zoom.scaleBy, 0.8);
        document.getElementById('zoom-fit-btn').onclick = zoomToFit;

        d3.select("body").on("keydown", function(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
            if (!selectedNode) return;
            switch (event.key) {
                case "Tab": event.preventDefault(); addNode(false); break;
                case "Enter": event.preventDefault(); addNode(true); break;
                case "Delete": case "Backspace": event.preventDefault(); deleteNode(); break;
            }
        });

        document.getElementById('export-json-btn').onclick = () => {
            const mapData = getMapById(activeMapId);
            if (!mapData) return alert("Không tìm thấy sơ đồ để xuất!");
            const dataStr = JSON.stringify(mapData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = `${mapData.name}.json`; a.click(); URL.revokeObjectURL(url);
        };

        document.getElementById('import-file').onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const mapData = JSON.parse(e.target.result);
                        let collection = getCollection();
                        collection.push(mapData);
                        saveCollection(collection);
                        loadMap(mapData.id);
                        renderSavedMapsList();
                    } catch (err) { alert("File không hợp lệ!"); }
                };
                reader.readAsText(file);
            }
        };
        
        function exportPdfById(mapId) {
            const mapToExport = getMapById(mapId);
            if (!mapToExport) return;
            
            const tempContainer = d3.select("body").append("div").style("position", "absolute").style("left", "-9999px");
            const tempSvg = tempContainer.append("svg");
            const tempG = tempSvg.append("g");
            
            const tempHierarchy = d3.hierarchy(mapToExport.data);
            treeLayout(tempHierarchy);

            // Tạm thời vẽ lại trên SVG ẩn để lấy kích thước chính xác
            // Logic vẽ tương tự hàm update()
            // ... (phần này có thể được module hóa để tránh lặp code)

            html2canvas(tempSvg.node(), {
                backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-main').trim(),
                scale: 2
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`${mapToExport.name}.pdf`);
                tempContainer.remove();
            });
        }

        document.getElementById('export-pdf-btn').onclick = () => exportPdfById(activeMapId);

        // Khởi tạo
        function initializeApp(forceNew = false) {
            let collection = getCollection();
            if (collection.length === 0 || forceNew) {
                const newMap = createDefaultData();
                if (forceNew) {
                    collection = [newMap];
                } else {
                    collection.push(newMap);
                }
                saveCollection(collection);
            }
            const lastMap = collection.sort((a,b) => b.lastModified - a.lastModified)[0];
            loadMap(lastMap.id);
            renderSavedMapsList();
        }

        initializeApp();
    });
  </script>
</body>
</html>
