<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>AI build by KoHa</title>
  <meta name="color-scheme" content="dark light">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      color-scheme: dark light;
      background-color: Canvas;
      color: CanvasText;
      overflow: hidden;
    }
    body {
      width: 100vw;
      height: 100vh;
    }
    .chat-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }
    .chat-header {
      background: inherit;
      color: inherit;
      font-size: 27px;
      font-weight: 700;
      text-align: left;
      padding: 22px 2vw 14px 2vw;
      letter-spacing: 1.2px;
      border-bottom: 1px solid ButtonBorder;
      flex: 0 0 auto;
      z-index: 1;
      width: 100%;
    }
    .chat-body {
      flex: 1 1 auto;
      background: transparent;
      padding: 18px 0 18px 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
      width: 100vw;
    }
    .message {
      display: flex;
      flex-direction: column;
      width: 100vw;
      max-width: 100vw;
      border-radius: 0;
      padding: 16px 0;
      font-size: 18px;
      line-height: 1.7;
      word-break: break-word;
      position: relative;
      font-family: 'Roboto', Arial, sans-serif;
      font-weight: 400;
      background: transparent;
      color: inherit;
    }
    .message.user {
      background: color-mix(in srgb, AccentColor 85%, transparent 15%);
      color: #fff;
      text-align: right;
      border-bottom: 1px solid ButtonBorder;
      border-top: 1px solid ButtonBorder;
      padding-right: 3vw;
      padding-left: 25vw;
    }
    .message.ai {
      background: color-mix(in srgb, ButtonFace 92%, transparent 8%);
      color: AccentColorText;
      text-align: left;
      border-bottom: 1px solid ButtonBorder;
      border-top: 1px solid ButtonBorder;
      padding-left: 3vw;
      padding-right: 25vw;
    }
    .ai-label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 7px;
      color: Highlight;
      letter-spacing: 1px;
    }
    .message .img-msg {
      margin-top: 10px;
      max-width: 320px;
      border-radius: 10px;
      border: 1.5px solid ButtonBorder;
      box-shadow: 0 2px 10px #0003;
      display: block;
      background: ButtonFace;
    }
    .chat-footer {
      background: inherit;
      border-top: 1px solid ButtonBorder;
      flex: 0 0 auto;
      z-index: 2;
      width: 100vw;
      padding: 18px 2vw;
      display: flex;
      align-items: center;
      gap: 0;
      box-sizing: border-box;
    }
    .chat-footer input[type="text"] {
      width: 100%;
      padding: 15px 18px;
      border-radius: 9px;
      border: none;
      outline: none;
      background: ButtonFace;
      color: ButtonText;
      font-size: 18px;
      font-family: 'Roboto', Arial, sans-serif;
      font-weight: 400;
      box-shadow: 0 1px 4px #0001 inset;
      margin: 0;
    }
    ::placeholder {
      color: GrayText;
      opacity: 1;
      font-size: 18px;
    }
    @media (max-width: 650px) {
      .chat-header, .chat-footer { font-size: 18px; padding-left: 3vw; padding-right: 3vw;}
      .message.user, .message.ai { padding-left: 8vw; padding-right: 8vw;}
      .chat-footer input[type="text"] { font-size: 16px;}
    }
    ::-webkit-scrollbar { width: 8px;}
    ::-webkit-scrollbar-thumb { background: ButtonBorder; border-radius: 5px;}
    @media (max-width: 500px) {
      .chat-header, .chat-footer { font-size: 15px;}
      .chat-footer input[type="text"] { font-size: 14px;}
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">AI do KoHa phát triển</div>
    <div class="chat-body" id="chatBody">
      <div style="text-align:center; margin-top:24px; color:Highlight; font-size:22px; font-family:'Roboto',Arial,sans-serif;">
        <div style="margin-bottom:11px; opacity:0.92; font-size:14px;">AI do KoHa phát triển</div>
        <div style="font-weight:500;">Bạn muốn hỏi gì?</div>
      </div>
    </div>
    <form class="chat-footer" onsubmit="sendMessage();return false;">
      <input type="text" id="userInput" placeholder="Nhập nội dung, ấn Enter để gửi..." autocomplete="off" />
    </form>
  </div>
  <script>
    // Đổi API key của bạn tại đây
    const apiKey = "sk-StT0_IrHaLUzYqrMOxPlxg";
    const chatBody = document.getElementById('chatBody');
    const userInput = document.getElementById('userInput');
    const STORAGE_KEY = 'koha_ai_chat_history_v1';
    let uploadedImage = null; // Nếu cần sau này

    // Xử lý text sạch đẹp
    function cleanText(text) {
      if (!text) return "";
      text = text.replace(/(\*\*|__)/g, '');
      text = text.replace(/---+/g, '');
      text = text.replace(/\n/g, '<br>');
      text = text.replace(/^(<br>)+/, '').replace(/(<br>)+$/, '');
      return text.trim();
    }

    // Thêm tin nhắn vào DOM
    function appendMessage(role, text, imgSrc = null) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + role;
      if (role === 'ai') {
        msgDiv.innerHTML = `<div class="ai-label">AI do KoHa phát triển</div>` +
          (text ? `<div>${text}</div>` : '');
      } else {
        msgDiv.innerHTML = text ? text : '';
      }
      if (imgSrc) {
        const img = document.createElement('img');
        img.src = imgSrc;
        img.className = 'img-msg';
        msgDiv.appendChild(img);
      }
      chatBody.appendChild(msgDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // Lưu lịch sử vào localStorage
    function saveHistory() {
      const messages = Array.from(chatBody.querySelectorAll('.message')).map(m => {
        const role = m.classList.contains('ai') ? 'ai' : 'user';
        const textDiv = m.querySelector(role === 'ai' ? 'div:not(.ai-label)' : 'div');
        const text = textDiv ? textDiv.innerHTML : m.innerHTML;
        const img = m.querySelector('img');
        return { role, text, imgSrc: img ? img.src : null };
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    }

    // Load lịch sử từ localStorage
    function loadHistory() {
      const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      if (messages.length) {
        chatBody.innerHTML = ""; // Xóa intro mặc định
        messages.forEach(msg => {
          appendMessage(msg.role, msg.text, msg.imgSrc);
        });
      }
    }

    // Gửi tin nhắn
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text && !uploadedImage) return;
      appendMessage('user', text, uploadedImage);

      // Xoá intro nếu còn
      if (chatBody.firstElementChild && chatBody.children.length > 1 &&
          chatBody.firstElementChild.innerText.includes("Bạn muốn hỏi gì")) {
        chatBody.removeChild(chatBody.firstElementChild);
      }

      appendMessage('ai', '<i>Đang xử lý...</i>');
      userInput.value = '';
      chatBody.scrollTop = chatBody.scrollHeight;
      saveHistory();

      let contentArr = [];
      if (text) contentArr.push({ type: "text", text: text });
      if (uploadedImage) contentArr.push({ type: "image_url", image_url: { url: uploadedImage } });

      if (!contentArr.length) {
        chatBody.removeChild(chatBody.lastChild);
        saveHistory();
        return;
      }

      const messages = [
        { role: "user", content: contentArr }
      ];

      try {
        const response = await fetch("https://inference.nebulablock.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + apiKey,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            messages,
            model: "openai/gpt-4o-mini",
            max_tokens: 1500,
            temperature: 1,
            top_p: 0.9,
            stream: false
          })
        });
        const result = await response.json();
        chatBody.removeChild(chatBody.lastChild);

        if (result.choices && result.choices[0] && result.choices[0].message && result.choices[0].message.content) {
          const aiContent = cleanText(result.choices[0].message.content);
          appendMessage('ai', aiContent);
        } else if (result.error) {
          appendMessage('ai', 'Lỗi: ' + JSON.stringify(result.error));
        } else {
          appendMessage('ai', 'Lỗi: Không có phản hồi hợp lệ!');
        }
      } catch (e) {
        chatBody.removeChild(chatBody.lastChild);
        appendMessage('ai', 'Lỗi: ' + e.message);
      }
      uploadedImage = null;
      saveHistory();
    }

    // Gửi bằng Enter
    userInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') sendMessage();
    });

    // Tải lịch sử khi load lại trang
    loadHistory();

    // Tự động lưu khi đóng tab/trình duyệt
    window.addEventListener('beforeunload', saveHistory);
  </script>
</body>
</html>
