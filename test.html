<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ xử lý PDF & Ảnh - iLovePDF API</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Sử dụng font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .file-item { cursor: grab; }
        .file-item:active { cursor: grabbing; }
        .dragging { opacity: 0.5; }
        /* Styles for Image Preview */
        .preview-container { position: relative; display: inline-block; max-width: 100%; }
        .preview-image { max-width: 100%; max-height: 300px; display: block; }
        #watermarkOverlay, #cropOverlay { position: absolute; pointer-events: none; }
        #cropOverlay { border: 2px dashed rgba(255, 255, 255, 0.7); box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); }
        /* Dark mode form fixes */
        .dark .form-input, .dark .form-select {
            background-color: #f3f4f6; /* gray-100 */
            color: #111827; /* gray-900 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    
    <!-- Header Placeholder -->
    <header id="page-header"></header>

    <main class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-4xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
            <!-- Logo and Title -->
            <div class="text-center">
                 <img id="logo" src="logo.png" alt="Logo" class="mx-auto h-16 w-auto" onerror="this.style.display='none'">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mt-4">Công cụ xử lý PDF & Ảnh</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Tích hợp iLovePDF API</p>
            </div>

            <!-- Upload Area -->
            <div id="uploadBox" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-6 text-center space-y-4">
                 <div class="flex justify-center"><svg class="w-12 h-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.33-2.125 5.25 5.25 0 011.065 10.91A4.5 4.5 0 0112 19.5z" /></svg></div>
                <input type="file" id="fileInput" class="hidden" multiple>
                <label for="fileInput" class="cursor-pointer font-semibold text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">Chọn tệp</label>
                <p id="fileName" class="text-sm text-gray-500 dark:text-gray-400">Chưa có tệp nào được chọn</p>
            </div>
            
            <!-- File List for multi-file tools -->
            <div id="fileListContainer" class="hidden mt-4 space-y-2">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Các tệp đã chọn (kéo để sắp xếp):</h3>
                <div id="fileList" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 border border-gray-200 dark:border-gray-600 max-h-60 overflow-auto"></div>
            </div>

            <!-- Image Preview Area -->
            <div id="previewArea" class="hidden text-center">
                <div class="preview-container mx-auto">
                    <img id="previewImage" class="preview-image rounded" />
                    <div id="watermarkOverlay"></div>
                    <div id="cropOverlay"></div>
                </div>
                <p id="previewInfo" class="text-sm text-gray-500 mt-2"></p>
            </div>

            <!-- API Tool and Options -->
            <div class="space-y-4 border-t border-gray-200 dark:border-gray-700 pt-6">
                 <div>
                    <label for="apiTool" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Chọn công cụ</label>
                    <select id="apiTool" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select">
                        <optgroup label="Công cụ PDF">
                            <option value="compress">Nén PDF</option>
                            <option value="merge">Gộp PDF</option>
                            <option value="split">Tách PDF</option>
                            <option value="unlock">Mở khóa PDF</option>
                            <option value="protect">Bảo vệ PDF</option>
                            <option value="rotate">Xoay PDF</option>
                            <option value="watermark">Đóng dấu PDF</option>
                            <option value="pdfa">PDF sang PDF/A</option>
                            <option value="wordpdf">Word sang PDF</option>
                            <option value="powerpointpdf">PowerPoint sang PDF</option>
                            <option value="excelpdf">Excel sang PDF</option>
                            <option value="pdfjpg">PDF sang JPG</option>
                            <option value="imagepdf">Ảnh sang PDF</option>
                            <option value="pagenumber">Đánh số trang</option>
                            <option value="extract">Trích xuất dữ liệu</option>
                            <option value="repair">Sửa chữa PDF</option>
                        </optgroup>
                        <optgroup label="Công cụ Hình ảnh">
                            <option value="compressimage">Nén ảnh</option>
                            <option value="resizeimage">Thay đổi kích thước ảnh</option>
                            <option value="cropimage">Cắt ảnh</option>
                            <option value="rotateimage">Xoay ảnh</option>
                            <option value="convertimage">Chuyển đổi định dạng ảnh</option>
                            <option value="watermarkimage">Đóng dấu ảnh</option>
                            <option value="removebackgroundimage">Xóa nền ảnh</option>
                        </optgroup>
                    </select>
                 </div>
                 
                 <div id="toolOptions" class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hidden">
                    <!-- Options will be injected here by JS -->
                 </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 border-t border-gray-200 dark:border-gray-700 pt-6">
                <button id="clearButton" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-all col-span-1 sm:col-span-2 lg:col-span-1">Xóa tất cả</button>
                <button id="processButton" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 col-span-1 sm:col-span-2 lg:col-span-2">
                    <span id="processButtonText">Xử lý</span><div id="loader" class="loader hidden"></div>
                </button>
            </div>

            <!-- Status & Result -->
            <div id="statusMessage" class="text-center font-medium h-12 flex items-center justify-center p-2 rounded-lg"></div>
            <div id="resultContainer" class="hidden mt-4 text-center">
                <h3 class="text-lg font-semibold">Xử lý thành công!</h3>
                <a id="downloadLink" href="#" class="mt-2 inline-block bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 cursor-pointer">Tải tệp kết quả</a>
            </div>
        </div>
    </main>

    <!-- Footer Placeholder -->
    <footer id="page-footer"></footer>

    <script>
        // --- DOM Elements ---
        var fileInput = document.getElementById('fileInput');
        var fileNameDisplay = document.getElementById('fileName');
        var processButton = document.getElementById('processButton');
        var clearButton = document.getElementById('clearButton');
        var apiToolSelect = document.getElementById('apiTool');
        var toolOptions = document.getElementById('toolOptions');
        var fileListContainer = document.getElementById('fileListContainer');
        var fileList = document.getElementById('fileList');
        var statusMessage = document.getElementById('statusMessage');
        var loader = document.getElementById('loader');
        var processButtonText = document.getElementById('processButtonText');
        var resultContainer = document.getElementById('resultContainer');
        var downloadLink = document.getElementById('downloadLink');
        var previewArea = document.getElementById('previewArea');
        var previewImage = document.getElementById('previewImage');
        var previewInfo = document.getElementById('previewInfo');
        var watermarkOverlay = document.getElementById('watermarkOverlay');
        var cropOverlay = document.getElementById('cropOverlay');

        // --- State Variables ---
        var selectedFiles = [];
        var watermarkFile = null;
        var downloadAuthHeader = null;
        var finalDownloadUrl = null;
        var finalDownloadFilename = null;

        // --- Config ---
        var fileAcceptMap = {
            'default': '*/*', 'pdf': 'application/pdf', 'image': 'image/*',
            'wordpdf': '.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'powerpointpdf': '.ppt,.pptx,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation',
            'excelpdf': '.xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        };
        var multiFileTools = ['merge', 'imagepdf', 'watermark', 'watermarkimage'];
        var pdfTools = ['compress', 'merge', 'split', 'unlock', 'protect', 'rotate', 'watermark', 'pdfa', 'pdfjpg', 'pagenumber', 'extract', 'repair', 'wordpdf', 'powerpointpdf', 'excelpdf'];
        var imageTools = ['compressimage', 'resizeimage', 'cropimage', 'rotateimage', 'convertimage', 'watermarkimage', 'removebackgroundimage'];
        var previewTools = ['resizeimage', 'cropimage', 'rotateimage', 'watermarkimage'];
        
        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFileSelect);
        apiToolSelect.addEventListener('change', updateUiForTool);
        processButton.addEventListener('click', processFiles);
        downloadLink.addEventListener('click', downloadResult);
        clearButton.addEventListener('click', resetAll);
        
        // --- UI Functions ---
        function setStatus(message, type) { /* ... implementation from previous version ... */ }
        function showLoader(show) { /* ... implementation from previous version ... */ }

        function generateOptionsHTML(tool) {
            // This function generates the specific options for each tool
            // It returns an HTML string to be injected into the toolOptions div
            // This makes the main HTML cleaner
            switch(tool) {
                case 'compress':
                case 'compressimage':
                    return `
                        <label class="block text-sm font-medium">Mức độ nén</label>
                        <select id="compressionLevel" class="block w-full rounded-md sm:text-sm form-select">
                            <option value="low">Nén thấp (chất lượng cao)</option>
                            <option value="recommended" selected>Khuyến nghị</option>
                            <option value="extreme">Nén cao (kích thước nhỏ)</option>
                        </select>
                    `;
                case 'split':
                     return `
                        <label class="block text-sm font-medium">Tách theo trang</label>
                        <input type="text" id="splitRange" placeholder="VD: 1-3,5,8-10" class="block w-full rounded-md sm:text-sm form-input" />
                        <p class="text-xs text-gray-500">Nhập trang hoặc khoảng trang cần tách.</p>
                    `;
                case 'rotate':
                case 'rotateimage':
                     return `
                        <label class="block text-sm font-medium">Góc xoay</label>
                        <select id="rotateAngle" class="block w-full rounded-md sm:text-sm form-select">
                            <option value="90">90 độ (phải)</option>
                            <option value="180">180 độ</option>
                            <option value="270">270 độ (trái)</option>
                        </select>
                    `;
                case 'watermark':
                case 'watermarkimage':
                    return `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">Loại dấu</label>
                                <select id="watermarkMode" class="block w-full rounded-md sm:text-sm form-select">
                                    <option value="text">Văn bản</option>
                                    <option value="image">Hình ảnh</option>
                                </select>
                            </div>
                            <div id="watermarkTextInputContainer">
                                <label class="block text-sm font-medium">Nội dung</label>
                                <input type="text" id="watermarkText" value="iLovePDF" class="block w-full rounded-md sm:text-sm form-input" />
                            </div>
                            <div id="watermarkImageInputContainer" class="hidden">
                                <label class="block text-sm font-medium">Tệp ảnh dấu</label>
                                <input type="file" id="watermarkImageInput" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept="image/*" />
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label class="block text-sm font-medium">Vị trí</label><select id="watermarkPosition" class="block w-full rounded-md sm:text-sm form-select"><option value="middle-center">Giữa</option><option value="top-left">Trên-Trái</option><option value="top-right">Trên-Phải</option><option value="bottom-left">Dưới-Trái</option><option value="bottom-right">Dưới-Phải</option></select></div>
                            <div><label class="block text-sm font-medium">Độ trong suốt</label><select id="watermarkTransparency" class="block w-full rounded-md sm:text-sm form-select"><option value="100">100%</option><option value="75">75%</option><option value="50" selected>50%</option><option value="25">25%</option></select></div>
                            <div><label class="block text-sm font-medium">Góc xoay</label><input type="number" id="watermarkRotation" value="0" class="block w-full rounded-md sm:text-sm form-input" /></div>
                            <div id="watermarkFontSizeContainer"><label class="block text-sm font-medium">Cỡ chữ</label><input type="number" id="watermarkFontSize" value="48" class="block w-full rounded-md sm:text-sm form-input" /></div>
                        </div>
                    `;
                case 'protect':
                case 'unlock':
                    return `
                        <label for="passwordInput" class="block text-sm font-medium">Mật khẩu</label>
                        <input type="password" id="passwordInput" class="block w-full rounded-md sm:text-sm form-input" placeholder="Nhập mật khẩu..."/>
                    `;
                case 'cropimage':
                     return `
                        <label class="block text-sm font-medium">Tọa độ cắt (px)</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <input type="number" id="cropX" placeholder="x" value="0" class="block w-full rounded-md sm:text-sm form-input" />
                            <input type="number" id="cropY" placeholder="y" value="0" class="block w-full rounded-md sm:text-sm form-input" />
                            <input type="number" id="cropWidth" placeholder="rộng" class="block w-full rounded-md sm:text-sm form-input" />
                            <input type="number" id="cropHeight" placeholder="cao" class="block w-full rounded-md sm:text-sm form-input" />
                        </div>
                    `;
                case 'convertimage':
                     return `
                        <label class="block text-sm font-medium">Chuyển sang định dạng</label>
                        <select id="convertTo" class="block w-full rounded-md sm:text-sm form-select">
                            <option value="jpg">JPG</option><option value="png">PNG</option><option value="gif">GIF</option>
                        </select>
                    `;
                case 'resizeimage':
                     return `
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="resizeWidth" placeholder="Chiều rộng (px)" class="block w-full rounded-md sm:text-sm form-input" />
                            <input type="number" id="resizeHeight" placeholder="Chiều cao (px)" class="block w-full rounded-md sm:text-sm form-input" />
                        </div>
                        <div class="flex items-center mt-2">
                            <input id="maintainAspectRatio" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="maintainAspectRatio" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Giữ nguyên tỷ lệ</label>
                        </div>
                    `;
                default:
                    var desc = toolDescriptions[tool] || '';
                    return `<p class="text-sm text-gray-600 dark:text-gray-300">${desc}</p>`;
            }
        }

        function setupOptionEventListeners(tool) {
            // Add event listeners to the newly created option elements
            if (tool === 'watermark' || tool === 'watermarkimage') {
                document.getElementById('watermarkMode').addEventListener('change', updateImagePreview);
                document.getElementById('watermarkText').addEventListener('input', updateImagePreview);
                document.getElementById('watermarkImageInput').addEventListener('change', handleWatermarkFileSelect);
                document.getElementById('watermarkPosition').addEventListener('change', updateImagePreview);
                document.getElementById('watermarkTransparency').addEventListener('change', updateImagePreview);
                document.getElementById('watermarkRotation').addEventListener('change', updateImagePreview);
                document.getElementById('watermarkFontSize').addEventListener('change', updateImagePreview);
            }
            if (tool === 'rotateimage') {
                document.getElementById('rotateAngle').addEventListener('change', updateImagePreview);
            }
            if (tool === 'cropimage') {
                ['cropX', 'cropY', 'cropWidth', 'cropHeight'].forEach(id => document.getElementById(id).addEventListener('input', updateImagePreview));
            }
            if (tool === 'resizeimage') {
                ['resizeWidth', 'resizeHeight'].forEach(id => document.getElementById(id).addEventListener('input', updateImagePreview));
            }
        }

        function updateUiForTool() {
            var tool = apiToolSelect.value;
            
            // Generate and inject options HTML
            var optionsHTML = generateOptionsHTML(tool);
            toolOptions.innerHTML = optionsHTML;
            toolOptions.classList.remove('hidden');
            
            // Setup listeners for the new elements
            setupOptionEventListeners(tool);

            // Update file input filter
            var acceptType = 'default';
            if (pdfTools.includes(tool)) acceptType = 'pdf';
            if (imageTools.includes(tool) || tool === 'imagepdf') acceptType = 'image';
            if (fileAcceptMap[tool]) acceptType = tool;
            fileInput.accept = fileAcceptMap[acceptType] || fileAcceptMap['default'];

            fileInput.multiple = multiFileTools.includes(tool);
            fileListContainer.style.display = fileInput.multiple && selectedFiles.length > 0 ? 'block' : 'none';
            
            // Show/hide preview area
            previewArea.style.display = previewTools.includes(tool) && selectedFiles.length > 0 && selectedFiles[0].type.startsWith('image/') ? 'block' : 'none';
            
            updateImagePreview();
        }

        function handleFileSelect(event) {
            var newFiles = Array.from(event.target.files);
            if(fileInput.multiple) {
                selectedFiles = selectedFiles.concat(newFiles);
            } else {
                selectedFiles = newFiles.length > 0 ? [newFiles[0]] : [];
            }
            
            if (selectedFiles.length === 0) {
                fileNameDisplay.textContent = 'Chưa có tệp nào được chọn';
                fileListContainer.classList.add('hidden');
            } else if (fileInput.multiple) {
                fileNameDisplay.textContent = selectedFiles.length + ' tệp đã được chọn';
                renderFileList();
                fileListContainer.classList.remove('hidden');
            } else {
                fileNameDisplay.textContent = selectedFiles[0].name;
                fileListContainer.classList.add('hidden');
            }
            
            var tool = apiToolSelect.value;
            if (previewTools.includes(tool) && selectedFiles.length > 0 && selectedFiles[0].type.startsWith('image/')) {
                previewArea.style.display = 'block';
                updateImagePreview();
            } else {
                previewArea.style.display = 'none';
            }
            setStatus('Đã chọn tệp. Sẵn sàng để xử lý.', 'info');
        }

        function updateImagePreview() {
            var tool = apiToolSelect.value;
            if (!previewTools.includes(tool) || selectedFiles.length === 0 || !selectedFiles[0].type.startsWith('image/')) {
                previewArea.style.display = 'none';
                return;
            }
            previewArea.style.display = 'block';

            var reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                // Reset overlays
                watermarkOverlay.style.cssText = '';
                cropOverlay.style.cssText = 'position: absolute;';
                previewImage.style.transform = '';
                previewInfo.textContent = '';

                // Apply tool-specific preview
                switch(tool) {
                    case 'watermarkimage':
                        // Watermark logic
                        var mode = document.getElementById('watermarkMode').value;
                        var textInputContainer = document.getElementById('watermarkTextInputContainer');
                        var imageInputContainer = document.getElementById('watermarkImageInputContainer');
                        var fontSizeContainer = document.getElementById('watermarkFontSizeContainer');

                        textInputContainer.style.display = mode === 'text' ? 'block' : 'none';
                        imageInputContainer.style.display = mode === 'image' ? 'block' : 'none';
                        fontSizeContainer.style.display = mode === 'text' ? 'block' : 'none';

                        watermarkOverlay.style.backgroundImage = '';
                        watermarkOverlay.textContent = '';

                        if (mode === 'text') {
                            watermarkOverlay.textContent = document.getElementById('watermarkText').value;
                            watermarkOverlay.style.fontSize = document.getElementById('watermarkFontSize').value + 'px';
                            watermarkOverlay.style.color = 'rgba(0,0,0,0.7)';
                        } else if (watermarkFile) {
                            var wmReader = new FileReader();
                            wmReader.onload = function(ev) {
                                watermarkOverlay.style.backgroundImage = 'url(' + ev.target.result + ')';
                                watermarkOverlay.style.backgroundSize = 'contain';
                                watermarkOverlay.style.backgroundRepeat = 'no-repeat';
                                watermarkOverlay.style.width = '50%';
                                watermarkOverlay.style.height = '50%';
                            };
                            wmReader.readAsDataURL(watermarkFile);
                        }
                        
                        var position = document.getElementById('watermarkPosition').value.split('-');
                        watermarkOverlay.style.top = position[0] === 'top' ? '5%' : position[0] === 'bottom' ? 'auto' : '50%';
                        watermarkOverlay.style.bottom = position[0] === 'bottom' ? '5%' : 'auto';
                        watermarkOverlay.style.left = position[1] === 'left' ? '5%' : position[1] === 'right' ? 'auto' : '50%';
                        watermarkOverlay.style.right = position[1] === 'right' ? '5%' : 'auto';
                        watermarkOverlay.style.transform = `translate(${position[1] === 'center' ? '-50%' : '0'}, ${position[0] === 'middle' ? '-50%' : '0'}) rotate(${document.getElementById('watermarkRotation').value}deg)`;
                        watermarkOverlay.style.opacity = document.getElementById('watermarkTransparency').value / 100;
                        break;
                    case 'rotateimage':
                        var angle = document.getElementById('rotateAngle').value;
                        previewImage.style.transform = `rotate(${angle}deg)`;
                        break;
                    case 'cropimage':
                        var x = parseInt(document.getElementById('cropX').value) || 0;
                        var y = parseInt(document.getElementById('cropY').value) || 0;
                        var w = parseInt(document.getElementById('cropWidth').value) || 0;
                        var h = parseInt(document.getElementById('cropHeight').value) || 0;
                        cropOverlay.style.left = x + 'px';
                        cropOverlay.style.top = y + 'px';
                        cropOverlay.style.width = w + 'px';
                        cropOverlay.style.height = h + 'px';
                        cropOverlay.style.display = (w > 0 && h > 0) ? 'block' : 'none';
                        break;
                    case 'resizeimage':
                        var width = document.getElementById('resizeWidth').value;
                        var height = document.getElementById('resizeHeight').value;
                        if (width && height) {
                            previewInfo.textContent = `Kích thước mới: ${width} x ${height}px`;
                        }
                        break;
                }
            };
            reader.readAsDataURL(selectedFiles[0]);
        }
        
        // ... Other functions (handleWatermarkFileSelect, renderFileList, resetAll, API calls) remain largely the same ...
        // They need to be included for the app to work.
        // For brevity in this response, I'm omitting the exact same code from the previous version.
        // The full, working code would include all functions.
        // The following are placeholders for the functions that are unchanged.
        function handleWatermarkFileSelect(event) { watermarkFile = event.target.files[0]; updateImagePreview(); }
        function renderFileList() { /* ... implementation from previous version ... */ }
        function getDragAfterElement(container, y) { /* ... implementation from previous version ... */ }
        function resetAll() {
            selectedFiles = []; watermarkFile = null; fileInput.value = '';
            var wmInput = document.getElementById('watermarkImageInput'); if(wmInput) wmInput.value = '';
            fileNameDisplay.textContent = 'Chưa có tệp nào được chọn';
            fileListContainer.style.display = 'none';
            resultContainer.classList.add('hidden');
            previewArea.style.display = 'none';
            setStatus('');
        }
        async function getApiToken(publicKey) { /* ... implementation from previous version ... */ }
        async function processFiles() { /* ... implementation from previous version ... */ }
        async function downloadResult(event) { /* ... implementation from previous version ... */ }

        // --- Init & External Content Loading ---
        window.addEventListener('load', function() {
            updateUiForTool();
            // Load header and footer
            fetch('mini-header.html').then(res => res.text()).then(data => document.getElementById('page-header').innerHTML = data).catch(console.error);
            fetch('footer.html').then(res => res.text()).then(data => document.getElementById('page-footer').innerHTML = data).catch(console.error);
        });
    </script>
</body>
</html>
