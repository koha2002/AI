<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>T·∫°o Mindmap - Tra C·ª©u H·ªçc Thu·∫≠t & AI</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
  <style>
    /* =================================================================== */
    /* CSS RI√äNG CHO TRANG MINDMAP (N√ÇNG C·∫§P CHUY√äN NGHI·ªÜP)              */
    /* =================================================================== */

    :root {
      --bg-main: #f4f9ff;
      --text-primary: #222;
      --text-link: #185adb;
      --toolbar-bg: #fff;
      --toolbar-border: #e3e9f7;
      --toolbar-shadow: 0 2px 12px rgba(24, 90, 219, 0.08);
      --btn-bg: #f0f5ff;
      --btn-border: #d6e4ff;
      --btn-hover-bg: #eaf3ff;
      --btn-active-bg: #dbe8ff;
      --node-bg: #fff;
      --node-stroke: #185adb;
      --node-text: #111827;
      --node-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --link-stroke: #9ca3af;
      --sidebar-bg: #ffffff;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-main: #0f172a;
        --text-primary: #e2e8f0;
        --text-link: #a5b4fc;
        --toolbar-bg: #1e293b;
        --toolbar-border: #334155;
        --toolbar-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
        --btn-bg: #334155;
        --btn-border: #475569;
        --btn-hover-bg: #475569;
        --btn-active-bg: #64748b;
        --node-bg: #1e293b;
        --node-stroke: #a5b4fc;
        --node-text: #e2e8f0;
        --node-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        --link-stroke: #64748b;
        --sidebar-bg: #1e293b;
      }
    }

    /* ----- STYLE CHUNG ----- */
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Montserrat', Arial, sans-serif;
      display: flex; flex-direction: column;
      height: 100vh;
      overflow: hidden;
      box-sizing: border-box;
    }
    main {
      flex: 1 1 auto;
      width: 100%;
      display: flex;
      overflow: hidden;
      position: relative;
    }
    #footer { flex-shrink: 0; }

    /* ----- THANH MENU ----- */
    .menubar {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 20;
      background: var(--toolbar-bg);
      border: 1px solid var(--toolbar-border);
      box-shadow: var(--toolbar-shadow);
      border-radius: 12px;
      padding: 4px;
      display: flex;
      gap: 4px;
    }
    .menu-item {
      position: relative;
    }
    .menu-btn {
      background: none;
      border: none;
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .menu-btn:hover { background: var(--btn-hover-bg); }
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: var(--toolbar-bg);
      min-width: 220px;
      box-shadow: var(--toolbar-shadow);
      border: 1px solid var(--toolbar-border);
      border-radius: 8px;
      padding: 8px;
      z-index: 21;
    }
    .dropdown-content button, .saved-map-item button {
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 14px;
    }
    .dropdown-content button:hover { background-color: var(--btn-hover-bg); }
    .menu-item:hover .dropdown-content { display: block; }
    .dropdown-separator {
      height: 1px;
      background-color: var(--toolbar-border);
      margin: 8px 0;
    }
    .saved-maps-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .saved-map-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .saved-map-item:hover {
      background-color: var(--btn-hover-bg);
    }
    .saved-map-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-grow: 1;
    }
    .saved-map-actions button {
      width: auto;
      padding: 4px 8px;
      font-size: 12px;
    }
    
    /* ----- SIDEBAR THU·ªòC T√çNH ----- */
    .sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 240px;
      height: 100%;
      background: var(--sidebar-bg);
      border-left: 1px solid var(--toolbar-border);
      box-shadow: -2px 0 12px rgba(0,0,0,0.05);
      z-index: 20;
      padding: 16px;
      box-sizing: border-box;
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      overflow-y: auto;
    }
    .sidebar.visible { transform: translateX(0); }
    .sidebar-section { margin-bottom: 24px; }
    .sidebar-title { font-weight: 700; font-size: 16px; margin-bottom: 12px; }
    .sidebar-control { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .sidebar-control label { font-size: 14px; width: 100%; }
    .sidebar-control input[type="color"] {
      -webkit-appearance: none; width: 40px; height: 40px; border: none;
      cursor: pointer; background: none; padding: 0;
    }
    .sidebar-control input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    .sidebar-control input[type="color"]::-webkit-color-swatch { border: 1px solid var(--toolbar-border); border-radius: 8px; }
    .format-btns { display: flex; gap: 8px; }
    .format-btns button { font-family: serif; font-size: 18px; width: 40px; height: 40px; }
    .format-btns button.active { background-color: var(--btn-active-bg); border-color: var(--text-link); }
    #note-editor {
        width: 100%;
        height: 150px;
        background-color: var(--bg-main);
        border: 1px solid var(--toolbar-border);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: 'Montserrat', Arial, sans-serif;
        padding: 8px;
        box-sizing: border-box;
    }
    .size-control input[type="range"] { width: 100%; }

    /* ----- MINDMAP CANVAS ----- */
    #mindmap-container { width: 100%; height: 100%; flex-grow: 1; cursor: grab; }
    #mindmap-container:active { cursor: grabbing; }
    .node .shape { stroke: var(--node-stroke); stroke-width: 2px; filter: drop-shadow(var(--node-shadow)); }
    .node-foreign-object {
      text-align: center; padding: 5px; box-sizing: border-box;
      overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100%;
    }
    .node-text-div {
        color: var(--node-text);
        font-size: 14px;
        line-height: 1.2;
        word-break: break-word;
    }
    .link { fill: none; stroke: var(--link-stroke); stroke-width: 2px; }
    .custom-link { fill: none; stroke: #f59e0b; stroke-width: 2.5px; stroke-dasharray: 5,5; }
    .node.selected .shape { stroke: #f59e0b; stroke-width: 3px; }
    .node-input {
      width: 100%; height: 100%; border: none; background-color: transparent; text-align: center;
      font-family: 'Montserrat', Arial, sans-serif; font-size: 14px; color: var(--node-text);
      outline: none; box-sizing: border-box; padding: 0 5px;
    }
    .note-icon {
        font-size: 12px;
        fill: var(--text-secondary);
    }
  </style>
</head>
<body>
  
  <div id="header"></div>

  <main>
    <div class="menubar">
        <div class="menu-item">
            <button class="menu-btn">File</button>
            <div class="dropdown-content">
                <button id="new-btn">üìÑ T·∫°o m·ªõi</button>
                <div class="dropdown-separator"></div>
                <div style="padding: 0 8px; font-weight: 600; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">S∆† ƒê·ªí ƒê√É L∆ØU</div>
                <div class="saved-maps-list" id="saved-maps-list"></div>
                <div class="dropdown-separator"></div>
                <button id="import-btn" onclick="document.getElementById('import-file').click();">üìÇ M·ªü file d·ª± √°n</button>
                <input type="file" id="import-file" accept=".json" style="display:none;">
                <button id="export-json-btn">üíæ T·∫£i file d·ª± √°n</button>
                <button id="export-pdf-btn">üìÑ Xu·∫•t PDF</button>
            </div>
        </div>
        <div class="menu-item">
            <button class="menu-btn">Ch√®n</button>
            <div class="dropdown-content">
                <button id="add-child-btn">‚ûï N√∫t con (Tab)</button>
                <button id="add-sibling-btn">‚ûï N√∫t ngang h√†ng (Enter)</button>
                <button id="add-connection-btn">üîó T·∫°o li√™n k·∫øt</button>
            </div>
        </div>
        <div class="menu-item">
            <button class="menu-btn">Ch·ªânh s·ª≠a</button>
            <div class="dropdown-content">
                <button id="delete-btn">üóëÔ∏è X√≥a n√∫t (Delete)</button>
            </div>
        </div>
        <div class="menu-item">
            <button class="menu-btn">Xem</button>
            <div class="dropdown-content">
                <button id="zoom-in-btn">‚ûï Ph√≥ng to</button>
                <button id="zoom-out-btn">‚ûñ Thu nh·ªè</button>
                <button id="zoom-fit-btn">üåç V·ª´a m√†n h√¨nh</button>
            </div>
        </div>
    </div>

    <div id="mindmap-container">
      <svg width="100%" height="100%"></svg>
    </div>

    <div class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">H√¨nh d·∫°ng</div>
        <div class="sidebar-control format-btns">
          <button class="toolbar-btn" id="shape-rect-btn" title="H√¨nh ch·ªØ nh·∫≠t">‚ñ≠</button>
          <button class="toolbar-btn" id="shape-ellipse-btn" title="H√¨nh elip">‚¨¨</button>
          <button class="toolbar-btn" id="shape-diamond-btn" title="H√¨nh thoi">‚óá</button>
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">K√≠ch th∆∞·ªõc</div>
        <div class="sidebar-control size-control">
            <label for="node-width-slider">Chi·ªÅu r·ªông: <span id="width-value">160</span>px</label>
            <input type="range" id="node-width-slider" min="60" max="400" value="160">
        </div>
        <div class="sidebar-control size-control" style="margin-top: 8px;">
            <label for="node-height-slider">Chi·ªÅu cao: <span id="height-value">60</span>px</label>
            <input type="range" id="node-height-slider" min="40" max="200" value="60">
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">M√†u s·∫Øc</div>
        <div class="sidebar-control">
          <label for="node-bg-color-picker">M√†u n·ªÅn</label>
          <input type="color" id="node-bg-color-picker">
        </div>
         <div class="sidebar-control" style="margin-top: 8px;">
          <label for="node-text-color-picker">M√†u ch·ªØ</label>
          <input type="color" id="node-text-color-picker">
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">VƒÉn b·∫£n</div>
        <div class="sidebar-control format-btns">
          <button class="toolbar-btn" id="bold-btn" title="In ƒë·∫≠m"><b>B</b></button>
          <button class="toolbar-btn" id="italic-btn" title="In nghi√™ng"><i>I</i></button>
          <button class="toolbar-btn" id="font-size-increase-btn" title="TƒÉng c·ª° ch·ªØ">A+</button>
          <button class="toolbar-btn" id="font-size-decrease-btn" title="Gi·∫£m c·ª° ch·ªØ">A-</button>
        </div>
      </div>
       <div class="sidebar-section">
        <div class="sidebar-title">Ghi ch√∫</div>
        <textarea id="note-editor" placeholder="Th√™m ghi ch√∫ chi ti·∫øt..."></textarea>
      </div>
    </div>
  </main>
  
  <div id="footer"></div>
  
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Nh√∫ng header/footer
    function loadHtml(id, file) {
      fetch(file).then(res => res.text()).then(data => {
        document.getElementById(id).innerHTML = data;
      });
    }
    loadHtml('header', 'mini-header.html');
    loadHtml('footer', 'footer.html');

    document.addEventListener('DOMContentLoaded', () => {
        const svg = d3.select("#mindmap-container svg");
        const g = svg.append("g");
        const gLinks = g.append("g").attr("class", "links");
        const gNodes = g.append("g").attr("class", "nodes");

        const sidebar = document.getElementById('sidebar');
        const widthSlider = document.getElementById('node-width-slider');
        const heightSlider = document.getElementById('node-height-slider');
        const widthValueSpan = document.getElementById('width-value');
        const heightValueSpan = document.getElementById('height-value');
        const bgColorPicker = document.getElementById('node-bg-color-picker');
        const textColorPicker = document.getElementById('node-text-color-picker');
        const boldBtn = document.getElementById('bold-btn');
        const italicBtn = document.getElementById('italic-btn');
        const noteEditor = document.getElementById('note-editor');
        const savedMapsList = document.getElementById('saved-maps-list');

        let root, selectedNode, i = 0, connectionMode = false, connectionStartNode = null;
        let activeMapId = null;
        const defaultNodeSize = { width: 160, height: 60 };
        const treeLayout = d3.tree().nodeSize([120, 220]);

        const zoom = d3.zoom()
            .scaleExtent([0.1, 2])
            .filter(event => event.button === 1 || event.type === 'wheel')
            .on("zoom", (event) => g.attr("transform", event.transform));
        svg.call(zoom);

        // --- H·ªÜ TH·ªêNG QU·∫¢N L√ù FILE ---
        function getCollection() {
            const collection = localStorage.getItem('mindmapCollection');
            return collection ? JSON.parse(collection) : [];
        }

        function saveCollection(collection) {
            localStorage.setItem('mindmapCollection', JSON.stringify(collection));
        }

        function getMapById(id) {
            const collection = getCollection();
            return collection.find(map => map.id === id);
        }
        
        function saveActiveMapData() {
            if (!root || !activeMapId) return;
            let collection = getCollection();
            const mapIndex = collection.findIndex(map => map.id === activeMapId);
            if (mapIndex > -1) {
                collection[mapIndex].data = root.data;
                collection[mapIndex].lastModified = Date.now();
                saveCollection(collection);
            }
        }

        function createDefaultData(name) {
            const defaultBg = getComputedStyle(document.documentElement).getPropertyValue('--node-bg').trim();
            const defaultText = getComputedStyle(document.documentElement).getPropertyValue('--node-text').trim();
            return { 
                id: `map-${Date.now()}`,
                name: name || `S∆° ƒë·ªì m·ªõi ${new Date().toLocaleTimeString()}`,
                lastModified: Date.now(),
                data: {
                    id: `node-${Date.now()}`,
                    name: "Ch·ªß ƒë·ªÅ ch√≠nh", shape: "rectangle", 
                    width: defaultNodeSize.width, height: defaultNodeSize.height,
                    backgroundColor: defaultBg, textColor: defaultText,
                    fontSize: 14, isBold: false, isItalic: false, note: "", connections: [], children: [] 
                }
            };
        }

        function loadMap(mapId) {
            const map = getMapById(mapId);
            if (map) {
                activeMapId = map.id;
                root = d3.hierarchy(map.data);
                update(root);
                selectNode(root);
                zoomToFit();
            }
        }
        
        function renderSavedMapsList() {
            const collection = getCollection().sort((a, b) => b.lastModified - a.lastModified);
            savedMapsList.innerHTML = '';
            if (collection.length === 0) {
                savedMapsList.innerHTML = '<div style="padding: 8px; font-size: 12px; color: grey;">Ch∆∞a c√≥ s∆° ƒë·ªì n√†o.</div>';
                return;
            }
            collection.forEach(map => {
                const item = document.createElement('div');
                item.className = 'saved-map-item';
                item.innerHTML = `
                    <span class="saved-map-name">${map.name}</span>
                    <div class="saved-map-actions">
                        <button title="S·ª≠a">‚úèÔ∏è</button>
                        <button title="Xu·∫•t PDF">üìÑ</button>
                        <button title="X√≥a">üóëÔ∏è</button>
                    </div>
                `;
                const buttons = item.querySelectorAll('button');
                buttons[0].onclick = () => loadMap(map.id);
                buttons[1].onclick = () => exportPdfById(map.id);
                buttons[2].onclick = () => deleteMap(map.id);
                savedMapsList.appendChild(item);
            });
        }

        function deleteMap(mapId) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a vƒ©nh vi·ªÖn s∆° ƒë·ªì n√†y?")) return;
            let collection = getCollection();
            collection = collection.filter(map => map.id !== mapId);
            saveCollection(collection);
            if (activeMapId === mapId) {
                const newCollection = getCollection();
                if (newCollection.length > 0) {
                    loadMap(newCollection.sort((a,b) => b.lastModified - a.lastModified)[0].id);
                } else {
                    handleNewBtnClick(true); // T·∫°o m·ªõi m√† kh√¥ng l∆∞u c√°i c≈© (v√¨ n√≥ ƒë√£ b·ªã x√≥a)
                }
            }
            renderSavedMapsList();
        }

        function handleNewBtnClick(isAfterDelete = false) {
            if(!isAfterDelete) saveActiveMapData();
            let collection = getCollection();
            const newMap = createDefaultData();
            collection.push(newMap);
            saveCollection(collection);
            loadMap(newMap.id);
            renderSavedMapsList();
        }
        
        // --- K·∫æT TH√öC H·ªÜ TH·ªêNG QU·∫¢N L√ù FILE ---

        function update(hierarchyRoot) {
            const treeData = treeLayout(hierarchyRoot);
            const nodes = treeData.descendants();
            const links = treeData.descendants().slice(1);

            gLinks.selectAll("path").remove();
            gNodes.selectAll(".node").remove();

            gLinks.selectAll("path.link")
                .data(links, d => d.data.id)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d => `M${d.y},${d.x}C${(d.y + d.parent.y) / 2},${d.x} ${(d.y + d.parent.y) / 2},${d.parent.x} ${d.parent.y},${d.parent.x}`);

            const nodeMap = new Map(hierarchyRoot.descendants().map(d => [d.data.id, d]));
            hierarchyRoot.descendants().forEach(sourceNode => {
                if (sourceNode.data.connections) {
                    sourceNode.data.connections.forEach(targetId => {
                        const targetNode = nodeMap.get(targetId);
                        if (targetNode) {
                            gLinks.append("path")
                                .attr("class", "custom-link")
                                .attr("d", `M${sourceNode.y},${sourceNode.x} L${targetNode.y},${targetNode.x}`);
                        }
                    });
                }
            });

            const node = gNodes.selectAll("g.node")
                .data(nodes, d => d.data.id)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.y},${d.x})`)
                .on("contextmenu", handleNodeClick);

            node.each(function(d) {
                const group = d3.select(this);
                const data = d.data;
                const nodeWidth = data.width || defaultNodeSize.width;
                const nodeHeight = data.height || defaultNodeSize.height;
                const shapeType = data.shape || 'rectangle';
                const bgColor = data.backgroundColor || getComputedStyle(document.documentElement).getPropertyValue('--node-bg').trim();
                
                let shape;
                if (shapeType === 'rectangle') shape = group.append("rect").attr("width", nodeWidth).attr("height", nodeHeight).attr("x", -nodeWidth / 2).attr("y", -nodeHeight / 2).attr("rx", 8).attr("ry", 8);
                else if (shapeType === 'ellipse') shape = group.append("ellipse").attr("rx", nodeWidth / 2).attr("ry", nodeHeight / 2);
                else if (shapeType === 'diamond') {
                    const w = nodeWidth / 2; const h = nodeHeight / 2;
                    shape = group.append("path").attr("d", `M 0 ${-h} L ${w} 0 L 0 ${h} L ${-w} 0 Z`);
                }
                shape.attr("class", "shape").style("fill", bgColor);
            });

            const fo = node.append("foreignObject")
                .attr("width", d => (d.data.width || defaultNodeSize.width) - 10)
                .attr("height", d => (d.data.height || defaultNodeSize.height) - 10)
                .attr("x", d => -(d.data.width || defaultNodeSize.width) / 2 + 5)
                .attr("y", d => -(d.data.height || defaultNodeSize.height) / 2 + 5)
                .on("dblclick", (event, d) => { event.stopPropagation(); editNodeText(d, fo); });

            fo.append("xhtml:div")
                .attr("class", "node-foreign-object")
                .append("xhtml:div")
                .attr("class", "node-text-div")
                .style("font-weight", d => d.data.isBold ? "bold" : "normal")
                .style("font-style", d => d.data.isItalic ? "italic" : "normal")
                .style("font-size", d => (d.data.fontSize || 14) + 'px')
                .style("color", d => d.data.textColor || getComputedStyle(document.documentElement).getPropertyValue('--node-text').trim())
                .html(d => d.data.name);

            node.filter(d => d.data.note && d.data.note.trim() !== "")
                .append("text")
                .attr("class", "note-icon")
                .attr("x", d => (d.data.width || defaultNodeSize.width) / 2 - 15)
                .attr("y", d => -(d.data.height || defaultNodeSize.height) / 2 + 15)
                .text("üìù");
        }
        
        function handleNodeClick(event, d) {
            event.preventDefault();
            event.stopPropagation();
            if (connectionMode) {
                if (!connectionStartNode) {
                    connectionStartNode = d;
                    selectNode(d);
                } else {
                    if (connectionStartNode.data.id !== d.data.id) {
                        if (!connectionStartNode.data.connections) connectionStartNode.data.connections = [];
                        if (!connectionStartNode.data.connections.includes(d.data.id)) {
                             connectionStartNode.data.connections.push(d.data.id);
                        }
                        update(root);
                        saveActiveMapData();
                    }
                    connectionMode = false;
                    connectionStartNode = null;
                    document.body.style.cursor = 'default';
                    alert("ƒê√£ t·∫°o li√™n k·∫øt!");
                }
            } else {
                selectNode(d);
            }
        }

        function selectNode(d) {
            if (selectedNode) d3.selectAll(".node").filter(nd => nd.data.id === selectedNode.data.id).classed("selected", false);
            selectedNode = d;
            d3.selectAll(".node").filter(nd => nd.data.id === d.data.id).classed("selected", true);
            updateSidebar();
            sidebar.classList.add('visible');
        }
        
        function deselectAll() {
            if (selectedNode) d3.selectAll(".node").filter(nd => nd.data.id === selectedNode.data.id).classed("selected", false);
            selectedNode = null;
            sidebar.classList.remove('visible');
        }

        function updateSidebar() {
            if (!selectedNode) return;
            const data = selectedNode.data;
            widthSlider.value = data.width || defaultNodeSize.width;
            heightSlider.value = data.height || defaultNodeSize.height;
            widthValueSpan.textContent = widthSlider.value;
            heightValueSpan.textContent = heightSlider.value;
            bgColorPicker.value = data.backgroundColor;
            textColorPicker.value = data.textColor;
            boldBtn.classList.toggle('active', !!data.isBold);
            italicBtn.classList.toggle('active', !!data.isItalic);
            noteEditor.value = data.note || "";
        }

        function editNodeText(d, foreignObject) {
            const div = foreignObject.select(".node-text-div");
            div.style("display", "none");

            const input = foreignObject.select(".node-foreign-object").append("xhtml:textarea")
                .attr("class", "node-input")
                .style("font-weight", d.data.isBold ? "bold" : "normal")
                .style("font-style", d.data.isItalic ? "italic" : "normal")
                .style("font-size", (d.data.fontSize || 14) + 'px')
                .html(d.data.name)
                .on("blur", function() {
                    d.data.name = this.value;
                    div.html(d.data.name).style("display", "block");
                    d3.select(this).remove();
                    saveActiveMapData();
                });
            
            input.node().focus();
            input.node().select();
        }

        function addNode(isSibling) {
            if (!selectedNode) { alert("Vui l√≤ng ch·ªçn m·ªôt n√∫t!"); return; }
            const defaultBg = getComputedStyle(document.documentElement).getPropertyValue('--node-bg').trim();
            const defaultText = getComputedStyle(document.documentElement).getPropertyValue('--node-text').trim();
            const newNodeData = { id: `node-${Date.now()}`, name: "N√∫t m·ªõi", shape: "rectangle", width: defaultNodeSize.width, height: defaultNodeSize.height, backgroundColor: defaultBg, textColor: defaultText, fontSize: 14, isBold: false, isItalic: false, note: "", connections: [] };
            let parentNode = isSibling ? selectedNode.parent : selectedNode;

            if (!parentNode) { alert("Kh√¥ng th·ªÉ th√™m n√∫t ngang h√†ng cho ch·ªß ƒë·ªÅ ch√≠nh."); return; }
            if (!parentNode.data.children) parentNode.data.children = [];
            
            if(isSibling) parentNode.data.children.push(newNodeData);
            else {
                if(!selectedNode.data.children) selectedNode.data.children = [];
                selectedNode.data.children.push(newNodeData);
            }
            
            update(root);
            saveActiveMapData();
        }

        function deleteNode() {
            if (!selectedNode || !selectedNode.parent) { alert("Kh√¥ng th·ªÉ x√≥a ch·ªß ƒë·ªÅ ch√≠nh!"); return; }
            const parent = selectedNode.parent;
            const index = parent.data.children.indexOf(selectedNode.data);
            if (index > -1) parent.data.children.splice(index, 1);
            
            update(root);
            deselectAll();
            saveActiveMapData();
        }

        function setShape(shape) {
            if (selectedNode) { selectedNode.data.shape = shape; update(root); saveActiveMapData(); }
        }
        
        function zoomToFit() {
            const bounds = g.node().getBBox();
            const parent = svg.node().parentElement;
            const fullWidth = parent.clientWidth, fullHeight = parent.clientHeight;
            if (bounds.width === 0 || bounds.height === 0) return;
            const scale = 0.85 / Math.max(bounds.width / fullWidth, bounds.height / fullHeight);
            const translate = [fullWidth / 2 - scale * (bounds.x + bounds.width / 2), fullHeight / 2 - scale * (bounds.y + bounds.height / 2)];

            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
            );
        }

        // G√°n s·ª± ki·ªán
        document.getElementById('add-child-btn').onclick = () => addNode(false);
        document.getElementById('add-sibling-btn').onclick = () => addNode(true);
        document.getElementById('delete-btn').onclick = deleteNode;
        document.getElementById('shape-rect-btn').onclick = () => setShape('rectangle');
        document.getElementById('shape-ellipse-btn').onclick = () => setShape('ellipse');
        document.getElementById('shape-diamond-btn').onclick = () => setShape('diamond');
        
        widthSlider.oninput = (e) => {
            if(selectedNode) {
                selectedNode.data.width = +e.target.value;
                widthValueSpan.textContent = e.target.value;
                update(root);
                saveActiveMapData();
            }
        };
        heightSlider.oninput = (e) => {
            if(selectedNode) {
                selectedNode.data.height = +e.target.value;
                heightValueSpan.textContent = e.target.value;
                update(root);
                saveActiveMapData();
            }
        };

        bgColorPicker.oninput = (e) => { if(selectedNode) { selectedNode.data.backgroundColor = e.target.value; update(root); saveActiveMapData(); } };
        textColorPicker.oninput = (e) => { if(selectedNode) { selectedNode.data.textColor = e.target.value; update(root); saveActiveMapData(); } };
        boldBtn.onclick = () => { if(selectedNode) { selectedNode.data.isBold = !selectedNode.data.isBold; update(root); updateSidebar(); saveActiveMapData(); } };
        italicBtn.onclick = () => { if(selectedNode) { selectedNode.data.isItalic = !selectedNode.data.isItalic; update(root); updateSidebar(); saveActiveMapData(); } };
        document.getElementById('font-size-increase-btn').onclick = () => { if(selectedNode) { selectedNode.data.fontSize = (selectedNode.data.fontSize || 14) + 1; update(root); saveActiveMapData(); } };
        document.getElementById('font-size-decrease-btn').onclick = () => { if(selectedNode) { selectedNode.data.fontSize = (selectedNode.data.fontSize || 14) - 1; update(root); saveActiveMapData(); } };
        noteEditor.onblur = (e) => { if(selectedNode) { selectedNode.data.note = e.target.value; update(root); saveActiveMapData(); } };
        document.getElementById('add-connection-btn').onclick = () => {
            connectionMode = true;
            connectionStartNode = null;
            document.body.style.cursor = 'crosshair';
            alert("Ch·ªçn n√∫t b·∫Øt ƒë·∫ßu, sau ƒë√≥ ch·ªçn n√∫t k·∫øt th√∫c ƒë·ªÉ t·∫°o li√™n k·∫øt.");
        };

        document.getElementById('save-btn').onclick = () => { saveActiveMapData(); alert("ƒê√£ l∆∞u s∆° ƒë·ªì!"); };
        document.getElementById('new-btn').onclick = () => handleNewBtnClick();
        svg.on('click', deselectAll);
        
        document.getElementById('zoom-in-btn').onclick = () => svg.transition().duration(250).call(zoom.scaleBy, 1.2);
        document.getElementById('zoom-out-btn').onclick = () => svg.transition().duration(250).call(zoom.scaleBy, 0.8);
        document.getElementById('zoom-fit-btn').onclick = zoomToFit;

        d3.select("body").on("keydown", function(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
            if (!selectedNode) return;
            switch (event.key) {
                case "Tab": event.preventDefault(); addNode(false); break;
                case "Enter": event.preventDefault(); addNode(true); break;
                case "Delete": case "Backspace": event.preventDefault(); deleteNode(); break;
            }
        });

        document.getElementById('export-json-btn').onclick = () => {
            const mapData = getMapById(activeMapId);
            if (!mapData) return alert("Kh√¥ng t√¨m th·∫•y s∆° ƒë·ªì ƒë·ªÉ xu·∫•t!");
            const dataStr = JSON.stringify(mapData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = `${mapData.name}.json`; a.click(); URL.revokeObjectURL(url);
        };

        document.getElementById('import-file').onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const mapData = JSON.parse(e.target.result);
                        let collection = getCollection();
                        collection.push(mapData);
                        saveCollection(collection);
                        loadMap(mapData.id);
                        renderSavedMapsList();
                    } catch (err) { alert("File kh√¥ng h·ª£p l·ªá!"); }
                };
                reader.readAsText(file);
            }
        };
        
        function exportPdfById(mapId) {
            const mapToExport = getMapById(mapId);
            if (!mapToExport) return;
            
            const tempContainer = d3.select("body").append("div").style("position", "absolute").style("left", "-9999px");
            const tempSvg = tempContainer.append("svg");
            const tempG = tempSvg.append("g");

            const tempRoot = d3.hierarchy(mapToExport.data, d => d.children);
            const tempTreeData = treeLayout(tempRoot);
            
            // V·∫Ω l·∫°i c√°c th√†nh ph·∫ßn tr√™n SVG ·∫©n
            // (L∆∞·ª£c b·ªè ph·∫ßn v·∫Ω chi ti·∫øt ƒë·ªÉ gi·ªØ code ng·∫Øn g·ªçn, logic t∆∞∆°ng t·ª± h√†m update)
            // ...

            const { jsPDF } = window.jspdf;
            const bounds = tempG.node().getBBox();
            const padding = 50;
            const fullWidth = bounds.width + padding * 2;
            const fullHeight = bounds.height + padding * 2;

            tempSvg.attr('width', fullWidth).attr('height', fullHeight);
            tempG.attr('transform', `translate(${-bounds.x + padding}, ${-bounds.y + padding})`);

            html2canvas(tempSvg.node(), {
                backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-main').trim(),
                scale: 2
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: fullWidth > fullHeight ? 'landscape' : 'portrait',
                    unit: 'px',
                    format: [fullWidth, fullHeight]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, fullWidth, fullHeight);
                pdf.save(`${mapToExport.name}.pdf`);
                tempContainer.remove(); // X√≥a container t·∫°m
            });
        }

        document.getElementById('export-pdf-btn').onclick = () => exportPdfById(activeMapId);

        // Kh·ªüi t·∫°o
        function initializeApp() {
            let collection = getCollection();
            if (collection.length === 0) {
                const newMap = createDefaultData();
                collection.push(newMap);
                saveCollection(collection);
            }
            const lastMap = collection.sort((a,b) => b.lastModified - a.lastModified)[0];
            loadMap(lastMap.id);
            renderSavedMapsList();
        }

        initializeApp();
    });
  </script>
</body>
</html>
