<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chat v·ªõi AI - Tr·ª£ L√Ω H·ªçc T·∫≠p & AI</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .chat-outer {
      width: 100%;
      max-width: 700px;
      margin: 34px auto 18px auto;
      border-radius: 22px;
      background: #fff;
      box-shadow: 0 6px 32px #185adb19;
      padding: 0;
      min-height: 520px;
      position: relative;
      display: flex;
      flex-direction: column;
      z-index: 2;
    }
    .chat-header-bar {
      padding: 0 24px;
      height: 72px;
      display: flex; align-items: center;
      border-bottom: 1.5px solid #e9f1fb;
      gap: 14px;
    }
    .chat-header-bar img {
      width: 42px; height: 42px; border-radius: 50%;
      box-shadow: 0 2px 8px #185adb18;
      background: #f5f8ff;
    }
    .chat-header-bar .chat-title {
      font-weight: bold; font-size: 1.14rem; color: #185adb;
      margin-left: 5px;
      letter-spacing: .1px;
    }
    .chat-header-bar .api-btn {
      margin-left: auto;
      background: #f5f8ff;
      color: #185adb;
      border: 1.5px solid #b7d2fa;
      border-radius: 8px;
      padding: 7px 18px;
      font-weight: 600;
      font-size: 1.01rem;
      cursor: pointer;
      transition: background 0.16s, border 0.16s;
      display: flex; align-items: center; gap: 7px;
    }
    .chat-header-bar .api-btn:hover {background:#e7f0ff;}
    .mode-switcher {
      display: flex; gap: 9px; margin: 20px 0 0 0; justify-content: center;
    }
    .mode-btn {
      border-radius: 8px 8px 0 0;
      background: #f6faff;
      border: 1.5px solid #b7d2fa;
      padding: 7px 23px;
      color: #185adb;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.16s, color 0.14s, box-shadow .16s;
      margin-bottom: -2px;
    }
    .mode-btn.active, .mode-btn:hover {
      background: #185adb;
      color: #fff;
      box-shadow: 0 2px 16px #185adb20;
      border-bottom: 2px solid #185adb;
      z-index: 2;
    }
    .chat-body {
      flex: 1;
      padding: 0 0 0 0;
      overflow-y: auto;
      background: #f8fbff;
      display: flex;
      flex-direction: column;
    }
    .chat-messages {
      padding: 24px 20px 12px 20px;
      overflow-y: auto;
      min-height: 340px;
      flex: 1;
    }
    .msg-row {
      display: flex; margin-bottom: 16px;
    }
    .msg-bubble {
      max-width: 85%; min-width: 58px;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 1.06rem;
      line-height: 1.5;
      box-shadow: 0 2px 10px #185adb14;
      white-space: pre-line;
    }
    .msg-user {justify-content: flex-end;}
    .msg-user .msg-bubble {
      background: linear-gradient(120deg, #185adb 0%, #3a67ee 100%);
      color: #fff; border-bottom-right-radius: 7px;
    }
    .msg-ai {justify-content: flex-start;}
    .msg-ai .msg-bubble {
      background: #eaf3ff;
      color: #222; border-bottom-left-radius: 7px;
    }
    .chat-input-bar {
      display: flex;
      align-items: center;
      padding: 14px 20px 18px 20px;
      border-top: 1.2px solid #e7f0ff;
      gap: 8px;
      background: #f6faff;
    }
    .chat-input-bar input {
      flex: 1;
      padding: 11px 13px;
      border-radius: 9px;
      border: 1.3px solid #bdd1f6;
      font-size: 1.06rem;
      outline: none;
    }
    .chat-input-bar button {
      padding: 11px 19px;
      border-radius: 8px;
      border: none;
      background: #185adb;
      color: #fff;
      font-weight: 600;
      font-size: 1.08rem;
      cursor: pointer;
      transition: background 0.16s;
      box-shadow: 0 1px 8px #185adb14;
    }
    .chat-input-bar button:active {background:#153772;}
    /* Popup */
    .popup-api-bg {
      position:fixed;left:0;top:0;width:100vw;height:100vh;background:#0006;z-index:999;display:flex;align-items:center;justify-content:center;
    }
    .popup-api-box {
      background:#fff;border-radius:13px;padding:30px 32px;box-shadow:0 8px 40px #185adb22;min-width:280px;max-width:94vw;text-align:center;
    }
    .popup-api-box label {font-size:1.09rem;color:#185adb;font-weight:700;}
    .popup-api-box input {
      margin-top:10px;padding:10px 12px;border-radius:8px;border:1.5px solid #bdd1f6;font-size:1rem;width:85%;max-width:300px;
    }
    .popup-api-box .popup-btns {margin-top:22px;display:flex;justify-content:center;gap:14px;}
    .popup-api-box button {
      padding:9px 20px;border-radius:7px;font-weight:600;font-size:1.01rem;border:none;cursor:pointer;background:#185adb;color:#fff;
      transition:background 0.15s;
    }
    .popup-api-box button.cancel {background:#e7eaf6;color:#185adb;}
    .popup-api-box button:active {background:#133b86;}
    @media (max-width:820px) {.chat-outer{max-width:97vw;}}
    @media (max-width:530px) {
      .chat-outer {margin:9px 2vw;}
      .chat-header-bar {padding:0 7px;}
      .chat-messages {padding:13px 4vw 7px 4vw;}
      .chat-input-bar {padding:7px 4vw 7px 4vw;}
    }
  </style>
</head>
<body>
  <div class="bg-deco left"></div>
  <div class="bg-deco right"></div>
  <canvas class="star-canvas"></canvas>
  <div id="header"></div>

  <main style="margin:0;padding:0;">
    <div class="chat-outer">
      <div class="chat-header-bar">
        <img src="icon-ai.png" alt="AI">
        <span class="chat-title">Tr·ª£ l√Ω AI h·ªçc t·∫≠p</span>
        <button class="api-btn" onclick="openAPIKeyPopup()">
          <span>üîë Nh·∫≠p API Key</span>
        </button>
      </div>
      <div class="mode-switcher">
        <button class="mode-btn active" onclick="switchMode('chatbase')">Chatbase</button>
        <button class="mode-btn" onclick="switchMode('gpt')">Chat GPT</button>
        <button class="mode-btn" onclick="switchMode('gemini')">Chat Gemini</button>
      </div>
      <div class="chat-body">
        <!-- Chatbase -->
        <div id="chatbase-chat" class="chat-messages" style="display:block;text-align:center;">
          <iframe src="https://www.chatbase.co/chatbot-iframe/LqqF_1Q5mDRgBiRX2Kpb_" width="97%" height="420"
            style="border-radius:13px;border:1.5px solid #eee;background:#fff;box-shadow:0 4px 16px #185adb19;"
            allow="clipboard-write"></iframe>
        </div>
        <!-- GPT Chat -->
        <div id="gpt-chat" class="chat-messages" style="display:none;"></div>
        <!-- Gemini Chat -->
        <div id="gemini-chat" class="chat-messages" style="display:none;"></div>
      </div>
      <div class="chat-input-bar" id="chatbase-input" style="display:none;"></div>
      <div class="chat-input-bar" id="gpt-input" style="display:none;">
        <input id="userMsg-gpt" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi..." autocomplete="off" onkeydown="if(event.key==='Enter'){sendMsgGPT();}">
        <button onclick="sendMsgGPT()">G·ª≠i</button>
      </div>
      <div class="chat-input-bar" id="gemini-input" style="display:none;">
        <input id="userMsg-gemini" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi..." autocomplete="off" onkeydown="if(event.key==='Enter'){sendMsgGemini();}">
        <button onclick="sendMsgGemini()">G·ª≠i</button>
      </div>
    </div>
  </main>

  <!-- Popup nh·∫≠p API Key -->
  <div class="popup-api-bg" id="popup-api" style="display:none;">
    <div class="popup-api-box">
      <label for="popup-api-key">API Key c·ªßa b·∫°n</label>
      <div style="font-size:.95rem;color:#888;margin:6px 0 14px 0;">
        <b>OpenAI:</b> b·∫Øt ƒë·∫ßu b·∫±ng <code>sk-</code><br>
        <b>Gemini:</b> b·∫Øt ƒë·∫ßu b·∫±ng <code>AIza</code><br>
        (L∆∞u v√†o tr√¨nh duy·ªát, kh√¥ng g·ª≠i ƒëi ƒë√¢u)
      </div>
      <input id="popup-api-key" type="password" placeholder="D√°n API Key ·ªü ƒë√¢y...">
      <div class="popup-btns">
        <button onclick="saveAPIKey()">L∆∞u Key</button>
        <button class="cancel" onclick="closeAPIKeyPopup()">H·ªßy</button>
        <button class="cancel" onclick="removeAPIKey()" style="background:#ffebe7;color:#c44;">X√≥a key</button>
      </div>
    </div>
  </div>

  <div id="footer"></div>
  <script src="main.js"></script>
  <script>
    // Tab ch·∫ø ƒë·ªô chat
    let chatMode = 'chatbase';
    function switchMode(mode) {
      chatMode = mode;
      document.querySelectorAll('.mode-btn').forEach((el,i)=>{
        el.classList.toggle('active', (['chatbase','gpt','gemini'][i]===mode));
      });
      document.getElementById('chatbase-chat').style.display = mode==='chatbase'?'block':'none';
      document.getElementById('chatbase-input').style.display = 'none'; // Chatbase kh√¥ng d√πng input custom
      document.getElementById('gpt-chat').style.display = mode==='gpt'?'block':'none';
      document.getElementById('gpt-input').style.display = mode==='gpt'?'flex':'none';
      document.getElementById('gemini-chat').style.display = mode==='gemini'?'block':'none';
      document.getElementById('gemini-input').style.display = mode==='gemini'?'flex':'none';
      scrollToBottom();
    }

    // ---- API Key l∆∞u v√†o LocalStorage ----
    function getAPIKey() {
      return localStorage.getItem('ai_api_key')||'';
    }
    function setAPIKey(key) {
      localStorage.setItem('ai_api_key', key.trim());
    }
    function removeAPIKey() {
      localStorage.removeItem('ai_api_key');
      document.getElementById('popup-api-key').value = '';
      alert('ƒê√£ x√≥a API key kh·ªèi tr√¨nh duy·ªát.');
      closeAPIKeyPopup();
    }
    function openAPIKeyPopup() {
      document.getElementById('popup-api-key').value = getAPIKey();
      document.getElementById('popup-api').style.display = 'flex';
    }
    function closeAPIKeyPopup() {
      document.getElementById('popup-api').style.display = 'none';
    }
    function saveAPIKey() {
      const val = document.getElementById('popup-api-key').value;
      if(val.length < 10) return alert('API key kh√¥ng h·ª£p l·ªá!');
      setAPIKey(val);
      alert('ƒê√£ l∆∞u API key v√†o tr√¨nh duy·ªát!');
      closeAPIKeyPopup();
    }

    // ------ Chat GPT ------
    let gptMsgs = [];
    async function sendMsgGPT() {
      let key = getAPIKey();
      let msg = document.getElementById('userMsg-gpt').value.trim();
      if (!key || !msg) { openAPIKeyPopup(); return; }
      gptMsgs.push({role:'user',content:msg});
      renderChat('gpt-chat', gptMsgs);
      document.getElementById('userMsg-gpt').value = '';
      gptMsgs.push({role:'assistant',content:'<i>ƒêang tr·∫£ l·ªùi...</i>'});
      renderChat('gpt-chat', gptMsgs);
      scrollToBottom();

      try {
        let res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${key}`
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [
              {role:"system",content:"B·∫°n l√† tr·ª£ l√Ω AI h·ªçc t·∫≠p, tr·∫£ l·ªùi ng·∫Øn g·ªçn, th√¢n thi·ªán."},
              ...gptMsgs.filter(m=>m.role==='user')
            ]
          })
        });
        let data = await res.json();
        gptMsgs.pop(); // X√≥a d√≤ng "ƒêang tr·∫£ l·ªùi..."
        let reply = data.choices?.[0]?.message?.content || "C√≥ l·ªói x·∫£y ra!";
        gptMsgs.push({role:'assistant',content:reply});
        renderChat('gpt-chat', gptMsgs);
        scrollToBottom();
      } catch (e) {
        gptMsgs.pop();
        gptMsgs.push({role:'assistant',content:'L·ªói g·ªçi API!'});
        renderChat('gpt-chat', gptMsgs);
      }
    }

    // ------ Chat Gemini ------
    let geminiMsgs = [];
    async function sendMsgGemini() {
      let key = getAPIKey();
      let msg = document.getElementById('userMsg-gemini').value.trim();
      if (!key || !msg) { openAPIKeyPopup(); return; }
      geminiMsgs.push({role:'user',content:msg});
      renderChat('gemini-chat', geminiMsgs);
      document.getElementById('userMsg-gemini').value = '';
      geminiMsgs.push({role:'assistant',content:'<i>ƒêang tr·∫£ l·ªùi...</i>'});
      renderChat('gemini-chat', geminiMsgs);
      scrollToBottom();

      try {
        let res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${key}`,
          {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              contents: [{parts: [{text: msg}]}]
            })
          }
        );
        let data = await res.json();
        geminiMsgs.pop();
        let reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "C√≥ l·ªói x·∫£y ra!";
        geminiMsgs.push({role:'assistant',content:reply});
        renderChat('gemini-chat', geminiMsgs);
        scrollToBottom();
      } catch (e) {
        geminiMsgs.pop();
        geminiMsgs.push({role:'assistant',content:'L·ªói g·ªçi API!'});
        renderChat('gemini-chat', geminiMsgs);
      }
    }

    // ------ Hi·ªÉn th·ªã l·ªãch s·ª≠ chat ------
    function renderChat(boxId, msgs) {
      let html = '';
      for(let m of msgs){
        let user = (m.role==='user');
        html += `<div class="msg-row ${user?'msg-user':'msg-ai'}">
          <div class="msg-bubble">${m.content}</div>
        </div>`;
      }
      document.getElementById(boxId).innerHTML = html;
    }
    function scrollToBottom() {
      setTimeout(()=>{
        document.querySelectorAll('.chat-messages').forEach(box=>{box.scrollTop = box.scrollHeight+77;});
      }, 70);
    }

    // ---- Auto nh·ªõ API key ƒë√£ nh·∫≠p ----
    window.onload = function() {
      let key = getAPIKey();
      if(key) document.getElementById('popup-api-key').value = key;
    };
  </script>
</body>
</html>
