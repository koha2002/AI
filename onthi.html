<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện Đề</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- FIX: Corrected 'xintegrity' to 'integrity' -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .dark body {
            background-color: #1a1a2e;
        }
        .app-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            flex-grow: 1;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            height: calc(100vh - 3rem - 2rem);
            max-height: 850px;
            display: flex;
            flex-direction: column;
        }
        .dark .card {
            background-color: rgba(26, 26, 46, 0.85);
             border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
             transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .answer-btn {
            background-color: white;
            color: #1f2937;
            border: 2px solid #d1d5db;
        }
        .answer-btn:hover {
            background-color: #f3f4f6;
        }
        .answer-btn.correct {
            background-color: #28a745 !important; 
            color: white !important; 
            border-color: #28a745 !important;
        }
        .answer-btn.wrong {
            background-color: #dc3545 !important; 
            color: white !important; 
            border-color: #dc3545 !important;
        }
        .timer-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #facc15, #f87171);
            background-size: 200%;
            transition: width 1s linear, background-position 1s linear;
            border-radius: 8px;
        }
        .custom-control input { display: none; }
        .custom-control span {
            height: 20px; width: 20px; border: 2px solid #9ca3af;
            display: inline-block; position: relative; cursor: pointer;
        }
        .custom-radio span { border-radius: 50%; }
        .custom-checkbox span { border-radius: 4px; }
        .custom-control input:checked + span { border-color: #28a745; background-color: #28a745; }
        .custom-control input:checked + span::after {
            content: ''; position: absolute;
        }
        .custom-radio input:checked + span::after {
            width: 8px; height: 8px; background: white; border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .custom-checkbox input:checked + span::after {
            left: 6px; top: 2px; width: 5px; height: 10px;
            border: solid white; border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }
    </style>
</head>
<body class="dark:bg-gray-900 text-black">

    <header id="main-header"></header>

    <div class="app-container">
        <div class="w-full max-w-screen-xl mx-auto z-10">

            <div id="home-screen" class="card p-8 rounded-2xl shadow-2xl text-black">
                <div class="text-center flex-shrink-0">
                    <i class="fas fa-rocket text-5xl text-purple-500 mb-4"></i>
                    <h1 class="text-4xl font-bold mb-2">Chào mừng đến Quiz Vui!</h1>
                    <p class="text-lg text-black mb-6">Chọn một quiz để bắt đầu hoặc tạo quiz của riêng bạn.</p>
                </div>
                <div class="my-8 flex-grow flex flex-col min-h-0">
                    <h2 class="text-2xl font-bold mb-4 text-center flex-shrink-0">Danh sách Quiz có sẵn</h2>
                    <div id="quiz-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 flex-grow overflow-y-auto p-2">
                    </div>
                </div>
                <div class="text-center mt-auto flex-shrink-0 pt-4">
                     <button id="import-quiz-btn" class="btn bg-orange-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-orange-600 shadow-lg">
                         <i class="fas fa-upload mr-2"></i> Nhập Quiz từ file
                     </button>
                     <button id="go-to-creator-btn" class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 shadow-lg">
                         <i class="fas fa-plus mr-2"></i> Tạo Quiz Mới
                     </button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
            </div>

            <div id="player-name-screen" class="hidden card p-8 rounded-2xl shadow-2xl text-center text-black justify-center">
                 <h1 class="text-3xl font-bold mb-4">Sẵn sàng chơi!</h1>
                 <p class="mb-6 text-lg">Nhập tên và chọn chế độ chơi.</p>
                 
                 <div class="w-full max-w-md mx-auto space-y-6">
                      <input type="text" id="player-name" placeholder="Nhập tên của bạn..." class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                      
                      <div class="text-left">
                           <h3 class="font-bold text-lg mb-2">Chế độ chơi</h3>
                           <div class="flex gap-4">
                               <label class="custom-control custom-radio flex items-center gap-2 cursor-pointer"><input type="radio" name="game-mode" value="test" checked><span></span>Kiểm tra</label>
                               <label class="custom-control custom-radio flex items-center gap-2 cursor-pointer"><input type="radio" name="game-mode" value="practice"><span></span>Luyện tập</label>
                           </div>
                      </div>

                      <div id="timer-settings" class="text-left">
                           <h3 class="font-bold text-lg mb-2">Cài đặt thời gian</h3>
                           <div class="flex items-center gap-2 mb-2">
                                <label class="custom-control custom-checkbox flex items-center gap-2 cursor-pointer"><input type="checkbox" id="timer-enabled" checked><span></span>Đếm ngược thời gian</label>
                           </div>
                           <div id="timer-options" class="flex items-center gap-2">
                               <input type="number" id="time-value" value="15" class="w-20 px-2 py-1 rounded border-2 border-gray-300">
                               <select id="time-unit" class="px-2 py-1 rounded border-2 border-gray-300">
                                   <option value="seconds">giây</option>
                                   <option value="minutes">phút</option>
                               </select>
                               <span>/ câu</span>
                           </div>
                      </div>

                      <div class="flex flex-col sm:flex-row gap-4 pt-4">
                          <button id="back-from-player-name-btn" class="btn w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 shadow-lg"><i class="fas fa-arrow-left mr-2"></i>Quay lại</button>
                          <button id="start-btn" class="btn w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 shadow-lg">Bắt đầu<i class="fas fa-play ml-2"></i></button>
                      </div>
                 </div>
            </div>
            
            <div id="quiz-screen" class="hidden card p-6 sm:p-8 rounded-2xl shadow-2xl text-black justify-center">
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-lg font-bold">Câu hỏi: <span id="question-progress">1/10</span></div>
                        <div class="text-lg font-bold text-green-500">Đúng: <span id="score-percent">0%</span></div>
                    </div>
                    <div id="timer-container" class="w-full bg-gray-300 dark:bg-gray-700 rounded-full h-4 mb-6 shadow-inner">
                        <div id="timer-bar" class="timer-bar-inner"></div>
                    </div>
                    
                    <div class="text-center mb-4">
                        <img id="quiz-question-image" src="" alt="Ảnh câu hỏi" class="max-h-60 mx-auto rounded-lg shadow-md hidden">
                    </div>

                    <div class="min-h-[100px] flex items-center justify-center">
                         <h2 id="question-text" class="text-2xl md:text-3xl font-bold my-6 text-center"></h2>
                    </div>
                    <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6"></div>
                </div>
            </div>

            <div id="end-screen" class="hidden card p-8 rounded-2xl shadow-2xl text-black flex flex-col">
                <!-- Main result section -->
                <div class="text-center">
                    <i class="fas fa-trophy text-6xl text-yellow-400 mb-4"></i>
                    <h1 id="end-title" class="text-4xl font-bold mb-2">Hoàn thành!</h1>
                    <p class="text-xl text-black mb-1">Chúc mừng, <span id="player-name-final" class="font-bold text-purple-500"></span>!</p>
                    <p id="end-message" class="text-2xl mb-6">Tỷ lệ đúng của bạn là: <span id="final-score-percent" class="font-bold text-green-500">0%</span></p>
                </div>

                <!-- Wrong answers review section -->
                <div id="wrong-answers-container" class="hidden mt-4 pt-4 border-t-2 border-gray-200 dark:border-gray-700 flex-grow flex flex-col min-h-0">
                    <h3 class="text-xl font-bold mb-2 text-center flex-shrink-0">Xem lại các câu sai từ lần đầu</h3>
                    <div id="wrong-answers-list" class="space-y-2 overflow-y-auto pr-2">
                        <!-- Content will be generated by JS -->
                    </div>
                </div>

                <!-- Action button -->
                <div class="mt-auto pt-6 text-center flex-shrink-0">
                    <button id="back-to-home-btn" class="btn bg-purple-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-purple-700 shadow-lg">
                        Về trang chủ
                    </button>
                </div>
            </div>

            <div id="creator-screen" class="hidden card p-8 rounded-2xl shadow-2xl text-black">
                <!-- Fixed Title -->
                <div class="flex-shrink-0">
                    <h1 id="creator-title" class="text-3xl font-bold mb-6 text-center">Tạo Quiz Mới</h1>
                </div>

                <!-- Scrollable Main Content -->
                <div class="flex-grow min-h-0 overflow-y-auto -mr-6 pr-6">
                    <div class="mb-6">
                        <label for="quiz-title" class="block text-lg font-medium mb-2 text-black">Tên bộ câu hỏi:</label>
                        <input type="text" id="quiz-title" placeholder="Ví dụ: Lịch sử Việt Nam" class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <div class="border-t border-gray-300 dark:border-gray-600 pt-6">
                        <h2 id="question-editor-title" class="text-2xl font-bold mb-4">Thêm câu hỏi mới</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="new-question" class="block font-medium mb-1 text-black">Nội dung câu hỏi:</label>
                                <input type="text" id="new-question" class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            
                            <div class="mt-4">
                                <label for="new-question-image-input" class="block font-medium mb-1 text-black">Ảnh minh họa (tùy chọn):</label>
                                <input type="file" id="new-question-image-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <img id="question-image-preview" src="" alt="Xem trước ảnh" class="mt-2 rounded max-h-40 hidden">
                                <button id="remove-image-btn" class="hidden mt-2 text-xs text-red-500 hover:text-red-700">Xóa ảnh</button>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block font-medium text-black">Các lựa chọn (chọn câu trả lời đúng):</label>
                                <div class="flex items-center space-x-2"><input type="text" name="answer" placeholder="Lựa chọn 1" class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500"><label class="custom-control custom-radio"><input type="radio" name="correct-answer" value="0" checked><span></span></label></div>
                                <div class="flex items-center space-x-2"><input type="text" name="answer" placeholder="Lựa chọn 2" class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500"><label class="custom-control custom-radio"><input type="radio" name="correct-answer" value="1"><span></span></label></div>
                                <div class="flex items-center space-x-2"><input type="text" name="answer" placeholder="Lựa chọn 3" class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500"><label class="custom-control custom-radio"><input type="radio" name="correct-answer" value="2"><span></span></label></div>
                                <div class="flex items-center space-x-2"><input type="text" name="answer" placeholder="Lựa chọn 4" class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500"><label class="custom-control custom-radio"><input type="radio" name="correct-answer" value="3"><span></span></label></div>
                            </div>
                            <button id="add-question-btn" class="btn w-full bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600">Thêm câu hỏi này</button>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-2">Các câu hỏi đã thêm: <span id="question-count">0</span></h3>
                        <div id="questions-preview" class="space-y-2 p-2 bg-gray-100 dark:bg-gray-800 rounded min-h-[120px]">
                        </div>
                    </div>
                </div>

                <!-- Fixed Buttons -->
                <div class="flex-shrink-0 pt-4 mt-auto">
                    <div class="flex justify-between">
                        <button id="cancel-creation-btn" class="btn bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600">Hủy</button>
                        <button id="save-quiz-btn" class="btn bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700">Lưu và Tải về</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer id="main-footer"></footer>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadComponents = () => {
                const headerPlaceholder = document.getElementById('main-header');
                const footerPlaceholder = document.getElementById('main-footer');
                
                Promise.all([
                    fetch('mini-header.html').then(response => response.ok ? response.text() : ''),
                    fetch('footer.html').then(response => response.ok ? response.text() : '')
                ])
                .then(([headerHtml, footerHtml]) => {
                    if (headerPlaceholder && headerHtml) headerPlaceholder.innerHTML = headerHtml;
                    if (footerPlaceholder && footerHtml) footerPlaceholder.innerHTML = footerHtml;
                })
                .catch(error => console.error('Error loading components:', error));
            };

            // --- DOM ELEMENTS ---
            const screens = { home: document.getElementById('home-screen'), playerName: document.getElementById('player-name-screen'), quiz: document.getElementById('quiz-screen'), end: document.getElementById('end-screen'), creator: document.getElementById('creator-screen') };
            const playerNameInput = document.getElementById('player-name');
            const startBtn = document.getElementById('start-btn');
            const backToHomeBtn = document.getElementById('back-to-home-btn');
            const backFromPlayerNameBtn = document.getElementById('back-from-player-name-btn');
            
            // Settings UI
            const gameModeRadios = document.querySelectorAll('input[name="game-mode"]');
            const timerSettingsDiv = document.getElementById('timer-settings');
            const timerEnabledCheckbox = document.getElementById('timer-enabled');
            const timerOptionsDiv = document.getElementById('timer-options');
            const timeValueInput = document.getElementById('time-value');
            const timeUnitSelect = document.getElementById('time-unit');

            // Quiz UI
            const questionProgress = document.getElementById('question-progress');
            const scorePercentDisplay = document.getElementById('score-percent');
            const timerContainer = document.getElementById('timer-container');
            const timerBar = document.getElementById('timer-bar');
            const questionText = document.getElementById('question-text');
            const quizQuestionImage = document.getElementById('quiz-question-image');
            const answerButtonsContainer = document.getElementById('answer-buttons');
            const endTitle = document.getElementById('end-title');
            const endMessage = document.getElementById('end-message');
            const playerNameFinal = document.getElementById('player-name-final');
            const finalScorePercentDisplay = document.getElementById('final-score-percent');
            const quizListContainer = document.getElementById('quiz-list');
            const wrongAnswersContainer = document.getElementById('wrong-answers-container');
            const wrongAnswersList = document.getElementById('wrong-answers-list');

            // Creator UI
            const goToCreatorBtn = document.getElementById('go-to-creator-btn');
            const importQuizBtn = document.getElementById('import-quiz-btn');
            const importFileInput = document.getElementById('import-file-input');
            const creatorTitle = document.getElementById('creator-title');
            const quizTitleInput = document.getElementById('quiz-title');
            const questionEditorTitle = document.getElementById('question-editor-title');
            const newQuestionInput = document.getElementById('new-question');
            const newQuestionImageInput = document.getElementById('new-question-image-input');
            const questionImagePreview = document.getElementById('question-image-preview');
            const removeImageBtn = document.getElementById('remove-image-btn');
            const answerInputs = document.querySelectorAll('input[name="answer"]');
            const correctRadioBtns = document.querySelectorAll('input[name="correct-answer"]');
            const addQuestionBtn = document.getElementById('add-question-btn');
            const questionsPreview = document.getElementById('questions-preview');
            const questionCount = document.getElementById('question-count');
            const saveQuizBtn = document.getElementById('save-quiz-btn');
            const cancelCreationBtn = document.getElementById('cancel-creation-btn');

            // --- QUIZ DATA & STATE ---
            const defaultQuiz = [{ title: "Kiến Thức Chung", questions: [ { question: "Đâu là thủ đô của Việt Nam?", answers: [{ text: "TP. Hồ Chí Minh", correct: false }, { text: "Đà Nẵng", correct: false }, { text: "Hà Nội", correct: true }, { text: "Hải Phòng", correct: false }] }, { question: "Hành tinh nào được biết đến với tên gọi 'Hành tinh Đỏ'?", answers: [{ text: "Sao Kim", correct: false }, { text: "Sao Hỏa", correct: true }, { text: "Sao Mộc", correct: false }, { text: "Sao Thổ", correct: false }] } ] }];
            let allQuizzes = [];
            let currentQuizData = [];
            let newQuizQuestions = [];
            let wronglyAnsweredQuestions = [];
            let initialWrongAnswers = [];
            let questionAttemptCounts; // FEATURE: To track attempts for each question
            let correctAnswersCount, totalQuestionsInRound, originalTotalQuestions;
            let currentQuestionIndex, timerInterval, playerName, selectedQuizIndex, isInitialRound;
            let gameMode, isTimerEnabled, timePerQuestion;
            let editingQuizIndex = null, editingQuestionIndex = null;
            let currentImageBase64 = null;

            // --- CORE FUNCTIONS ---
            function showScreen(screenName) { Object.values(screens).forEach(screen => screen.classList.add('hidden')); screens[screenName].classList.remove('hidden'); }
            function loadQuizzesFromStorage() { const storedQuizzes = localStorage.getItem('allQuizzes'); try { allQuizzes = storedQuizzes ? JSON.parse(storedQuizzes) : defaultQuiz; } catch (e) { allQuizzes = defaultQuiz; } renderQuizList(); }
            function saveQuizzesToStorage() { localStorage.setItem('allQuizzes', JSON.stringify(allQuizzes)); }

            function renderQuizList() {
                quizListContainer.innerHTML = '';
                if (allQuizzes.length === 0) { quizListContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">Chưa có quiz nào. Hãy tạo một cái!</p>`; return; }
                allQuizzes.forEach((quiz, index) => {
                    const quizCardContainer = document.createElement('div'); quizCardContainer.className = 'relative group';
                    const quizCard = document.createElement('div'); quizCard.className = 'p-4 rounded-lg text-white text-center cursor-pointer btn h-full flex flex-col justify-center min-h-[120px]'; quizCard.style.background = `linear-gradient(45deg, hsl(${index*50}, 60%, 50%), hsl(${index*50 + 60}, 60%, 50%))`; quizCard.innerHTML = `<h3 class="text-xl font-bold">${quiz.title}</h3><p>${quiz.questions.length} câu hỏi</p>`;
                    quizCard.addEventListener('click', () => { selectedQuizIndex = index; showScreen('playerName'); });
                    const controls = document.createElement('div'); controls.className = 'absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity';
                    const editBtn = document.createElement('button'); editBtn.className = 'bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center btn'; editBtn.innerHTML = '<i class="fas fa-pencil-alt fa-xs"></i>'; editBtn.title = 'Sửa quiz này'; editBtn.addEventListener('click', (e) => { e.stopPropagation(); startEditingQuiz(index); });
                    const deleteBtn = document.createElement('button'); deleteBtn.className = 'bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center btn'; deleteBtn.innerHTML = '<i class="fas fa-trash-alt fa-xs"></i>'; deleteBtn.title = 'Xóa quiz này'; deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`Bạn có chắc muốn xóa bộ câu hỏi "${quiz.title}" không?`)) { deleteQuiz(index); } });
                    controls.appendChild(editBtn); controls.appendChild(deleteBtn); quizCardContainer.appendChild(quizCard); quizCardContainer.appendChild(controls); quizListContainer.appendChild(quizCardContainer);
                });
            }

            function deleteQuiz(index) { allQuizzes.splice(index, 1); saveQuizzesToStorage(); renderQuizList(); }
            function exportQuizToJson(quizData) { const dataStr = JSON.stringify(quizData, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${quizData.title.replace(/\s+/g, '_')}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }

            // --- QUIZ GAME LOGIC ---
            function startGame() {
                playerName = playerNameInput.value || "Người chơi";
                gameMode = document.querySelector('input[name="game-mode"]:checked').value;
                isTimerEnabled = timerEnabledCheckbox.checked;
                
                let timeValue = parseInt(timeValueInput.value) || 15;
                timePerQuestion = timeUnitSelect.value === 'minutes' ? timeValue * 60 : timeValue;

                currentQuizData = [...allQuizzes[selectedQuizIndex].questions].sort(() => Math.random() - 0.5);
                
                originalTotalQuestions = currentQuizData.length;
                totalQuestionsInRound = currentQuizData.length; 
                
                wronglyAnsweredQuestions = [];
                initialWrongAnswers = [];
                isInitialRound = true;
                questionAttemptCounts = {}; // FEATURE: Initialize attempt tracker
                correctAnswersCount = 0;
                currentQuestionIndex = 0;

                // FEATURE: Set initial attempt count for all questions to 1
                currentQuizData.forEach(q => {
                    questionAttemptCounts[q.question] = 1;
                });
                
                showScreen('quiz');
                setNextQuestion();
            }

            function setNextQuestion() {
                resetState();
                if (currentQuestionIndex < currentQuizData.length) {
                    showQuestion(currentQuizData[currentQuestionIndex]);
                } else {
                    if (gameMode === 'practice' && wronglyAnsweredQuestions.length > 0) {
                        alert(`Bạn đã trả lời sai ${wronglyAnsweredQuestions.length} câu. Hãy làm lại những câu đó!`);
                        isInitialRound = false;
                        currentQuizData = [...wronglyAnsweredQuestions];
                        
                        // FEATURE: Increment attempt count for questions being retried
                        currentQuizData.forEach(q => {
                            questionAttemptCounts[q.question]++;
                        });

                        totalQuestionsInRound = currentQuizData.length;
                        wronglyAnsweredQuestions = [];
                        currentQuestionIndex = 0;
                        setNextQuestion();
                    } else {
                        endGame();
                    }
                }
            }
            
            function showQuestion(questionData) {
                questionProgress.textContent = `${currentQuestionIndex + 1}/${totalQuestionsInRound}`;
                
                const percent = originalTotalQuestions > 0 ? Math.round((correctAnswersCount / originalTotalQuestions) * 100) : 0;
                scorePercentDisplay.textContent = `${percent}%`;
                questionText.textContent = questionData.question;
                
                if (questionData.image) {
                    quizQuestionImage.src = questionData.image;
                    quizQuestionImage.classList.remove('hidden');
                } else {
                    quizQuestionImage.src = '';
                    quizQuestionImage.classList.add('hidden');
                }
                
                const answerShapes = ['fa-triangle', 'fa-diamond', 'fa-square', 'fa-circle'];
                
                questionData.answers.forEach((answer, index) => {
                    const button = document.createElement('button');
                    const iconColorClass = ['text-red-500', 'text-blue-500', 'text-yellow-500', 'text-green-500'][index];
                    button.innerHTML = `<i class="fa-solid ${answerShapes[index]} mr-3 ${iconColorClass}"></i><span>${answer.text}</span>`;
                    button.className = `answer-btn w-full font-bold py-4 px-5 rounded-lg text-left flex items-center text-lg btn`;
                    
                    if (answer.correct) button.dataset.correct = true;
                    button.addEventListener('click', selectAnswer);
                    answerButtonsContainer.appendChild(button);
                });

                if (gameMode === 'test' && isTimerEnabled) {
                    timerContainer.classList.remove('hidden');
                    startTimer();
                } else {
                    timerContainer.classList.add('hidden');
                }
            }

            function resetState() {
                clearInterval(timerInterval);
                answerButtonsContainer.innerHTML = '';
                quizQuestionImage.classList.add('hidden');
                quizQuestionImage.src = '';
            }

            function selectAnswer(e) {
                clearInterval(timerInterval);
                const selectedBtn = e.currentTarget;
                const isCorrect = selectedBtn.dataset.correct === 'true';

                if (isCorrect) {
                    correctAnswersCount++;
                } else {
                    if (isInitialRound) {
                        initialWrongAnswers.push(currentQuizData[currentQuestionIndex]);
                    }
                    if (gameMode === 'practice') {
                        wronglyAnsweredQuestions.push(currentQuizData[currentQuestionIndex]);
                    }
                }
                
                Array.from(answerButtonsContainer.children).forEach(button => {
                    if (button.dataset.correct) {
                        button.classList.add('correct');
                    } else if (button === selectedBtn) {
                        button.classList.add('wrong');
                    }
                    button.disabled = true;
                });

                setTimeout(() => {
                    currentQuestionIndex++;
                    setNextQuestion();
                }, 1500);
            }

            function startTimer() {
                let timeLeft = timePerQuestion;
                timerBar.style.width = '100%'; timerBar.style.backgroundPosition = '0%';
                timerInterval = setInterval(() => {
                    timeLeft--;
                    const widthPercentage = (timeLeft / timePerQuestion) * 100;
                    timerBar.style.width = `${widthPercentage}%`; timerBar.style.backgroundPosition = `${100 - widthPercentage}%`;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        Array.from(answerButtonsContainer.children).forEach(button => { 
                            if (button.dataset.correct) button.classList.add('correct'); 
                            button.disabled = true; 
                        });
                        setTimeout(() => { currentQuestionIndex++; setNextQuestion(); }, 1500);
                    }
                }, 1000);
            }

            function endGame() {
                showScreen('end');
                playerNameFinal.textContent = playerName;
                const totalQuestions = allQuizzes[selectedQuizIndex].questions.length;
                const finalPercent = totalQuestions > 0 ? Math.round((correctAnswersCount / totalQuestions) * 100) : 0;
                
                if (gameMode === 'practice' && initialWrongAnswers.length === 0) {
                    endTitle.textContent = "Luyện tập hoàn tất!";
                    endMessage.innerHTML = `Chúc mừng bạn đã trả lời đúng 100% tất cả các câu hỏi!`;
                } else {
                    endTitle.textContent = "Hoàn thành!";
                    endMessage.innerHTML = `Tỷ lệ đúng của bạn là: <span id="final-score-percent" class="font-bold text-green-500">${finalPercent}%</span>`;
                }

                wrongAnswersList.innerHTML = '';
                if (initialWrongAnswers.length > 0) {
                    wrongAnswersContainer.classList.remove('hidden');
                    initialWrongAnswers.forEach(q => {
                        const correctAnswer = q.answers.find(a => a.correct).text;
                        const attempts = questionAttemptCounts[q.question] || 1; // FEATURE: Get attempt count for the specific question
                        const item = document.createElement('div');
                        item.className = 'text-left p-3 bg-red-100 dark:bg-red-900/50 rounded-lg shadow-sm';
                        item.innerHTML = `
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-gray-800 dark:text-gray-200 flex-1 pr-2">${q.question}</p>
                                ${attempts > 1 ? `<span class="text-xs font-semibold text-white bg-red-500 rounded-full px-2 py-1 flex-shrink-0" title="Số lần làm lại">${attempts} lần</span>` : ''}
                            </div>
                            <p class="text-sm text-green-700 dark:text-green-400 font-semibold mt-1">Đáp án đúng: ${correctAnswer}</p>
                        `;
                        wrongAnswersList.appendChild(item);
                    });
                } else {
                    wrongAnswersContainer.classList.add('hidden');
                }
            }

            // --- QUIZ CREATOR LOGIC ---
            function resetCreatorForm() { editingQuizIndex = null; creatorTitle.textContent = 'Tạo Quiz Mới'; saveQuizBtn.textContent = 'Lưu và Tải về'; quizTitleInput.value = ''; newQuizQuestions = []; updateQuestionPreview(); resetQuestionForm(); }
            
            function resetQuestionForm() {
                editingQuestionIndex = null;
                questionEditorTitle.textContent = 'Thêm câu hỏi mới';
                addQuestionBtn.textContent = 'Thêm câu hỏi này';
                addQuestionBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                addQuestionBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                newQuestionInput.value = '';
                answerInputs.forEach(input => input.value = '');
                correctRadioBtns[0].checked = true;
                newQuestionImageInput.value = '';
                questionImagePreview.classList.add('hidden');
                questionImagePreview.src = '';
                removeImageBtn.classList.add('hidden');
                currentImageBase64 = null;
            }
            
            function updateQuestionPreview() {
                questionsPreview.innerHTML = '';
                questionCount.textContent = newQuizQuestions.length;
                newQuizQuestions.forEach((q, index) => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-1 bg-gray-200 dark:bg-gray-700 rounded text-sm';
                    let previewText = `<span class="flex-1 mr-2 truncate">${index + 1}. `;
                    if (q.image) {
                        previewText += `<i class="fas fa-image text-blue-400 mr-1"></i>`;
                    }
                    previewText += `${q.question}</span>`;
                    item.innerHTML = `${previewText}<div class="flex gap-2 flex-shrink-0"><button data-edit-question="${index}" class="text-blue-500 hover:text-blue-700"><i class="fas fa-pencil-alt fa-xs"></i></button><button data-delete-question="${index}" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                    questionsPreview.appendChild(item);
                });
            }
            
            questionsPreview.addEventListener('click', (e) => {
                const editBtn = e.target.closest('[data-edit-question]'); const deleteBtn = e.target.closest('[data-delete-question]');
                if (editBtn) { loadQuestionForEdit(parseInt(editBtn.dataset.editQuestion)); }
                if (deleteBtn) { if (confirm('Bạn có chắc muốn xóa câu hỏi này?')) { deleteQuestion(parseInt(deleteBtn.dataset.deleteQuestion)); } }
            });

            function loadQuestionForEdit(index) {
                resetQuestionForm();
                editingQuestionIndex = index;
                const questionData = newQuizQuestions[index];
                questionEditorTitle.textContent = `Sửa câu hỏi ${index + 1}`;
                addQuestionBtn.textContent = 'Cập nhật câu hỏi';
                addQuestionBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                addQuestionBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                newQuestionInput.value = questionData.question;
                questionData.answers.forEach((ans, i) => { answerInputs[i].value = ans.text; if (ans.correct) { correctRadioBtns[i].checked = true; } });
                if (questionData.image) {
                    questionImagePreview.src = questionData.image;
                    questionImagePreview.classList.remove('hidden');
                    removeImageBtn.classList.remove('hidden');
                    currentImageBase64 = questionData.image;
                }
            }
            
            function deleteQuestion(index) { newQuizQuestions.splice(index, 1); updateQuestionPreview(); if(editingQuestionIndex === index) { resetQuestionForm(); } }
            
            function startEditingQuiz(index) {
                resetCreatorForm(); editingQuizIndex = index; const quizToEdit = allQuizzes[index];
                creatorTitle.textContent = `Chỉnh sửa Quiz: ${quizToEdit.title}`; saveQuizBtn.textContent = 'Lưu thay đổi và Tải về';
                quizTitleInput.value = quizToEdit.title; newQuizQuestions = JSON.parse(JSON.stringify(quizToEdit.questions));
                updateQuestionPreview(); showScreen('creator');
            }

            addQuestionBtn.addEventListener('click', () => {
                const question = newQuestionInput.value.trim();
                const answers = Array.from(answerInputs).map(input => input.value.trim());
                const correctIndex = document.querySelector('input[name="correct-answer"]:checked').value;
                if (!question || answers.some(a => a === '')) { alert('Vui lòng điền đầy đủ nội dung câu hỏi và các lựa chọn.'); return; }
                
                const questionData = {
                    question: question,
                    image: currentImageBase64,
                    answers: answers.map((text, index) => ({ text: text, correct: index == correctIndex }))
                };
                
                if (editingQuestionIndex !== null) { newQuizQuestions[editingQuestionIndex] = questionData; } else { newQuizQuestions.push(questionData); }
                updateQuestionPreview(); resetQuestionForm(); newQuestionInput.focus();
            });

            saveQuizBtn.addEventListener('click', () => {
                const title = quizTitleInput.value.trim();
                if (!title) { alert('Vui lòng nhập tên cho bộ câu hỏi.'); return; }
                if (newQuizQuestions.length === 0) { alert('Vui lòng thêm ít nhất một câu hỏi.'); return; }
                const newQuiz = { title: title, questions: newQuizQuestions };
                if (editingQuizIndex !== null) { allQuizzes[editingQuizIndex] = newQuiz; alert('Đã cập nhật quiz thành công!'); } else { allQuizzes.push(newQuiz); }
                exportQuizToJson(newQuiz); saveQuizzesToStorage(); renderQuizList(); showScreen('home');
            });
            
            importQuizBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedQuiz = JSON.parse(e.target.result);
                        if (importedQuiz.title && Array.isArray(importedQuiz.questions)) { allQuizzes.push(importedQuiz); saveQuizzesToStorage(); renderQuizList(); alert(`Đã nhập thành công quiz: "${importedQuiz.title}"`); } else { alert('File JSON không hợp lệ.'); }
                    } catch (error) { alert('Lỗi khi đọc file. Vui lòng kiểm tra lại file JSON.'); }
                };
                reader.readAsText(file); importFileInput.value = '';
            });
            
            newQuestionImageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) { return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImageBase64 = e.target.result;
                    questionImagePreview.src = e.target.result;
                    questionImagePreview.classList.remove('hidden');
                    removeImageBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            });
            
            removeImageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                newQuestionImageInput.value = '';
                questionImagePreview.classList.add('hidden');
                questionImagePreview.src = '';
                removeImageBtn.classList.add('hidden');
                currentImageBase64 = null;
            });

            // --- EVENT LISTENERS ---
            startBtn.addEventListener('click', startGame);
            backToHomeBtn.addEventListener('click', () => showScreen('home'));
            backFromPlayerNameBtn.addEventListener('click', () => showScreen('home'));
            goToCreatorBtn.addEventListener('click', () => { resetCreatorForm(); showScreen('creator'); });
            cancelCreationBtn.addEventListener('click', () => { showScreen('home'); });
            
            gameModeRadios.forEach(radio => radio.addEventListener('change', () => {
                timerSettingsDiv.style.display = radio.value === 'test' ? 'block' : 'none';
            }));
            timerEnabledCheckbox.addEventListener('change', () => {
                timerOptionsDiv.style.display = timerEnabledCheckbox.checked ? 'flex' : 'none';
            });

            // --- INITIALIZATION ---
            loadComponents();
            loadQuizzesFromStorage();
            showScreen('home');
        });
    </script>
</body>
</html>
