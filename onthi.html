<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện Đề</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .dark body {
            background-color: #1a1a2e;
        }
        .app-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            flex-grow: 1;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            height: calc(100vh - 3rem - 2rem);
            max-height: 850px;
            display: flex;
            flex-direction: column;
        }
        .dark .card {
            background-color: rgba(26, 26, 46, 0.85);
             border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn {
             transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .answer-btn {
            background-color: white;
            color: #1f2937;
            border: 2px solid #d1d5db;
        }
        .answer-btn:hover {
            background-color: #f3f4f6;
        }
        .answer-btn.correct {
            background-color: #28a745 !important; 
            color: white !important; 
            border-color: #28a745 !important;
        }
        .answer-btn.wrong {
            background-color: #dc3545 !important; 
            color: white !important; 
            border-color: #dc3545 !important;
        }
        .answer-btn.selected {
            background-color: #667eea !important;
            color: white !important;
            border-color: #5a67d8 !important;
        }
        .timer-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #facc15, #f87171);
            background-size: 200%;
            transition: width 1s linear, background-position 1s linear;
            border-radius: 8px;
        }
        .custom-control input { display: none; }
        .custom-control span {
            height: 28px;
            width: 28px;
            border: 2px solid #9ca3af;
            display: inline-block;
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
        }
        .custom-radio span, .custom-checkbox span {
            border-radius: 50%;
        }
        .custom-checkbox span {
            border-radius: 4px;
        }
        .custom-control input:checked + span { border-color: #28a745; background-color: #28a745; }
        .custom-control input:checked + span::after {
            content: ''; position: absolute;
        }
        .custom-radio input:checked + span::after {
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .custom-checkbox input:checked + span::after {
            left: 9px;
            top: 4px;
            width: 8px;
            height: 15px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }
        .question-preview-item.dragging {
            opacity: 0.5;
            background: #e0e0e0;
        }
        .question-preview-item.drag-over {
            border-top: 2px dashed #3498db;
        }
        .rich-text-editor {
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            min-height: 100px;
            background-color: white;
            color: black;
        }
        .rich-text-editor:focus-within {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        .rich-text-toolbar button {
            width: 32px;
            height: 32px;
            border-radius: 0.25rem;
        }
        .rich-text-toolbar button.active {
            background-color: #e0e7ff;
            color: #4f46e5;
        }
    </style>
</head>
<body class="dark:bg-gray-900 text-black">

    <header id="main-header"></header>

    <div class="app-container">
        <div class="w-full max-w-screen-xl mx-auto z-10">

            <div id="home-screen" class="card p-8 rounded-2xl shadow-2xl text-black">
                <div class="text-center flex-shrink-0">
                    <i class="fas fa-rocket text-5xl text-purple-500 mb-4"></i>
                    <h1 class="text-4xl font-bold mb-2">Chào mừng đến Quiz Vui!</h1>
                    <p class="text-lg text-black mb-6">Chọn một quiz để bắt đầu hoặc tạo quiz của riêng bạn.</p>
                </div>
                <div class="my-8 flex-grow flex flex-col min-h-0">
                    <h2 class="text-2xl font-bold mb-4 text-center flex-shrink-0">Danh sách Quiz có sẵn</h2>
                    <div id="quiz-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 flex-grow overflow-y-auto p-2">
                    </div>
                </div>
                <div class="text-center mt-auto flex-shrink-0 pt-4">
                     <button id="import-quiz-btn" class="btn bg-orange-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-orange-600 shadow-lg">
                         <i class="fas fa-upload mr-2"></i> Nhập Quiz từ file
                     </button>
                     <button id="go-to-creator-btn" class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 shadow-lg">
                         <i class="fas fa-plus mr-2"></i> Tạo Quiz Mới
                     </button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
            </div>

            <div id="player-name-screen" class="hidden card p-8 rounded-2xl shadow-2xl text-center text-black justify-center">
                 <h1 class="text-3xl font-bold mb-4">Sẵn sàng chơi!</h1>
                 <p class="mb-6 text-lg">Nhập tên và chọn chế độ chơi.</p>
                 
                 <div class="w-full max-w-md mx-auto space-y-6">
                      <input type="text" id="player-name" placeholder="Nhập tên của bạn..." class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
                      
                      <div class="text-left">
                           <h3 class="font-bold text-lg mb-2">Chế độ chơi</h3>
                           <div class="flex gap-4">
                               <label class="custom-control custom-radio flex items-center gap-2 cursor-pointer"><input type="radio" name="game-mode" value="test" checked><span></span>Kiểm tra</label>
                               <label class="custom-control custom-radio flex items-center gap-2 cursor-pointer"><input type="radio" name="game-mode" value="practice"><span></span>Luyện tập</label>
                           </div>
                      </div>

                      <div class="text-left">
                        <h3 class="font-bold text-lg mb-2">Tùy chọn</h3>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <label class="custom-control custom-checkbox flex items-center gap-2 cursor-pointer"><input type="checkbox" id="shuffle-questions-enabled" checked><span></span>Trộn câu hỏi</label>
                            <label class="custom-control custom-checkbox flex items-center gap-2 cursor-pointer"><input type="checkbox" id="shuffle-answers-enabled" checked><span></span>Trộn đáp án</label>
                        </div>
                   </div>

                      <div id="timer-settings" class="text-left">
                           <h3 class="font-bold text-lg mb-2">Cài đặt thời gian</h3>
                           <div class="flex items-center gap-2 mb-2">
                                <label class="custom-control custom-checkbox flex items-center gap-2 cursor-pointer"><input type="checkbox" id="timer-enabled" checked><span></span>Đếm ngược thời gian</label>
                           </div>
                           <div id="timer-options" class="flex items-center gap-2">
                               <input type="number" id="time-value" value="15" class="w-20 px-2 py-1 rounded border-2 border-gray-300">
                               <select id="time-unit" class="px-2 py-1 rounded border-2 border-gray-300">
                                   <option value="seconds">giây</option>
                                   <option value="minutes">phút</option>
                               </select>
                               <span>/ câu</span>
                           </div>
                      </div>

                      <div class="flex flex-col sm:flex-row gap-4 pt-4">
                          <button id="back-from-player-name-btn" class="btn w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 shadow-lg"><i class="fas fa-arrow-left mr-2"></i>Quay lại</button>
                          <button id="start-btn" class="btn w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 shadow-lg">Bắt đầu<i class="fas fa-play ml-2"></i></button>
                      </div>
                 </div>
            </div>
            
            <div id="quiz-screen" class="hidden card p-6 sm:p-8 rounded-2xl shadow-2xl text-black overflow-hidden flex flex-col">
                <div class="flex-shrink-0">
                    <div id="practice-round-notification" class="hidden text-center bg-yellow-100 text-yellow-800 font-bold p-2 rounded-lg mb-4">
                        Làm lại các câu hỏi đã sai
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-lg font-bold">Câu hỏi: <span id="question-progress">1/10</span></div>
                        <div class="text-lg font-bold text-green-500">Đúng: <span id="score-percent">0%</span></div>
                    </div>
                    <div id="timer-container" class="w-full bg-gray-300 rounded-full h-4 mb-6 shadow-inner">
                        <div id="timer-bar" class="timer-bar-inner"></div>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto pr-2 -mr-4">
                    <div class="text-center mb-4">
                        <img id="quiz-question-image" src="" alt="Ảnh câu hỏi" class="max-h-60 mx-auto rounded-lg shadow-md hidden">
                    </div>

                    <div id="question-text" class="text-2xl md:text-3xl font-bold my-6 text-center"></div>
                    <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6"></div>
                    <div id="submit-multiple-choice-container" class="mt-6 text-center hidden">
                        <button id="submit-multiple-choice-btn" class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700">Nộp bài</button>
                    </div>
                </div>
            </div>

            <div id="end-screen" class="hidden card p-8 rounded-2xl shadow-2xl text-black flex flex-col">
                <div class="text-center">
                    <i class="fas fa-trophy text-6xl text-yellow-400 mb-4"></i>
                    <h1 id="end-title" class="text-4xl font-bold mb-2">Hoàn thành!</h1>
                    <p class="text-xl text-black mb-1">Chúc mừng, <span id="player-name-final" class="font-bold text-purple-500"></span>!</p>
                    <p id="end-message" class="text-2xl mb-2">Tỷ lệ đúng từ lần đầu: <span id="final-score-percent" class="font-bold text-green-500">0%</span></p>
                    <p id="end-counts" class="text-xl mb-6">
                        (<span class="font-semibold text-green-600">Đúng: <span id="correct-count">0</span></span>, 
                        <span class="font-semibold text-red-600">Sai: <span id="wrong-count">0</span></span>)
                    </p>
                </div>

                <div id="wrong-answers-container" class="hidden mt-4 pt-4 border-t-2 border-gray-200 flex-grow flex flex-col min-h-0">
                    <h3 class="text-xl font-bold mb-2 text-center flex-shrink-0">Xem lại các câu sai từ lần đầu</h3>
                    <div id="wrong-answers-list" class="space-y-2 overflow-y-auto pr-2">
                    </div>
                </div>

                <div class="mt-auto pt-6 text-center flex-shrink-0 flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button id="export-wrong-btn" class="hidden btn bg-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-600 shadow-lg w-full sm:w-auto">
                        <i class="fas fa-file-export mr-2"></i>Xuất file câu sai
                    </button>
                    <button id="back-to-home-btn" class="btn bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 shadow-lg w-full sm:w-auto">
                        <i class="fas fa-home mr-2"></i>Về trang chủ
                    </button>
                </div>
            </div>

            <div id="creator-screen" class="hidden card p-8 rounded-2xl shadow-2xl text-black">
                <div class="flex-shrink-0">
                    <h1 id="creator-title" class="text-3xl font-bold mb-6 text-center">Tạo Quiz Mới</h1>
                </div>

                <div class="flex-grow min-h-0 overflow-y-auto -mr-6 pr-6">
                    <div class="mb-6">
                        <label for="quiz-title" class="block text-lg font-medium mb-2">Tên bộ câu hỏi:</label>
                        <input type="text" id="quiz-title" placeholder="Ví dụ: Lịch sử Việt Nam" class="w-full px-4 py-2 rounded-lg border-2 border-gray-300 bg-white text-black focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <div class="border-t border-gray-300 pt-6">
                        <h2 id="question-editor-title" class="text-2xl font-bold mb-4">Thêm câu hỏi mới</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block font-medium mb-1">Nội dung câu hỏi:</label>
                                <div class="rich-text-toolbar flex items-center gap-2 p-2 bg-gray-100 rounded-t-lg border-b-2 border-gray-300">
                                    <button data-command="bold" class="font-bold">B</button>
                                    <button data-command="italic" class="italic">I</button>
                                    <button data-command="underline" class="underline">U</button>
                                </div>
                                <div id="new-question" contenteditable="true" class="rich-text-editor rounded-b-lg p-2 focus:outline-none"></div>
                            </div>
                            
                            <div class="mt-4">
                                <label class="block font-medium mb-1">Ảnh minh họa câu hỏi (tùy chọn):</label>
                                <input type="file" id="new-question-image-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <img id="question-image-preview" src="" alt="Xem trước ảnh" class="mt-2 rounded max-h-40 hidden">
                                <button id="remove-image-btn" class="hidden mt-2 text-xs text-red-500 hover:text-red-700">Xóa ảnh</button>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <label class="block font-medium">Các lựa chọn:</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center gap-2 text-sm"><input type="radio" name="answer-type" value="single" checked> Một đáp án</label>
                                    <label class="flex items-center gap-2 text-sm"><input type="radio" name="answer-type" value="multiple"> Nhiều đáp án</label>
                                </div>
                            </div>

                            <div class="flex items-start gap-4">
                                <div id="answer-editor-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-grow">
                                </div>
                                <button id="add-answer-btn" type="button" class="btn bg-gray-200 text-black rounded-lg h-12 w-12 flex items-center justify-center text-2xl flex-shrink-0 mt-1"><i class="fas fa-plus"></i></button>
                            </div>
                            
                            <button id="add-question-btn" class="btn w-full bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600">Thêm câu hỏi này</button>
                        </div>
                    </div>

                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold">Các câu hỏi đã thêm: <span id="question-count">0</span></h3>
                            <button id="import-questions-btn" class="btn bg-indigo-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-indigo-600 text-sm">
                                <i class="fas fa-file-import mr-2"></i>Bổ sung từ file
                            </button>
                            <input type="file" id="import-questions-input" class="hidden" accept=".json">
                        </div>
                        <div id="questions-preview" class="space-y-2 p-2 bg-gray-100 rounded min-h-[120px]">
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 pt-4 mt-auto">
                    <div class="flex justify-between">
                        <button id="cancel-creation-btn" class="btn bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600">Hủy</button>
                        <button id="save-quiz-btn" class="btn bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700">Lưu và Tải về</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <h2 class="text-2xl font-bold mb-4">Chọn định dạng xuất</h2>
            <p class="mb-6">Xuất tài liệu cho quiz: <strong id="export-quiz-title" class="text-purple-600"></strong></p>
            <div class="flex gap-4 justify-center">
                <button id="export-pdf-btn" class="btn bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600"><i class="fas fa-file-pdf mr-2"></i>Xuất PDF</button>
                <button id="export-doc-btn" class="btn bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600"><i class="fas fa-file-word mr-2"></i>Xuất Word (.docx)</button>
            </div>
            <button id="cancel-export-btn" class="mt-6 text-gray-500 hover:text-gray-700">Hủy</button>
        </div>
    </div>

    <footer id="main-footer"></footer>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadComponents = () => {
                const headerPlaceholder = document.getElementById('main-header');
                const footerPlaceholder = document.getElementById('main-footer');
                
                Promise.all([
                    fetch('mini-header.html').then(response => response.ok ? response.text() : ''),
                    fetch('footer.html').then(response => response.ok ? response.text() : '')
                ])
                .then(([headerHtml, footerHtml]) => {
                    if (headerPlaceholder && headerHtml) headerPlaceholder.innerHTML = headerHtml;
                    if (footerPlaceholder && footerHtml) footerPlaceholder.innerHTML = footerHtml;
                })
                .catch(error => console.error('Error loading components:', error));
            };

            // --- DOM ELEMENTS ---
            const screens = { home: document.getElementById('home-screen'), playerName: document.getElementById('player-name-screen'), quiz: document.getElementById('quiz-screen'), end: document.getElementById('end-screen'), creator: document.getElementById('creator-screen') };
            const playerNameInput = document.getElementById('player-name');
            const startBtn = document.getElementById('start-btn');
            const backToHomeBtn = document.getElementById('back-to-home-btn');
            const backFromPlayerNameBtn = document.getElementById('back-from-player-name-btn');
            
            // Settings UI
            const gameModeRadios = document.querySelectorAll('input[name="game-mode"]');
            const timerSettingsDiv = document.getElementById('timer-settings');
            const timerEnabledCheckbox = document.getElementById('timer-enabled');
            const timerOptionsDiv = document.getElementById('timer-options');
            const timeValueInput = document.getElementById('time-value');
            const timeUnitSelect = document.getElementById('time-unit');
            const shuffleQuestionsCheckbox = document.getElementById('shuffle-questions-enabled');
            const shuffleAnswersCheckbox = document.getElementById('shuffle-answers-enabled');

            // Quiz UI
            const questionProgress = document.getElementById('question-progress');
            const scorePercentDisplay = document.getElementById('score-percent');
            const timerContainer = document.getElementById('timer-container');
            const timerBar = document.getElementById('timer-bar');
            const questionText = document.getElementById('question-text');
            const quizQuestionImage = document.getElementById('quiz-question-image');
            const answerButtonsContainer = document.getElementById('answer-buttons');
            const practiceRoundNotification = document.getElementById('practice-round-notification');
            const submitMultipleChoiceContainer = document.getElementById('submit-multiple-choice-container');
            const submitMultipleChoiceBtn = document.getElementById('submit-multiple-choice-btn');
            const endTitle = document.getElementById('end-title');
            const endMessage = document.getElementById('end-message');
            const playerNameFinal = document.getElementById('player-name-final');
            const finalScorePercentDisplay = document.getElementById('final-score-percent');
            const quizListContainer = document.getElementById('quiz-list');
            const wrongAnswersContainer = document.getElementById('wrong-answers-container');
            const wrongAnswersList = document.getElementById('wrong-answers-list');
            const exportWrongBtn = document.getElementById('export-wrong-btn');
            const correctCountDisplay = document.getElementById('correct-count');
            const wrongCountDisplay = document.getElementById('wrong-count');
            const endCountsContainer = document.getElementById('end-counts');
            const exportModal = document.getElementById('export-modal');
            const exportQuizTitle = document.getElementById('export-quiz-title');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportDocBtn = document.getElementById('export-doc-btn');
            const cancelExportBtn = document.getElementById('cancel-export-btn');

            // Creator UI
            const goToCreatorBtn = document.getElementById('go-to-creator-btn');
            const importQuizBtn = document.getElementById('import-quiz-btn');
            const importFileInput = document.getElementById('import-file-input');
            const creatorTitle = document.getElementById('creator-title');
            const quizTitleInput = document.getElementById('quiz-title');
            const questionEditorTitle = document.getElementById('question-editor-title');
            const newQuestionDiv = document.getElementById('new-question');
            const newQuestionImageInput = document.getElementById('new-question-image-input');
            const questionImagePreview = document.getElementById('question-image-preview');
            const removeImageBtn = document.getElementById('remove-image-btn');
            const answerEditorContainer = document.getElementById('answer-editor-container');
            const addAnswerBtn = document.getElementById('add-answer-btn');
            const addQuestionBtn = document.getElementById('add-question-btn');
            const questionsPreview = document.getElementById('questions-preview');
            const questionCount = document.getElementById('question-count');
            const saveQuizBtn = document.getElementById('save-quiz-btn');
            const cancelCreationBtn = document.getElementById('cancel-creation-btn');
            const importQuestionsBtn = document.getElementById('import-questions-btn');
            const importQuestionsInput = document.getElementById('import-questions-input');
            const richTextToolbar = document.querySelector('.rich-text-toolbar');

            // --- QUIZ DATA & STATE ---
            const defaultQuiz = [{ title: "Kiến Thức Chung", questions: [ { question: "Đâu là thủ đô của Việt Nam?", multiple: false, answers: [{ text: "TP. Hồ Chí Minh", correct: false, image: null }, { text: "Đà Nẵng", correct: false, image: null }, { text: "Hà Nội", correct: true, image: null }, { text: "Hải Phòng", correct: false, image: null }] }, { question: "Hành tinh nào được biết đến với tên gọi 'Hành tinh Đỏ'?", multiple: false, answers: [{ text: "Sao Kim", correct: false, image: null }, { text: "Sao Hỏa", correct: true, image: null }, { text: "Sao Mộc", correct: false, image: null }, { text: "Sao Thổ", correct: false, image: null }] } ] }];
            let allQuizzes = [];
            let currentQuizData = [];
            let newQuizQuestions = [];
            let wronglyAnsweredQuestions = [];
            let initialWrongAnswers = [];
            let questionAttemptCounts;
            let correctAnswersCount, totalQuestionsInRound, originalTotalQuestions, firstRoundCorrectAnswers;
            let currentQuestionIndex, timerInterval, playerName, selectedQuizIndex, isInitialRound;
            let gameMode, isTimerEnabled, timePerQuestion, isShuffleQuestionsEnabled, isShuffleAnswersEnabled;
            let editingQuizIndex = null, editingQuestionIndex = null;
            let currentQuestionImageBase64 = null;
            let draggedItemIndex = null;
            let quizToExportIndex = null;

            // --- CORE FUNCTIONS ---
            function showScreen(screenName) { Object.values(screens).forEach(screen => screen.classList.add('hidden')); screens[screenName].classList.remove('hidden'); }
            function loadQuizzesFromStorage() { const storedQuizzes = localStorage.getItem('allQuizzes'); try { allQuizzes = storedQuizzes ? JSON.parse(storedQuizzes) : defaultQuiz; } catch (e) { allQuizzes = defaultQuiz; } renderQuizList(); }
            function saveQuizzesToStorage() { localStorage.setItem('allQuizzes', JSON.stringify(allQuizzes)); }

            function renderQuizList() {
                quizListContainer.innerHTML = '';
                if (allQuizzes.length === 0) { quizListContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">Chưa có quiz nào. Hãy tạo một cái!</p>`; return; }
                allQuizzes.forEach((quiz, index) => {
                    const quizCardContainer = document.createElement('div'); quizCardContainer.className = 'relative group';
                    const quizCard = document.createElement('div'); quizCard.className = 'p-4 rounded-lg text-white text-center cursor-pointer btn h-full flex flex-col justify-center min-h-[120px]'; quizCard.style.background = `linear-gradient(45deg, hsl(${index*50}, 60%, 50%), hsl(${index*50 + 60}, 60%, 50%))`; quizCard.innerHTML = `<h3 class="text-xl font-bold">${quiz.title}</h3><p>${quiz.questions.length} câu hỏi</p>`;
                    quizCard.addEventListener('click', () => { selectedQuizIndex = index; showScreen('playerName'); });
                    const controls = document.createElement('div'); controls.className = 'absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity';
                    
                    const exportDocBtn = document.createElement('button');
                    exportDocBtn.className = 'bg-teal-500 text-white rounded-full w-6 h-6 flex items-center justify-center btn';
                    exportDocBtn.innerHTML = '<i class="fas fa-file-alt fa-xs"></i>';
                    exportDocBtn.title = 'Xuất câu hỏi + đáp án làm tài liệu';
                    exportDocBtn.addEventListener('click', (e) => { e.stopPropagation(); showExportOptions(index); });

                    const editBtn = document.createElement('button'); editBtn.className = 'bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center btn'; editBtn.innerHTML = '<i class="fas fa-pencil-alt fa-xs"></i>'; editBtn.title = 'Sửa quiz này'; editBtn.addEventListener('click', (e) => { e.stopPropagation(); startEditingQuiz(index); });
                    
                    const deleteBtn = document.createElement('button'); deleteBtn.className = 'bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center btn'; deleteBtn.innerHTML = '<i class="fas fa-trash-alt fa-xs"></i>'; deleteBtn.title = 'Xóa quiz này'; deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); if (confirm(`Bạn có chắc muốn xóa bộ câu hỏi "${quiz.title}" không?`)) { deleteQuiz(index); } });
                    
                    controls.appendChild(exportDocBtn);
                    controls.appendChild(editBtn);
                    controls.appendChild(deleteBtn);
                    quizCardContainer.appendChild(quizCard);
                    quizCardContainer.appendChild(controls);
                    quizListContainer.appendChild(quizCardContainer);
                });
            }

            function deleteQuiz(index) { allQuizzes.splice(index, 1); saveQuizzesToStorage(); renderQuizList(); }
            function exportQuizToJson(quizData) { const dataStr = JSON.stringify(quizData, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${quizData.title.replace(/\s+/g, '_')}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }

            // --- QUIZ GAME LOGIC ---
            function startGame() {
                playerName = playerNameInput.value || "Người chơi";
                gameMode = document.querySelector('input[name="game-mode"]:checked').value;
                isTimerEnabled = timerEnabledCheckbox.checked;
                isShuffleQuestionsEnabled = shuffleQuestionsCheckbox.checked;
                isShuffleAnswersEnabled = shuffleAnswersCheckbox.checked;
                
                let timeValue = parseInt(timeValueInput.value) || 15;
                timePerQuestion = timeUnitSelect.value === 'minutes' ? timeValue * 60 : timeValue;

                let questionsToPlay = [...allQuizzes[selectedQuizIndex].questions];
                if (isShuffleQuestionsEnabled) {
                    questionsToPlay.sort(() => Math.random() - 0.5);
                }
                currentQuizData = questionsToPlay;
                
                originalTotalQuestions = currentQuizData.length;
                totalQuestionsInRound = currentQuizData.length; 
                
                wronglyAnsweredQuestions = [];
                initialWrongAnswers = [];
                isInitialRound = true;
                questionAttemptCounts = {};
                correctAnswersCount = 0;
                firstRoundCorrectAnswers = 0;
                currentQuestionIndex = 0;
                practiceRoundNotification.classList.add('hidden');

                currentQuizData.forEach(q => {
                    questionAttemptCounts[q.question] = 1;
                });
                
                showScreen('quiz');
                setNextQuestion();
            }

            function setNextQuestion() {
                resetState();
                if (currentQuestionIndex < currentQuizData.length) {
                    showQuestion(currentQuizData[currentQuestionIndex]);
                } else {
                    if (isInitialRound) {
                        firstRoundCorrectAnswers = correctAnswersCount;
                    }
                    if (gameMode === 'practice' && wronglyAnsweredQuestions.length > 0) {
                        practiceRoundNotification.classList.remove('hidden');
                        isInitialRound = false;
                        currentQuizData = [...wronglyAnsweredQuestions];
                        
                        currentQuizData.forEach(q => {
                            questionAttemptCounts[q.question]++;
                        });

                        totalQuestionsInRound = currentQuizData.length;
                        wronglyAnsweredQuestions = [];
                        currentQuestionIndex = 0;
                        setNextQuestion();
                    } else {
                        endGame();
                    }
                }
            }
            
            function showQuestion(questionData) {
                questionProgress.textContent = `${currentQuestionIndex + 1}/${totalQuestionsInRound}`;
                
                const percent = originalTotalQuestions > 0 ? Math.round((correctAnswersCount / originalTotalQuestions) * 100) : 0;
                scorePercentDisplay.textContent = `${percent}%`;
                questionText.innerHTML = questionData.question; // Use innerHTML for rich text
                
                if (questionData.image) {
                    quizQuestionImage.src = questionData.image;
                    quizQuestionImage.classList.remove('hidden');
                } else {
                    quizQuestionImage.src = '';
                    quizQuestionImage.classList.add('hidden');
                }
                
                let answersToDisplay = [...questionData.answers];
                if (isShuffleAnswersEnabled) {
                    answersToDisplay.sort(() => Math.random() - 0.5);
                }

                answersToDisplay.forEach((answer, index) => {
                    const button = document.createElement('button');
                    button.className = `answer-btn w-full font-bold py-3 px-4 rounded-lg text-left flex flex-col items-center justify-center text-lg btn`;
                    button.dataset.originalIndex = questionData.answers.indexOf(answer);
                    
                    let content = '';
                    if (answer.image) {
                        content += `<img src="${answer.image}" class="max-h-24 rounded-md mb-2 object-contain pointer-events-none">`;
                    }
                    if (answer.text) {
                        content += `<span class="pointer-events-none">${answer.text}</span>`;
                    }
                    button.innerHTML = content;
                    
                    if (questionData.multiple) {
                        button.addEventListener('click', () => toggleMultipleChoiceAnswer(button));
                    } else {
                        button.addEventListener('click', () => selectSingleAnswer(button, answer.correct));
                    }
                    answerButtonsContainer.appendChild(button);
                });

                if (questionData.multiple) {
                    submitMultipleChoiceContainer.classList.remove('hidden');
                } else {
                    submitMultipleChoiceContainer.classList.add('hidden');
                }

                if (gameMode === 'test' && isTimerEnabled) {
                    timerContainer.classList.remove('hidden');
                    startTimer();
                } else {
                    timerContainer.classList.add('hidden');
                }
            }

            function resetState() {
                clearInterval(timerInterval);
                answerButtonsContainer.innerHTML = '';
                quizQuestionImage.classList.add('hidden');
                quizQuestionImage.src = '';
                submitMultipleChoiceContainer.classList.add('hidden');
            }

            function toggleMultipleChoiceAnswer(selectedBtn) {
                selectedBtn.classList.toggle('selected');
            }

            function selectSingleAnswer(selectedBtn, isCorrect) {
                checkAnswers([{ btn: selectedBtn, correct: isCorrect }]);
            }

            function submitMultipleAnswers() {
                const selectedButtons = answerButtonsContainer.querySelectorAll('.answer-btn.selected');
                const answers = Array.from(selectedButtons).map(btn => {
                    const originalIndex = parseInt(btn.dataset.originalIndex);
                    const originalAnswer = currentQuizData[currentQuestionIndex].answers[originalIndex];
                    return { btn, correct: originalAnswer.correct };
                });
                checkAnswers(answers, true);
            }

            function checkAnswers(selectedAnswers, isMultiple = false) {
                clearInterval(timerInterval);
                let allCorrect = true;
                const questionData = currentQuizData[currentQuestionIndex];
                const correctAnswers = questionData.answers.filter(a => a.correct);

                if (isMultiple) {
                    if (selectedAnswers.length !== correctAnswers.length) {
                        allCorrect = false;
                    } else {
                        allCorrect = selectedAnswers.every(ans => ans.correct);
                    }
                } else {
                    allCorrect = selectedAnswers.length === 1 && selectedAnswers[0].correct;
                }

                if (allCorrect) {
                    correctAnswersCount++;
                } else {
                    if (isInitialRound) {
                        initialWrongAnswers.push(questionData);
                    }
                    if (gameMode === 'practice') {
                        wronglyAnsweredQuestions.push(questionData);
                    }
                }
                
                Array.from(answerButtonsContainer.children).forEach(button => {
                    const originalIndex = parseInt(button.dataset.originalIndex);
                    const originalAnswer = questionData.answers[originalIndex];
                    if (originalAnswer.correct) {
                        button.classList.add('correct');
                    }
                    button.disabled = true;
                });

                selectedAnswers.forEach(({ btn, correct }) => {
                    if (!correct) {
                        btn.classList.add('wrong');
                    }
                });

                setTimeout(() => {
                    currentQuestionIndex++;
                    setNextQuestion();
                }, 1500);
            }

            function startTimer() {
                let timeLeft = timePerQuestion;
                timerBar.style.width = '100%'; timerBar.style.backgroundPosition = '0%';
                timerInterval = setInterval(() => {
                    timeLeft--;
                    const widthPercentage = (timeLeft / timePerQuestion) * 100;
                    timerBar.style.width = `${widthPercentage}%`; timerBar.style.backgroundPosition = `${100 - widthPercentage}%`;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        if (currentQuizData[currentQuestionIndex].multiple) {
                            submitMultipleAnswers();
                        } else {
                            checkAnswers([]);
                        }
                    }
                }, 1000);
            }

            function endGame() {
                showScreen('end');
                playerNameFinal.textContent = playerName;
                const finalPercent = originalTotalQuestions > 0 ? Math.round((firstRoundCorrectAnswers / originalTotalQuestions) * 100) : 0;
                const wrongCount = originalTotalQuestions - firstRoundCorrectAnswers;
                
                if (gameMode === 'practice' && initialWrongAnswers.length === 0) {
                    endTitle.textContent = "Luyện tập hoàn tất!";
                    endMessage.innerHTML = `Chúc mừng bạn đã trả lời đúng 100% tất cả các câu hỏi!`;
                    endCountsContainer.classList.add('hidden');
                } else {
                    endTitle.textContent = "Hoàn thành!";
                    endMessage.innerHTML = `Tỷ lệ đúng từ lần đầu: <span id="final-score-percent" class="font-bold text-green-500">${finalPercent}%</span>`;
                    endCountsContainer.classList.remove('hidden');
                    correctCountDisplay.textContent = firstRoundCorrectAnswers;
                    wrongCountDisplay.textContent = wrongCount;
                }

                wrongAnswersList.innerHTML = '';
                if (initialWrongAnswers.length > 0) {
                    wrongAnswersContainer.classList.remove('hidden');
                    exportWrongBtn.classList.remove('hidden');
                    initialWrongAnswers.forEach(q => {
                        const correctAnswers = q.answers.filter(a => a.correct);
                        const attempts = questionAttemptCounts[q.question] || 1;
                        const item = document.createElement('div');
                        item.className = 'text-left p-3 bg-red-100 dark:bg-red-900/50 rounded-lg shadow-sm';
                        let answersHtml = correctAnswers.map(ans => `
                            <div class="flex items-center gap-2">
                                ${ans.image ? `<img src="${ans.image}" class="max-h-16 rounded-md my-1">` : ''}
                                ${ans.text ? `<span>${ans.text}</span>` : ''}
                            </div>
                        `).join('');

                        item.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="font-bold text-gray-800 dark:text-gray-200 flex-1 pr-2">${q.question}</div>
                                ${attempts > 1 ? `<span class="text-xs font-semibold text-white bg-red-500 rounded-full px-2 py-1 flex-shrink-0" title="Số lần làm lại">${attempts} lần</span>` : ''}
                            </div>
                            <div class="text-sm text-green-700 dark:text-green-400 font-semibold mt-1">
                                <b>Đáp án đúng:</b> ${answersHtml}
                            </div>
                        `;
                        wrongAnswersList.appendChild(item);
                    });
                } else {
                    wrongAnswersContainer.classList.add('hidden');
                    exportWrongBtn.classList.add('hidden');
                }
            }

            function exportWrongAnswersQuiz() {
                if (initialWrongAnswers.length === 0) return;
                const originalQuizTitle = allQuizzes[selectedQuizIndex].title;
                const wrongAnswersQuiz = {
                    title: `${originalQuizTitle} - Những câu sai`,
                    questions: initialWrongAnswers
                };
                exportQuizToJson(wrongAnswersQuiz);
            }

            // --- EXPORT DOCUMENT LOGIC ---
            function showExportOptions(index) {
                quizToExportIndex = index;
                exportQuizTitle.textContent = allQuizzes[index].title;
                exportModal.classList.remove('hidden');
            }

            function exportAsDocument(quizIndex, format) {
                const quiz = allQuizzes[quizIndex];
                const questions = JSON.parse(JSON.stringify(quiz.questions));
                
                questions.sort((a, b) => {
                    const textA = new DOMParser().parseFromString(a.question, "text/html").body.textContent || "";
                    const textB = new DOMParser().parseFromString(b.question, "text/html").body.textContent || "";
                    return textA.localeCompare(textB, 'vi');
                });

                let contentHtml = `<div style="font-family: Arial, sans-serif; line-height: 1.6;"><h1>${quiz.title}</h1>`;
                questions.forEach(q => {
                    const correctAnswers = q.answers.filter(a => a.correct);
                    let answersText = correctAnswers.map(ans => (ans.text || '') + (ans.image ? ` <img src="${ans.image}" style="max-width: 150px; vertical-align: middle; border-radius: 4px;">` : '')).join(', ');
                    
                    contentHtml += `<div style="margin-bottom: 20px; page-break-inside: avoid;">`;
                    contentHtml += `<div><b>${q.question}</b></div>`;
                    if (q.image) {
                        contentHtml += `<img src="${q.image}" style="max-width: 300px; margin-top: 10px; margin-bottom: 10px; border-radius: 8px;">`;
                    }
                    contentHtml += `<div style="color: #28a745;"><b>&rArr;</b> ${answersText}</div>`;
                    contentHtml += `</div><hr style="border: none; border-top: 1px solid #eee;">`;
                });
                contentHtml += `</div>`;

                if (format === 'pdf') {
                    const element = document.createElement('div');
                    element.innerHTML = contentHtml;
                    const opt = {
                        margin:       [0.5, 0.5, 0.5, 0.5],
                        filename:     `${quiz.title}.pdf`,
                        image:        { type: 'jpeg', quality: 0.98 },
                        html2canvas:  { scale: 2, useCORS: true },
                        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
                    };
                    html2pdf().from(element).set(opt).save();
                } else if (format === 'docx') {
                    const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                        "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                        "xmlns='http://www.w3.org/TR/REC-html40'>"+
                        "<head><meta charset='utf-8'><title>Export HTML to Word</title></head><body>";
                    const footer = "</body></html>";
                    const sourceHTML = header + contentHtml + footer;

                    const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
                    const fileDownload = document.createElement("a");
                    document.body.appendChild(fileDownload);
                    fileDownload.href = source;
                    fileDownload.download = `${quiz.title}.docx`;
                    fileDownload.click();
                    document.body.removeChild(fileDownload);
                }
            }

            // --- QUIZ CREATOR LOGIC ---
            function setupAnswerEditors() {
                answerEditorContainer.innerHTML = '';
                for (let i=0; i<4; i++) {
                    addAnswerEditor();
                }
            }

            function addAnswerEditor(answer = { text: '', image: null, correct: false }) {
                const index = answerEditorContainer.querySelectorAll('.answer-editor-item').length;
                const editorDiv = document.createElement('div');
                editorDiv.className = 'p-3 border rounded-lg space-y-2 answer-editor-item bg-white flex flex-col';
                const answerType = document.querySelector('input[name="answer-type"]:checked').value === 'single' ? 'radio' : 'checkbox';
                
                editorDiv.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <textarea name="answer-text" placeholder="Lựa chọn ${index + 1}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-300 bg-white text-black focus:outline-none focus:ring-2 focus:ring-green-500" rows="3">${answer.text}</textarea>
                        <div class="flex flex-col gap-2 items-center">
                            <label class="custom-control ${answerType === 'radio' ? 'custom-radio' : 'custom-checkbox'} flex items-center p-1 cursor-pointer">
                                <input type="${answerType}" name="correct-answer" value="${index}" ${answer.correct ? 'checked' : ''}>
                                <span></span>
                            </label>
                            <button type="button" class="btn text-red-500 remove-answer-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mt-auto pt-2">
                        <button type="button" class="btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded" data-answer-index="${index}"><i class="fas fa-image"></i></button>
                        <input type="file" class="hidden" name="answer-image-input" accept="image/*" data-answer-index="${index}">
                        <img src="${answer.image || ''}" class="${answer.image ? '' : 'hidden'} h-10 rounded" name="answer-image-preview">
                        <button type="button" class="${answer.image ? '' : 'hidden'} btn text-xs bg-red-100 text-red-700 px-2 py-1 rounded" name="remove-answer-image-btn">Xóa</button>
                    </div>
                `;
                answerEditorContainer.appendChild(editorDiv);

                // Re-attach listeners for the new element
                const newEditor = answerEditorContainer.lastElementChild;
                newEditor.querySelector('.remove-answer-btn').addEventListener('click', () => newEditor.remove());
                newEditor.querySelector('button[data-answer-index]').addEventListener('click', (e) => {
                    newEditor.querySelector('input[name="answer-image-input"]').click();
                });
                newEditor.querySelector('input[name="answer-image-input"]').addEventListener('change', (e) => handleAnswerImageUpload(e, newEditor));
                newEditor.querySelector('button[name="remove-answer-image-btn"]').addEventListener('click', () => removeAnswerImage(newEditor));
            }

            function handleAnswerImageUpload(event, editorDiv) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = editorDiv.querySelector(`img[name="answer-image-preview"]`);
                    const removeBtn = editorDiv.querySelector(`button[name="remove-answer-image-btn"]`);
                    preview.src = e.target.result;
                    preview.dataset.base64 = e.target.result;
                    preview.classList.remove('hidden');
                    removeBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            function removeAnswerImage(editorDiv) {
                const input = editorDiv.querySelector(`input[name="answer-image-input"]`);
                const preview = editorDiv.querySelector(`img[name="answer-image-preview"]`);
                const removeBtn = editorDiv.querySelector(`button[name="remove-answer-image-btn"]`);
                input.value = '';
                preview.src = '';
                preview.dataset.base64 = '';
                preview.classList.add('hidden');
                removeBtn.classList.add('hidden');
            }

            function resetCreatorForm() { 
                editingQuizIndex = null;
                creatorTitle.textContent = 'Tạo Quiz Mới';
                saveQuizBtn.textContent = 'Lưu và Tải về';
                quizTitleInput.value = '';
                newQuizQuestions = [];
                updateQuestionPreview();
                resetQuestionForm();
            }
            
            function resetQuestionForm() {
                editingQuestionIndex = null;
                questionEditorTitle.textContent = 'Thêm câu hỏi mới';
                addQuestionBtn.textContent = 'Thêm câu hỏi này';
                addQuestionBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                addQuestionBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                newQuestionDiv.innerHTML = '';
                
                newQuestionImageInput.value = '';
                questionImagePreview.classList.add('hidden');
                questionImagePreview.src = '';
                removeImageBtn.classList.add('hidden');
                currentQuestionImageBase64 = null;
                
                answerEditorContainer.innerHTML = '';
                for(let i=0; i<4; i++) addAnswerEditor();
                document.querySelector('input[name="answer-type"][value="single"]').checked = true;
            }
            
            function updateQuestionPreview() {
                questionsPreview.innerHTML = '';
                questionCount.textContent = newQuizQuestions.length;
                newQuizQuestions.forEach((q, index) => {
                    const item = document.createElement('div');
                    item.className = 'question-preview-item flex items-center justify-between p-2 bg-gray-200 rounded text-sm cursor-move';
                    item.draggable = true;
                    item.dataset.index = index;
                    let questionTextContent = new DOMParser().parseFromString(q.question, "text/html").body.textContent || "";
                    let previewText = `<span class="flex-1 mr-2 truncate"><i class="fas fa-grip-vertical mr-2 text-gray-400"></i>${index + 1}. `;
                    if (q.image) {
                        previewText += `<i class="fas fa-image text-blue-400 mr-1"></i>`;
                    }
                    previewText += `${questionTextContent}</span>`;
                    item.innerHTML = `${previewText}<div class="flex gap-2 flex-shrink-0"><button data-edit-question="${index}" class="text-blue-500 hover:text-blue-700"><i class="fas fa-pencil-alt fa-xs"></i></button><button data-delete-question="${index}" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt fa-xs"></i></button></div>`;
                    questionsPreview.appendChild(item);
                });
            }
            
            questionsPreview.addEventListener('click', (e) => {
                const editBtn = e.target.closest('[data-edit-question]'); const deleteBtn = e.target.closest('[data-delete-question]');
                if (editBtn) { loadQuestionForEdit(parseInt(editBtn.dataset.editQuestion)); }
                if (deleteBtn) { if (confirm('Bạn có chắc muốn xóa câu hỏi này?')) { deleteQuestion(parseInt(deleteBtn.dataset.deleteQuestion)); } }
            });

            function loadQuestionForEdit(index) {
                resetQuestionForm();
                editingQuestionIndex = index;
                const questionData = newQuizQuestions[index];
                questionEditorTitle.textContent = `Sửa câu hỏi ${index + 1}`;
                addQuestionBtn.textContent = 'Cập nhật câu hỏi';
                addQuestionBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                addQuestionBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                newQuestionDiv.innerHTML = questionData.question;
                
                if (questionData.image) {
                    questionImagePreview.src = questionData.image;
                    questionImagePreview.classList.remove('hidden');
                    removeImageBtn.classList.remove('hidden');
                    currentQuestionImageBase64 = questionData.image;
                }

                document.querySelector(`input[name="answer-type"][value="${questionData.multiple ? 'multiple' : 'single'}"]`).checked = true;
                answerEditorContainer.innerHTML = '';
                questionData.answers.forEach(ans => addAnswerEditor(ans));
            }
            
            function deleteQuestion(index) { newQuizQuestions.splice(index, 1); updateQuestionPreview(); if(editingQuestionIndex === index) { resetQuestionForm(); } }
            
            function startEditingQuiz(index) {
                resetCreatorForm();
                editingQuizIndex = index;
                const quizToEdit = allQuizzes[index];
                creatorTitle.textContent = `Chỉnh sửa Quiz: ${quizToEdit.title}`;
                saveQuizBtn.textContent = 'Lưu thay đổi và Tải về';
                quizTitleInput.value = quizToEdit.title;
                newQuizQuestions = JSON.parse(JSON.stringify(quizToEdit.questions));
                updateQuestionPreview();
                showScreen('creator');
            }

            addQuestionBtn.addEventListener('click', () => {
                const question = newQuestionDiv.innerHTML.trim();
                const isMultiple = document.querySelector('input[name="answer-type"]:checked').value === 'multiple';
                const answerItems = answerEditorContainer.querySelectorAll('.answer-editor-item');
                
                const answers = Array.from(answerItems).map(item => {
                    const text = item.querySelector('textarea[name="answer-text"]').value.trim();
                    const image = item.querySelector('img[name="answer-image-preview"]').dataset.base64 || null;
                    const correct = item.querySelector('input[name="correct-answer"]').checked;
                    return { text, image, correct };
                });

                if (!question || question === '<br>') {
                    alert('Vui lòng nhập nội dung câu hỏi.');
                    return;
                }
                if (answers.length < 2) {
                    alert('Vui lòng nhập ít nhất 2 lựa chọn trả lời.');
                    return;
                }
                if (answers.some(a => !a.text && !a.image)) {
                    alert('Mỗi lựa chọn phải có ít nhất văn bản hoặc hình ảnh.');
                    return;
                }
                if (!answers.some(a => a.correct)) {
                    alert('Vui lòng chọn ít nhất một đáp án đúng.');
                    return;
                }
                
                const questionData = {
                    question: question,
                    image: currentQuestionImageBase64,
                    multiple: isMultiple,
                    answers: answers
                };
                
                if (editingQuestionIndex !== null) {
                    newQuizQuestions[editingQuestionIndex] = questionData;
                } else {
                    newQuizQuestions.push(questionData);
                }
                updateQuestionPreview();
                resetQuestionForm();
                newQuestionDiv.focus();
            });

            saveQuizBtn.addEventListener('click', () => {
                const title = quizTitleInput.value.trim();
                if (!title) { alert('Vui lòng nhập tên cho bộ câu hỏi.'); return; }
                if (newQuizQuestions.length === 0) { alert('Vui lòng thêm ít nhất một câu hỏi.'); return; }
                const newQuiz = { title: title, questions: newQuizQuestions };
                if (editingQuizIndex !== null) {
                    allQuizzes[editingQuizIndex] = newQuiz;
                    alert('Đã cập nhật quiz thành công!');
                } else {
                    allQuizzes.push(newQuiz);
                }
                exportQuizToJson(newQuiz);
                saveQuizzesToStorage();
                renderQuizList();
                showScreen('home');
            });
            
            importQuizBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedQuiz = JSON.parse(e.target.result);
                        if (importedQuiz.title && Array.isArray(importedQuiz.questions)) {
                            allQuizzes.push(importedQuiz);
                            saveQuizzesToStorage();
                            renderQuizList();
                            alert(`Đã nhập thành công quiz: "${importedQuiz.title}"`);
                        } else {
                            alert('File JSON không hợp lệ.');
                        }
                    } catch (error) {
                        alert('Lỗi khi đọc file. Vui lòng kiểm tra lại file JSON.');
                    }
                };
                reader.readAsText(file);
                importFileInput.value = '';
            });
            
            newQuestionImageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentQuestionImageBase64 = e.target.result;
                    questionImagePreview.src = e.target.result;
                    questionImagePreview.classList.remove('hidden');
                    removeImageBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            });
            
            removeImageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                newQuestionImageInput.value = '';
                questionImagePreview.classList.add('hidden');
                questionImagePreview.src = '';
                removeImageBtn.classList.add('hidden');
                currentQuestionImageBase64 = null;
            });

            // --- DRAG AND DROP LOGIC ---
            questionsPreview.addEventListener('dragstart', e => {
                if (e.target.classList.contains('question-preview-item')) {
                    draggedItemIndex = parseInt(e.target.dataset.index);
                    e.target.classList.add('dragging');
                }
            });

            questionsPreview.addEventListener('dragend', e => {
                if (e.target.classList.contains('question-preview-item')) {
                    e.target.classList.remove('dragging');
                    draggedItemIndex = null;
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                }
            });

            questionsPreview.addEventListener('dragover', e => {
                e.preventDefault();
                const target = e.target.closest('.question-preview-item');
                if (target && parseInt(target.dataset.index) !== draggedItemIndex) {
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    target.classList.add('drag-over');
                }
            });
            
            questionsPreview.addEventListener('dragleave', e => {
                 const target = e.target.closest('.question-preview-item');
                 if(target) {
                    target.classList.remove('drag-over');
                 }
            });

            questionsPreview.addEventListener('drop', e => {
                e.preventDefault();
                const target = e.target.closest('.question-preview-item');
                if (target) {
                    target.classList.remove('drag-over');
                    const droppedOnIndex = parseInt(target.dataset.index);
                    if (draggedItemIndex !== null && draggedItemIndex !== droppedOnIndex) {
                        const itemToMove = newQuizQuestions.splice(draggedItemIndex, 1)[0];
                        newQuizQuestions.splice(droppedOnIndex, 0, itemToMove);
                        updateQuestionPreview();
                    }
                }
            });
            
            // --- IMPORT QUESTIONS LOGIC ---
            importQuestionsBtn.addEventListener('click', () => importQuestionsInput.click());
            importQuestionsInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data.questions)) {
                            newQuizQuestions.push(...data.questions);
                            updateQuestionPreview();
                            alert(`Đã bổ sung thành công ${data.questions.length} câu hỏi.`);
                        } else {
                            alert('File JSON không hợp lệ. Cần có một mảng "questions".');
                        }
                    } catch (error) {
                        alert('Lỗi khi đọc file. Vui lòng kiểm tra lại file JSON.');
                    }
                };
                reader.readAsText(file);
                importQuestionsInput.value = '';
            });


            // --- EVENT LISTENERS ---
            startBtn.addEventListener('click', startGame);
            backToHomeBtn.addEventListener('click', () => showScreen('home'));
            backFromPlayerNameBtn.addEventListener('click', () => showScreen('home'));
            exportWrongBtn.addEventListener('click', exportWrongAnswersQuiz);
            goToCreatorBtn.addEventListener('click', () => {
                resetCreatorForm();
                showScreen('creator');
            });
            cancelCreationBtn.addEventListener('click', () => { showScreen('home'); });
            
            gameModeRadios.forEach(radio => radio.addEventListener('change', () => {
                timerSettingsDiv.style.display = radio.value === 'test' ? 'block' : 'none';
            }));
            timerEnabledCheckbox.addEventListener('change', () => {
                timerOptionsDiv.style.display = timerEnabledCheckbox.checked ? 'flex' : 'none';
            });
            
            cancelExportBtn.addEventListener('click', () => exportModal.classList.add('hidden'));
            exportPdfBtn.addEventListener('click', () => {
                exportAsDocument(quizToExportIndex, 'pdf');
                exportModal.classList.add('hidden');
            });
            exportDocBtn.addEventListener('click', () => {
                exportAsDocument(quizToExportIndex, 'docx');
                exportModal.classList.add('hidden');
            });
            
            addAnswerBtn.addEventListener('click', () => addAnswerEditor());
            document.querySelectorAll('input[name="answer-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const newType = e.target.value === 'single' ? 'radio' : 'checkbox';
                    answerEditorContainer.querySelectorAll('input[name="correct-answer"]').forEach(input => {
                        input.type = newType;
                        if (newType === 'radio') {
                            const firstChecked = answerEditorContainer.querySelector('input[name="correct-answer"]:checked');
                            if (firstChecked) {
                                answerEditorContainer.querySelectorAll('input[name="correct-answer"]').forEach(r => r.checked = false);
                                firstChecked.checked = true;
                            }
                        }
                    });
                });
            });

            richTextToolbar.addEventListener('click', (e) => {
                const command = e.target.dataset.command;
                if (command) {
                    e.preventDefault();
                    document.execCommand(command, false, null);
                    newQuestionDiv.focus();
                    richTextToolbar.querySelectorAll('button').forEach(btn => {
                        btn.classList.toggle('active', document.queryCommandState(btn.dataset.command));
                    });
                }
            });
            
            newQuestionDiv.addEventListener('keyup', () => {
                richTextToolbar.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', document.queryCommandState(btn.dataset.command));
                });
            });

            submitMultipleChoiceBtn.addEventListener('click', submitMultipleAnswers);

            // --- INITIALIZATION ---
            loadComponents();
            loadQuizzesFromStorage();
            setupAnswerEditors();
            showScreen('home');
        });
    </script>
</body>
</html>
