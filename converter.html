<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Chuyển Đổi Tệp Tin</title>
    
    <!-- Sử dụng Tailwind CSS để tạo giao diện nhanh và đẹp -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font chữ Inter từ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drop-zone {
            transition: background-color 0.2s ease-in-out;
        }
        .drop-zone.drag-over {
            background-color: #e0f2fe; /* light-blue-100 */
            border-color: #0284c7; /* light-blue-600 */
        }
        .file-input {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex flex-col min-h-screen">

    <!-- Placeholder cho Header -->
    <div id="mini-header-placeholder"></div>

    <main class="flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-8 md:p-12">
                <header class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white">Trình Chuyển Đổi Tệp Tin</h1>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Nhanh chóng, bảo mật và miễn phí.</p>
                </header>

                <div>
                    <!-- Bước 1: Chọn loại chuyển đổi -->
                    <div class="mb-6">
                        <label for="conversionType" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Chọn loại chuyển đổi:</label>
                        <select id="conversionType" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                            <optgroup label="Chuyển sang PDF">
                                <option value="officetopdf">Word/PowerPoint/Excel sang PDF</option>
                                <option value="jpgtopdf">JPG sang PDF</option>
                                <option value="pngtopdf">PNG sang PDF</option>
                            </optgroup>
                            <optgroup label="Chuyển từ PDF">
                                <option value="pdftoword">PDF sang Word</option>
                                <option value="pdftojpg">PDF sang JPG</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Bước 2: Tải file lên -->
                    <div id="dropZone" class="drop-zone border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                        <input type="file" id="fileInput" class="file-input">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 16v4a2 2 0 01-2 2H6a2 2 0 01-2-2v-4m16-4l-4-4m0 0l-4 4m4-4v12"></path></svg>
                            <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Nhấp để tải lên</span> hoặc kéo thả</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Hỗ trợ: JPG, PNG, DOCX, PDF...</p>
                        </div>
                    </div>

                    <!-- Hiển thị thông tin file đã chọn -->
                    <div id="fileInfo" class="hidden mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200" id="fileName"></p>
                                <p class="text-xs text-gray-500 dark:text-gray-400" id="fileSize"></p>
                            </div>
                            <button id="removeFileBtn" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    </div>

                    <!-- Bước 3: Nút chuyển đổi -->
                    <div class="mt-8 text-center">
                        <button id="convertBtn" disabled class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-all duration-300">
                            Chuyển Đổi
                        </button>
                    </div>
                    
                    <!-- Vùng hiển thị trạng thái/kết quả -->
                    <div id="status" class="hidden mt-6 text-center p-4 rounded-md"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Placeholder cho Footer -->
    <div id="footer-placeholder"></div>

    <script>
        // Lấy các phần tử DOM
        const conversionTypeSelect = document.getElementById('conversionType');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileNameEl = document.getElementById('fileName');
        const fileSizeEl = document.getElementById('fileSize');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const convertBtn = document.getElementById('convertBtn');
        const statusEl = document.getElementById('status');
        
        let selectedFile = null;

        // Xử lý sự kiện kéo-thả
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // Xử lý khi click vào vùng chọn file
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Xử lý khi nhấn nút xóa file
        removeFileBtn.addEventListener('click', () => {
            resetFile();
        });

        function handleFile(file) {
            selectedFile = file;
            fileNameEl.textContent = file.name;
            fileSizeEl.textContent = `Kích thước: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            fileInfo.classList.remove('hidden');
            convertBtn.disabled = false;
        }

        function resetFile() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            convertBtn.disabled = true;
            hideStatus();
        }
        
        function showStatus(message, type = 'info') {
            statusEl.innerHTML = message; // Use innerHTML to allow for links
            statusEl.className = 'hidden mt-6 text-center p-4 rounded-md'; // Reset classes
            
            switch(type) {
                case 'success':
                    statusEl.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900', 'dark:text-green-200');
                    break;
                case 'error':
                    statusEl.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                    break;
                default:
                    statusEl.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
            }
            statusEl.classList.remove('hidden');
        }
        
        function hideStatus() {
            statusEl.classList.add('hidden');
        }

        convertBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const conversionType = conversionTypeSelect.value;
            showStatus('⚙️ Đang tải tệp lên và xử lý, vui lòng chờ...', 'info');
            convertBtn.disabled = true;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('conversionType', conversionType);

            try {
                // Gửi yêu cầu đến Serverless Function của bạn tại /api/convert
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || 'Có lỗi xảy ra từ phía máy chủ.');
                }

                const blob = await response.blob();
                const outputFileNameHeader = response.headers.get('Content-Disposition');
                let outputFileName = 'converted-file'; // Tên mặc định

                if (outputFileNameHeader) {
                    const parts = outputFileNameHeader.split('filename=');
                    if (parts.length > 1) {
                        outputFileName = parts[1].replace(/"/g, '');
                    }
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = outputFileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                showStatus(`✅ Chuyển đổi thành công! Tệp <strong>${outputFileName}</strong> đã được tải xuống.`, 'success');

            } catch (error) {
                console.error('Lỗi khi chuyển đổi:', error);
                showStatus(`❌ Lỗi: ${error.message}`, 'error');
            } finally {
                convertBtn.disabled = false;
                resetFile();
            }
        });

    </script>
    
    <!-- Script để tải Header và Footer -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Tải mini-header.html
            fetch('mini-header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('mini-header-placeholder').innerHTML = data;
                })
                .catch(error => console.error('Error loading header:', error));

            // Tải footer.html
            fetch('footer.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('footer-placeholder').innerHTML = data;
                })
                .catch(error => console.error('Error loading footer:', error));
        });
    </script>
</body>
</html>
